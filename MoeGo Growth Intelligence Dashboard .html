<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoeGo Growth Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/d3@7"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background: #0f172a; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .metric-card { transition: all 0.3s ease; }
        .metric-card:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0,0,0,0.3); }
        .trend-up { color: #22c55e; }
        .trend-down { color: #ef4444; }
        .trend-neutral { color: #94a3b8; }
        .nav-tab { transition: all 0.2s ease; }
        .nav-tab.active { background: linear-gradient(135deg, #3b82f6, #8b5cf6); }
        .nav-tab:not(.active):hover { background: rgba(59, 130, 246, 0.2); }
        .insight-card { border-left: 3px solid #3b82f6; }
        .warning-card { border-left: 3px solid #f59e0b; }
        .success-card { border-left: 3px solid #22c55e; }
        .danger-card { border-left: 3px solid #ef4444; }
        .progress-ring { transform: rotate(-90deg); }
        .sankey-link { fill: none; stroke-opacity: 0.4; }
        .sankey-link:hover { stroke-opacity: 0.7; }
        .cohort-cell { transition: all 0.2s ease; }
        .cohort-cell:hover { transform: scale(1.05); }
        .upload-zone { border: 2px dashed rgba(59, 130, 246, 0.5); transition: all 0.3s ease; }
        .upload-zone:hover, .upload-zone.dragover { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .data-status { display: inline-flex; align-items: center; gap: 6px; }
        .data-status::before { content: ''; width: 8px; height: 8px; border-radius: 50%; }
        .data-status.loaded::before { background: #22c55e; }
        .data-status.missing::before { background: #ef4444; }
        .data-status.partial::before { background: #f59e0b; }

        /* Growth Copilot Styles */
        .copilot-panel {
            position: fixed;
            top: 0;
            right: -480px;
            width: 480px;
            height: 100vh;
            background: linear-gradient(180deg, rgba(30, 41, 59, 0.98) 0%, rgba(15, 23, 42, 0.99) 100%);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(139, 92, 246, 0.3);
            z-index: 100;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: -8px 0 32px rgba(0, 0, 0, 0.4);
        }
        .copilot-panel.open { right: 0; }
        .copilot-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .copilot-overlay.open { opacity: 1; visibility: visible; }
        .copilot-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        .copilot-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
        }
        .copilot-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 3s infinite;
        }
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        .explain-btn {
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .glass:hover .explain-btn { opacity: 1; }
        .quick-action {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            transition: all 0.2s ease;
        }
        .quick-action:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.4);
            transform: translateX(4px);
        }
        .copilot-response {
            background: rgba(139, 92, 246, 0.08);
            border-left: 3px solid #8b5cf6;
        }
        .copilot-typing {
            display: inline-flex;
            gap: 4px;
        }
        .copilot-typing span {
            width: 6px;
            height: 6px;
            background: #8b5cf6;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        .copilot-typing span:nth-child(2) { animation-delay: 0.2s; }
        .copilot-typing span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-8px); opacity: 1; }
        }
    </style>
</head>
<body class="min-h-screen text-white">
    <!-- Header -->
    <header class="glass sticky top-0 z-50 px-6 py-4">
        <div class="flex items-center justify-between max-w-[1800px] mx-auto">
            <div class="flex items-center gap-4">
                <svg width="120" height="32" viewBox="0 0 985 265" xmlns="http://www.w3.org/2000/svg"><g fill="none"><path d="M187.42 130.838c-.16-9.207-7.8-16.591-17.02-16.431-9.24.176-16.6 7.8-16.44 17.038.17 9.223 7.77 16.591 17.03 16.431 9.22-.16 16.59-7.799 16.43-17.038" fill="#fff"/><path d="M183.17 174.025l-72.49 60.929-35.98-37.018c-4.84-4.955-12.767-5.067-17.739-.255-4.971 4.858-5.082 12.786-.255 17.757l44.114 45.377c2.51 2.59 5.88 3.852 9.22 3.804 2.78-.064 5.58-1.023 7.87-2.957l81.4-68.457c5.31-4.443 5.99-12.371 1.53-17.677-4.46-5.275-12.38-5.978-17.67-1.503" fill="#F96B18"/><path d="M222.01 7.621c-2.02-4.251-6.24-7-10.94-7.16-4.66-.16-9.07 2.35-11.34 6.457l-37.17 66.907-131.108 30.017-9.303 2.062c-13.17 3.532-22.201 15.472-21.961 29.058.224 13.186 7.512 21.066 14.29 28.946 5.658 6.601 20.234 17.086 26.356 13.873 8.344-4.411 26.996-20.938 25.976-56.101l106.8-24.647c3.47-.799 6.42-3.021 8.15-6.138l27.33-49.165c14.88 38.52 41.43 119.972 40.02 207.306-.09 6.92 5.44 12.626 12.79 12.722 6.73-.096 12.2-5.546 12.31-12.339 2.03-126.397-50-237.13-52.2-241.798M500.186 82.914c5.159 0 7.016 1.849 7.016 6.976v131.265c0 5.11-1.856 6.96-7.016 6.96h-10.523c-5.19 0-7.036-1.85-7.036-6.96v-62.364c0-12.281 1.651-25.779 4.954-40.705h-1.446c-3.939 11.876-9.703 24.335-16.934 37.428l-20.247 35.384c-2.062 3.276-4.769 4.9-8.062 4.9h-6.616c-4.339 0-5.795-.812-8.082-4.9l-20.636-35.595c-6.41-10.626-11.559-23.103-15.918-37.217h-1.456c2.903 13.92 4.359 27.613 4.359 40.899v62.169c0 5.11-1.867 6.96-7.046 6.96h-9.908c-5.159 0-7.231-1.85-7.231-6.96v-131.265c0-5.127 2.072-6.976 7.231-6.976h9.087c5.785 0 7.651 1.038 9.918 5.321l42.996 76.073 42.975-75.862c2.472-4.705 3.908-5.532 9.508-5.532h10.113" fill="#fff"/><path d="M596.117 160.008c0-12.459-8.667-19.419-23.754-19.419-15.098 0-23.57 6.96-23.57 19.419v30.273c0 12.266 8.472 19.437 23.57 19.437 15.087 0 23.754-7.171 23.754-19.437v-30.273zm-71.294 0c0-25.552 17.17-40.883 47.539-40.883 30.575 0 47.745 15.331 47.745 40.883v30.273c0 25.568-17.17 40.9-47.745 40.9-30.37 0-47.539-15.332-47.539-40.9v-30.273z" fill="#fff"/><path d="M865.367 150.189c5.569 0 7.026 1.849 7.026 6.96v27.402c0 14.309-5.18 25.973-15.508 34.767-10.534 9.004-24.995 13.499-43.396 13.499-37.796 0-59.099-20.037-59.099-53.392v-44.777c0-32.902 21.303-53.149 59.099-53.149 29.344 0 48.155 11.455 56.196 34.15 1.662 4.3.215 7.35-4.318 8.988l-11.385 3.877c-4.933 1.849-7.016.827-8.882-4.283-4.544-12.492-15.077-18.82-31.611-18.82-21.488 0-33.057 10.238-33.057 29.041v45.199c0 19.014 11.785 29.235 33.057 29.235 20.657 0 33.478-10.026 33.478-24.14v-10.627h-31.19c-5.169 0-7.036-2.043-7.036-7.154v-9.815c0-5.111 1.867-6.96 7.036-6.96h49.591" fill="#F96B18"/><path d="M960.854 158.59c0-12.459-8.687-19.419-23.775-19.419-15.077 0-23.559 6.96-23.559 19.419v30.273c0 12.266 8.482 19.437 23.559 19.437 15.087 0 23.775-7.171 23.775-19.437v-30.273zm-71.294 0c0-25.552 17.139-40.883 47.519-40.883 30.575 0 47.745 15.331 47.745 40.883v30.273c0 25.568-17.17 40.9-47.745 40.9-30.38 0-47.519-15.332-47.519-40.9v-30.273z" fill="#F96B18"/><g fill="#fff"><path d="M650.824 69.561c-1.459.114-2.806.538-3.997 1.212-.505.328-1.101.781-1.627 1.253-5.192 4.816-6.771 13.983-1.762 23.873 2.926 5.605 6.43 9.076 11.178 11.844 2.7 1.576 5.44 2.402 7.908 2.402 1.602 0 3.08-.339 4.406-1.021.761-.421 1.334-.78 1.788-1.186 5.903-4.989 6.566-15.721.575-26.153-5.078-8.822-11.776-12.775-18.47-12.224M636.205 103.223c-4.765-3.433-8.43-4.552-13.318-4.165-2.784.218-5.136 1.119-6.839 2.63l-.403.386-.585.568c-5.067 6.108-1.184 16.404 3.722 20.76 4.624 4.102 10.678 6.629 16.152 6.629 3.28 0 6.077-.907 8.063-2.621.255-.228.469-.444.682-.655l.401-.382c1.598-1.949 2.338-4.665 2.043-7.668-.587-5.621-4.367-11.428-9.918-15.481M702.041 61.377c-.593-.198-1.343-.393-2.071-.5-.296-.052-.661-.069-1.018-.069-7.723 0-14.892 8.141-16.584 20.195-1.613 11.49 2.763 20.424 9.684 22.968.561.209 1.228.354 2.038.484.346.051.733.081 1.121.081 3.322 0 6.783-1.86 9.735-5.26 3.581-4.123 5.713-8.237 6.65-14.609 1.56-11.429-2.653-20.701-9.555-23.29M741.982 84.685c-14.769-7.426-27.839 12.282-24.182 24.991.833 2.882 2.527 5.102 4.856 6.395.333.189.785.377 1.223.542 1.104.387 2.292.596 3.559.596 6.331-.016 13.256-4.91 17.321-11.974 2.593-4.491 2.98-6.923 2.608-11.363-.407-4.845-2.507-7.75-5.385-9.188"/><path d="M663.036 164.426c12.112 0 37.722-.243 47.506-.958 1.631-.226 2.798-.939 2.798-2.139 0-13.111-10.72-22.17-22.593-22.17-15.364 0-26.305 12.64-27.711 25.267zm28.181 43.128c8.613 0 16.761-3.113 22.584-6.644 2.795-1.449 5.589-3.145 9.077-3.145 5.589 0 10.716 5.998 10.716 12.419 0 4.501-2.79 8.118-6.996 10.971-8.6 5.717-19.551 9.514-37.479 9.514-28.876 0-52.154-24.073-52.154-52.891 0-33.364 23.278-59.819 53.551-59.819 27.24 0 47.033 21.908 47.033 43.839 0 12.384-1.869 18.595-18.16 18.821-13.043.499-28.873.258-56.58.499.933 14.28 12.573 26.435 28.407 26.435z"/></g></g></svg>
                <div class="h-6 w-px bg-slate-600"></div>
                <span class="text-white text-base font-semibold">Growth Intelligence</span>
            </div>
            <div class="flex items-center gap-4">
                <div id="dataStatus" class="text-sm text-slate-400">
                    <span class="data-status missing" id="leadsStatus">Leads</span>
                    <span class="mx-2">|</span>
                    <span class="data-status missing" id="clientsStatus">Clients</span>
                    <span class="mx-2">|</span>
                    <span class="data-status missing" id="appointmentsStatus">Appointments</span>
                    <span class="mx-2">|</span>
                    <span class="data-status missing" id="transactionsStatus">Transactions</span>
                </div>
                <button onclick="showDataManager()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium transition">
                    üìÅ Import Data
                </button>
                <select id="globalLocation" onchange="applyFilters()" class="bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-sm">
                    <option value="all">All Locations</option>
                </select>
                <select id="globalTimeRange" onchange="applyFilters()" class="bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-sm">
                    <option value="30">Last 30 Days</option>
                    <option value="90" selected>Last 90 Days</option>
                    <option value="180">Last 180 Days</option>
                    <option value="365">Last 12 Months</option>
                </select>
                <button onclick="openCopilot()" class="copilot-btn w-9 h-9 rounded-lg flex items-center justify-center" title="Growth Copilot">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Navigation - Intelligence Modules -->
    <nav class="glass mx-6 mt-4 rounded-xl p-2 max-w-[1800px] mx-auto">
        <div class="flex gap-2">
            <button onclick="showView('overview')" class="nav-tab active px-6 py-3 rounded-lg text-sm font-medium" data-view="overview" title="Growth Health Overview">
                Growth Health
            </button>
            <button onclick="showView('funnel')" class="nav-tab px-6 py-3 rounded-lg text-sm font-medium" data-view="funnel" title="Conversion Intelligence">
                Conversion
            </button>
            <button onclick="showView('channels')" class="nav-tab px-6 py-3 rounded-lg text-sm font-medium" data-view="channels" title="Channel Intelligence">
                Channels
            </button>
            <button onclick="showView('customers')" class="nav-tab px-6 py-3 rounded-lg text-sm font-medium" data-view="customers" title="Customer Value Intelligence">
                Customer Value
            </button>
            <button onclick="showView('cohorts')" class="nav-tab px-6 py-3 rounded-lg text-sm font-medium" data-view="cohorts" title="Cohort Intelligence">
                Cohorts
            </button>
            <button onclick="showView('insights')" class="nav-tab px-6 py-3 rounded-lg text-sm font-medium" data-view="insights" title="Decision Insights">
                Insights
            </button>
            <button onclick="showView('locations')" class="nav-tab px-6 py-3 rounded-lg text-sm font-medium" data-view="locations" title="Location Deep Dive">
                Locations
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="p-6 max-w-[1800px] mx-auto">
        <!-- Data Manager Modal -->
        <div id="dataManagerModal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-6">
            <div class="glass rounded-2xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">üìÅ Data Import Manager</h2>
                    <button onclick="hideDataManager()" class="text-slate-400 hover:text-white text-2xl">&times;</button>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <!-- Leads Upload -->
                    <div class="upload-zone rounded-xl p-6 text-center" id="leadsUpload"
                         ondrop="handleDrop(event, 'leads')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <div class="text-4xl mb-3">üìã</div>
                        <div class="font-medium mb-2">Leads Data</div>
                        <div class="text-sm text-slate-400 mb-4">K9Leads - modified.csv</div>
                        <input type="file" id="leadsFile" accept=".csv" onchange="handleFileSelect(event, 'leads')" class="hidden">
                        <button onclick="document.getElementById('leadsFile').click()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm">
                            Select File
                        </button>
                        <div id="leadsFileInfo" class="mt-3 text-sm text-slate-400"></div>
                    </div>

                    <!-- Clients Upload -->
                    <div class="upload-zone rounded-xl p-6 text-center" id="clientsUpload"
                         ondrop="handleDrop(event, 'clients')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <div class="text-4xl mb-3">üë•</div>
                        <div class="font-medium mb-2">Clients Data</div>
                        <div class="text-sm text-slate-400 mb-4">k9_client_by_locations/*.csv</div>
                        <input type="file" id="clientsFile" accept=".csv" multiple onchange="handleFileSelect(event, 'clients')" class="hidden">
                        <button onclick="document.getElementById('clientsFile').click()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm">
                            Select Files
                        </button>
                        <div id="clientsFileInfo" class="mt-3 text-sm text-slate-400"></div>
                    </div>

                    <!-- Appointments Upload -->
                    <div class="upload-zone rounded-xl p-6 text-center" id="appointmentsUpload"
                         ondrop="handleDrop(event, 'appointments')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <div class="text-4xl mb-3">üìÖ</div>
                        <div class="font-medium mb-2">Appointments Data</div>
                        <div class="text-sm text-slate-400 mb-4">k9_appointmentxpet_by_locations/*.csv</div>
                        <input type="file" id="appointmentsFile" accept=".csv" multiple onchange="handleFileSelect(event, 'appointments')" class="hidden">
                        <button onclick="document.getElementById('appointmentsFile').click()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm">
                            Select Files
                        </button>
                        <div id="appointmentsFileInfo" class="mt-3 text-sm text-slate-400"></div>
                    </div>

                    <!-- Transactions Upload -->
                    <div class="upload-zone rounded-xl p-6 text-center" id="transactionsUpload"
                         ondrop="handleDrop(event, 'transactions')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <div class="text-4xl mb-3">üí≥</div>
                        <div class="font-medium mb-2">Transactions Data</div>
                        <div class="text-sm text-slate-400 mb-4">k9_transactions_by_locations/*.csv</div>
                        <input type="file" id="transactionsFile" accept=".csv" multiple onchange="handleFileSelect(event, 'transactions')" class="hidden">
                        <button onclick="document.getElementById('transactionsFile').click()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm">
                            Select Files
                        </button>
                        <div id="transactionsFileInfo" class="mt-3 text-sm text-slate-400"></div>
                    </div>
                </div>

                <div class="mt-6 flex justify-between items-center">
                    <div class="text-sm text-slate-400">
                        üí° Tip: You can drag and drop files or select multiple files at once
                    </div>
                    <div class="flex gap-3">
                        <button onclick="loadDemoData()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">
                            Load Demo Data
                        </button>
                        <button onclick="processAllData()" class="px-6 py-2 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 rounded-lg text-sm font-medium">
                            Process & Analyze
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overview View - Executive Decision Dashboard -->
        <div id="view-overview" class="view-content">
            <!-- Row 1: Core Funnel Health (Keep - validated as valuable) -->
            <div class="grid grid-cols-6 gap-4 mb-6">
                <div class="glass rounded-xl p-4 hover:bg-slate-800/70 transition cursor-pointer">
                    <div class="text-sm text-slate-400 mb-1">New Leads</div>
                    <div class="text-3xl font-bold text-white" id="metricNewLeads">-</div>
                    <div class="text-xs mt-2" id="metricNewLeadsTrend">
                        <span class="text-slate-500">vs prior period</span>
                    </div>
                </div>
                <div class="glass rounded-xl p-4 hover:bg-slate-800/70 transition cursor-pointer">
                    <div class="text-sm text-slate-400 mb-1">Converted</div>
                    <div class="text-3xl font-bold text-emerald-400" id="metricConverted">-</div>
                    <div class="text-xs mt-2" id="metricConvertedTrend">
                        <span class="text-slate-500">customers created</span>
                    </div>
                </div>
                <div class="glass rounded-xl p-4 hover:bg-slate-800/70 transition cursor-pointer">
                    <div class="text-sm text-slate-400 mb-1">Paying</div>
                    <div class="text-3xl font-bold text-purple-400" id="metricPaying">-</div>
                    <div class="text-xs mt-2" id="metricPayingTrend">
                        <span class="text-slate-500">with transactions</span>
                    </div>
                </div>
                <div class="glass rounded-xl p-4 hover:bg-slate-800/70 transition cursor-pointer">
                    <div class="text-sm text-slate-400 mb-1">Lead ‚Üí Customer</div>
                    <div class="text-3xl font-bold" id="metricLeadToCustomer">-</div>
                    <div class="text-xs mt-2" id="metricLeadToCustomerTrend">
                        <span class="text-slate-500">conversion rate</span>
                    </div>
                </div>
                <div class="glass rounded-xl p-4 hover:bg-slate-800/70 transition cursor-pointer">
                    <div class="text-sm text-slate-400 mb-1">Customer ‚Üí Paid</div>
                    <div class="text-3xl font-bold" id="metricCustomerToPaid">-</div>
                    <div class="text-xs mt-2" id="metricCustomerToPaidTrend">
                        <span class="text-slate-500">activation rate</span>
                    </div>
                </div>
                <div class="glass rounded-xl p-4 hover:bg-slate-800/70 transition cursor-pointer">
                    <div class="text-sm text-slate-400 mb-1">Active (90D)</div>
                    <div class="text-3xl font-bold" id="metricRetention">-</div>
                    <div class="text-xs mt-2" id="metricRetentionTrend">
                        <span class="text-slate-500">retention rate</span>
                    </div>
                </div>
            </div>

            <!-- Row 2: Performance Gaps + Week-over-Week Delta -->
            <div class="grid grid-cols-2 gap-6 mb-6">
                <!-- Performance Gaps - Where money is being left on the table -->
                <div class="glass rounded-xl p-5 relative group">
                    <button onclick="explainSection('gaps')" class="explain-btn absolute top-3 right-3 text-xs text-purple-400 hover:text-purple-300 opacity-0 group-hover:opacity-100 transition">Explain ‚ú®</button>
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-white">üí∞ Performance Gaps</h3>
                        <span class="text-xs text-slate-500">Where you're leaving money</span>
                    </div>
                    <div id="performanceGaps" class="space-y-3">
                        <div class="text-sm text-slate-500">Load data to see gaps...</div>
                    </div>
                </div>

                <!-- Week-over-Week Delta -->
                <div class="glass rounded-xl p-5 relative group">
                    <button onclick="explainSection('wow')" class="explain-btn absolute top-3 right-3 text-xs text-purple-400 hover:text-purple-300 opacity-0 group-hover:opacity-100 transition">Explain ‚ú®</button>
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-white">üìä Week-over-Week</h3>
                        <span class="text-xs text-slate-500">vs last 7 days</span>
                    </div>
                    <div id="wowDelta" class="grid grid-cols-2 gap-3">
                        <div class="bg-slate-800/50 rounded-lg p-3">
                            <div class="text-xs text-slate-400 mb-1">Leads</div>
                            <div class="flex items-center gap-2">
                                <span class="text-xl font-bold text-white" id="wowLeadsValue">-</span>
                                <span class="text-sm" id="wowLeadsDelta">-</span>
                            </div>
                        </div>
                        <div class="bg-slate-800/50 rounded-lg p-3">
                            <div class="text-xs text-slate-400 mb-1">Conversions</div>
                            <div class="flex items-center gap-2">
                                <span class="text-xl font-bold text-white" id="wowConvValue">-</span>
                                <span class="text-sm" id="wowConvDelta">-</span>
                            </div>
                        </div>
                        <div class="bg-slate-800/50 rounded-lg p-3">
                            <div class="text-xs text-slate-400 mb-1">Conv Rate</div>
                            <div class="flex items-center gap-2">
                                <span class="text-xl font-bold text-white" id="wowRateValue">-</span>
                                <span class="text-sm" id="wowRateDelta">-</span>
                            </div>
                        </div>
                        <div class="bg-slate-800/50 rounded-lg p-3">
                            <div class="text-xs text-slate-400 mb-1">Revenue</div>
                            <div class="flex items-center gap-2">
                                <span class="text-xl font-bold text-white" id="wowRevValue">-</span>
                                <span class="text-sm" id="wowRevDelta">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 3: Performance vs Target + Portfolio Matrix -->
            <div class="grid grid-cols-2 gap-6 mb-6">
                <!-- Performance vs Target (NEW - replaces Growth Trend) -->
                <div class="glass rounded-xl p-5 relative group">
                    <button onclick="explainSection('target')" class="explain-btn absolute top-3 right-3 text-xs text-purple-400 hover:text-purple-300 opacity-0 group-hover:opacity-100 transition">Explain ‚ú®</button>
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-white">Performance vs Target</h3>
                        <span class="text-xs text-slate-500">Gap to goal</span>
                    </div>
                    <div id="performanceVsTarget" class="space-y-4">
                        <!-- Conversion Rate Target -->
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-slate-400">Conversion Rate</span>
                                <span class="text-white"><span id="currentConvRate">-</span> / <span class="text-slate-500" id="targetConvRate">25%</span></span>
                            </div>
                            <div class="h-3 bg-slate-700 rounded-full overflow-hidden">
                                <div id="convRateProgress" class="h-full bg-gradient-to-r from-blue-500 to-purple-500 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs mt-1">
                                <span id="convRateGap" class="text-slate-500">-</span>
                                <span id="convRateProjection" class="text-slate-500">-</span>
                            </div>
                        </div>
                        <!-- Monthly Revenue Target -->
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-slate-400">Monthly Revenue</span>
                                <span class="text-white"><span id="currentRevenue">-</span> / <span class="text-slate-500" id="targetRevenue">$50K</span></span>
                            </div>
                            <div class="h-3 bg-slate-700 rounded-full overflow-hidden">
                                <div id="revenueProgress" class="h-full bg-gradient-to-r from-green-500 to-emerald-500 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs mt-1">
                                <span id="revenueGap" class="text-slate-500">-</span>
                                <span id="revenueProjection" class="text-slate-500">-</span>
                            </div>
                        </div>
                        <!-- Response Time Target -->
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-slate-400">Median Response Time</span>
                                <span class="text-white"><span id="currentResponseTime">-</span> / <span class="text-slate-500" id="targetResponseTime">&lt;2 hrs</span></span>
                            </div>
                            <div class="h-3 bg-slate-700 rounded-full overflow-hidden">
                                <div id="responseTimeProgress" class="h-full bg-gradient-to-r from-cyan-500 to-blue-500 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs mt-1">
                                <span id="responseTimeGap" class="text-slate-500">-</span>
                                <span id="responseTimeStatus" class="text-slate-500">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Portfolio Matrix (NEW - replaces Location table) -->
                <div class="glass rounded-xl p-5 relative group">
                    <button onclick="explainSection('portfolio')" class="explain-btn absolute top-3 right-24 text-xs text-purple-400 hover:text-purple-300 opacity-0 group-hover:opacity-100 transition">Explain ‚ú®</button>
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-white">Location Portfolio</h3>
                        <button onclick="showView('locations')" class="text-xs text-purple-400 hover:text-purple-300">Deep Dive ‚Üí</button>
                    </div>
                    <div class="relative" style="height: 220px;">
                        <!-- 2x2 Matrix Grid -->
                        <div class="absolute inset-0 grid grid-cols-2 grid-rows-2 gap-1">
                            <div class="bg-amber-500/10 rounded-tl-lg flex items-center justify-center">
                                <span class="text-xs text-amber-400/60">High Health / Low Volume</span>
                            </div>
                            <div class="bg-green-500/10 rounded-tr-lg flex items-center justify-center">
                                <span class="text-xs text-green-400/60">Stars</span>
                            </div>
                            <div class="bg-slate-500/10 rounded-bl-lg flex items-center justify-center">
                                <span class="text-xs text-slate-400/60">Emerging</span>
                            </div>
                            <div class="bg-red-500/10 rounded-br-lg flex items-center justify-center">
                                <span class="text-xs text-red-400/60">Needs Attention</span>
                            </div>
                        </div>
                        <!-- Location Dots will be positioned here -->
                        <div id="portfolioMatrixDots" class="absolute inset-0"></div>
                        <!-- Axis Labels -->
                        <div class="absolute -left-1 top-1/2 -translate-y-1/2 -rotate-90 text-xs text-slate-500 whitespace-nowrap">Conv Rate ‚Üí</div>
                        <div class="absolute bottom-0 left-1/2 -translate-x-1/2 text-xs text-slate-500">Lead Volume ‚Üí</div>
                    </div>
                </div>
            </div>

            <!-- Row 4: Quick Pulse (Simplified Alerts) -->
            <div class="glass rounded-xl p-5">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-semibold text-white">Quick Pulse</h3>
                    <span class="text-xs text-slate-500">Key signals this period</span>
                </div>
                <div id="quickPulseSignals" class="grid grid-cols-4 gap-4">
                    <div class="bg-slate-800/50 rounded-lg p-3 text-center">
                        <div class="text-2xl mb-1" id="pulseLeadTrend">-</div>
                        <div class="text-xs text-slate-400">Lead Trend</div>
                    </div>
                    <div class="bg-slate-800/50 rounded-lg p-3 text-center">
                        <div class="text-2xl mb-1" id="pulseConvTrend">-</div>
                        <div class="text-xs text-slate-400">Conv Trend</div>
                    </div>
                    <div class="bg-slate-800/50 rounded-lg p-3 text-center">
                        <div class="text-2xl mb-1" id="pulseTopChannel">-</div>
                        <div class="text-xs text-slate-400">Top Channel</div>
                    </div>
                    <div class="bg-slate-800/50 rounded-lg p-3 text-center">
                        <div class="text-2xl mb-1" id="pulseAlertCount">-</div>
                        <div class="text-xs text-slate-400">Active Alerts</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Funnel View -->
        <div id="view-funnel" class="view-content hidden">
            <!-- 1. Top KPI Strip -->
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="glass rounded-xl p-4 text-center hover:bg-slate-800/70 transition cursor-pointer">
                    <div class="text-3xl font-bold text-blue-400" id="funnelLeads">-</div>
                    <div class="text-sm text-slate-400 mt-1">Leads Created</div>
                </div>
                <div class="glass rounded-xl p-4 text-center hover:bg-slate-800/70 transition cursor-pointer">
                    <div class="text-3xl font-bold text-purple-400" id="funnelContacted">-</div>
                    <div class="text-sm text-slate-400 mt-1">Contacted</div>
                </div>
                <div class="glass rounded-xl p-4 text-center hover:bg-slate-800/70 transition cursor-pointer">
                    <div class="text-3xl font-bold text-amber-400" id="funnelBooked">-</div>
                    <div class="text-sm text-slate-400 mt-1">First Appt Booked</div>
                </div>
                <div class="glass rounded-xl p-4 text-center hover:bg-slate-800/70 transition cursor-pointer">
                    <div class="text-3xl font-bold text-green-400" id="funnelPaid">-</div>
                    <div class="text-sm text-slate-400 mt-1">Paid Customer</div>
                    <div class="text-xs text-slate-500 mt-1" id="funnelEndToEnd">-</div>
                </div>
            </div>

            <!-- 2. Simplified Lead Conversion Funnel (Summary) -->
            <div class="glass rounded-xl p-5 mb-6 hover:bg-slate-800/70 transition">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-semibold">Lead Conversion Summary</h3>
                    <span class="text-xs text-slate-500">Quick view: 3-step funnel</span>
                </div>
                <div id="simplifiedFunnel" class="flex items-end justify-center gap-8" style="height: 120px;">
                    <!-- Will be rendered by JS -->
                </div>
            </div>

            <!-- 3. Conversion Funnel Flow (Sankey) -->
            <div class="glass rounded-xl p-5 mb-6">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-semibold">Conversion Funnel Flow</h3>
                    <span class="text-xs text-slate-500">Total Leads ‚Üí Channel ‚Üí Outcome</span>
                </div>
                <p class="text-xs text-slate-400 mb-4">How leads flow through your conversion pipeline</p>
                <div id="funnelSankey" style="height: 380px;"></div>
            </div>

            <!-- 4. Drop-off Analysis -->
            <div class="glass rounded-xl p-5 mb-6">
                <h3 class="font-semibold mb-4">Drop-off Analysis</h3>
                <p class="text-xs text-slate-400 mb-4">Where leads are lost at each stage (absolute drop-off %)</p>
                <div style="height: 200px;">
                    <canvas id="dropoffChart"></canvas>
                </div>
            </div>

            <!-- 5. Time to Convert + First Service -->
            <div class="grid grid-cols-2 gap-6 mb-6">
                <div class="glass rounded-xl p-5">
                    <h3 class="font-semibold mb-4">Time to Convert (Days)</h3>
                    <p class="text-xs text-slate-400 mb-3">Distribution of lead-to-customer conversion time</p>
                    <div style="height: 220px;">
                        <canvas id="timeToConvertChart"></canvas>
                    </div>
                </div>
                <div class="glass rounded-xl p-5">
                    <h3 class="font-semibold mb-4">First Service of Converted Customers</h3>
                    <p class="text-xs text-slate-400 mb-3">What service type drives conversion</p>
                    <div style="height: 220px;">
                        <canvas id="firstServiceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- 6. Advanced / Compare: Monthly Conversion Trend -->
            <div class="glass rounded-xl p-5">
                <details open>
                    <summary class="font-semibold cursor-pointer flex items-center gap-2">
                        <span>Monthly Conversion Trend by Location</span>
                        <span class="text-xs text-slate-500 font-normal">(for benchmarking)</span>
                    </summary>
                    <div class="mt-4">
                        <p class="text-xs text-slate-400 mb-4">Compare conversion performance across locations over time</p>
                        <div style="height: 280px;">
                            <canvas id="monthlyConversionTrendChart"></canvas>
                        </div>
                    </div>
                </details>
            </div>
        </div>

        <!-- Channels View -->
        <div id="view-channels" class="view-content hidden">
            <!-- ROI Summary Strip -->
            <div class="glass rounded-xl p-4 mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-8">
                        <div class="flex items-center gap-2">
                            <span class="text-slate-400 text-sm">Top ROI Channel:</span>
                            <span class="font-semibold text-green-400" id="topROIChannel">-</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-slate-400 text-sm">Highest Value/Lead:</span>
                            <span class="font-semibold text-blue-400" id="highestValueChannel">-</span>
                        </div>
                    </div>
                    <div class="text-xs text-slate-500">Ranked by 90D Revenue / Lead</div>
                </div>
            </div>

            <!-- Channel ROI Matrix -->
            <div class="glass rounded-xl p-5 mb-6">
                <h3 class="font-semibold mb-4">Channel ROI Matrix</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-left text-slate-400 border-b border-slate-700">
                                <th class="pb-3 pr-4">Channel</th>
                                <th class="pb-3 pr-4 text-right">Leads</th>
                                <th class="pb-3 pr-4 text-right">Conv %</th>
                                <th class="pb-3 pr-4 text-right">90D Rev/Lead</th>
                                <th class="pb-3 pr-4 text-right">90D Retention</th>
                                <th class="pb-3 pr-4 text-right">Avg LTV (90D)</th>
                                <th class="pb-3 text-right">Quality Score</th>
                            </tr>
                        </thead>
                        <tbody id="channelTable">
                            <tr><td colspan="7" class="py-8 text-center text-slate-400">Load data to see channel ROI...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-6">
                <div class="glass rounded-xl p-5">
                    <h3 class="font-semibold mb-4">ROI vs Volume Matrix</h3>
                    <p class="text-xs text-slate-500 mb-3">X: Lead Volume | Y: 90D Revenue/Lead | Color: Retention</p>
                    <div style="height: 280px;">
                        <canvas id="channelScatterChart"></canvas>
                    </div>
                </div>
                <div class="glass rounded-xl p-5">
                    <h3 class="font-semibold mb-4">Channel Trend Over Time</h3>
                    <div class="flex gap-2 mb-3">
                        <button onclick="setTrendMetric('leads')" id="trendBtn-leads" class="px-3 py-1 text-xs rounded bg-blue-600 text-white">Leads</button>
                        <button onclick="setTrendMetric('revPerLead')" id="trendBtn-revPerLead" class="px-3 py-1 text-xs rounded bg-slate-700 text-slate-300 hover:bg-slate-600">90D Rev/Lead</button>
                    </div>
                    <div style="height: 250px;">
                        <canvas id="channelTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Customers View -->
        <div id="view-customers" class="view-content hidden">
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="glass rounded-xl p-4">
                    <div class="text-slate-400 text-xs uppercase tracking-wide mb-1">Total Customers</div>
                    <div class="text-2xl font-bold" id="totalCustomers">-</div>
                </div>
                <div class="glass rounded-xl p-4">
                    <div class="text-slate-400 text-xs uppercase tracking-wide mb-1">Active (90D)</div>
                    <div class="text-2xl font-bold" id="activeCustomers">-</div>
                </div>
                <div class="glass rounded-xl p-4">
                    <div class="text-slate-400 text-xs uppercase tracking-wide mb-1">At-Risk Churn</div>
                    <div class="text-2xl font-bold text-amber-400" id="atRiskCustomers">-</div>
                </div>
                <div class="glass rounded-xl p-4">
                    <div class="text-slate-400 text-xs uppercase tracking-wide mb-1">Avg Revenue/Customer (90D)</div>
                    <div class="text-2xl font-bold" id="avgRevenue90d">-</div>
                </div>
            </div>

            <!-- PRIMARY CHART: Revenue by Care Type -->
            <div class="glass rounded-xl p-5 mb-6">
                <h3 class="font-semibold mb-2">Revenue by Care Type (Last 90 Days)</h3>
                <p class="text-xs text-slate-400 mb-4">Where your revenue comes from ‚Äî identifies which services drive the most value</p>
                <div class="grid grid-cols-2 gap-6">
                    <div style="height: 300px;">
                        <canvas id="careTypeRevenueChart"></canvas>
                    </div>
                    <div style="height: 300px; position: relative;">
                        <canvas id="careTypeBreakdownChart"></canvas>
                        <!-- Center text overlay - offset left because legend is on right -->
                        <div id="donutCenterText" class="absolute flex flex-col items-center justify-center pointer-events-none" style="top: 50%; left: calc(50% - 55px); transform: translate(-50%, -50%);">
                            <div class="text-3xl font-bold text-white" id="donutTotalRevenue">$0</div>
                            <div class="text-sm text-slate-400">Total Revenue</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-6 mb-6">
                <div class="glass rounded-xl p-5">
                    <h3 class="font-semibold mb-2">Customer Value Segments</h3>
                    <p class="text-xs text-slate-400 mb-3">Based on 90-day spend</p>
                    <div style="height: 260px;">
                        <canvas id="segmentChart"></canvas>
                    </div>
                </div>
                <div class="glass rounded-xl p-5">
                    <h3 class="font-semibold mb-2">Service Mix √ó Value Lift</h3>
                    <p class="text-xs text-slate-400 mb-3">Avg Revenue/Customer by service type</p>
                    <div style="height: 260px;">
                        <canvas id="serviceMixChart"></canvas>
                    </div>
                </div>
                <div class="glass rounded-xl p-5">
                    <h3 class="font-semibold mb-2">Visit Frequency Distribution</h3>
                    <p class="text-xs text-slate-400 mb-3">Customer visit patterns</p>
                    <div style="height: 260px;">
                        <canvas id="frequencyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Churn Risk Table -->
            <div class="glass rounded-xl p-5">
                <h3 class="font-semibold mb-4">üö® High Churn Risk Customers (Recommended Actions)</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-left text-slate-400 border-b border-slate-700">
                                <th class="pb-3 pr-4">Customer</th>
                                <th class="pb-3 pr-4">Location</th>
                                <th class="pb-3 pr-4 text-right">Total Spend</th>
                                <th class="pb-3 pr-4 text-right">Visits</th>
                                <th class="pb-3 pr-4 text-right">Days Since Last</th>
                                <th class="pb-3 pr-4">Risk Level</th>
                                <th class="pb-3">Recommended Action</th>
                            </tr>
                        </thead>
                        <tbody id="churnRiskTable">
                            <tr><td colspan="7" class="py-8 text-center text-slate-400">Load data to see churn risk analysis...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Cohorts View - Decision-Focused -->
        <div id="view-cohorts" class="view-content hidden">
            <!-- Section 1: Cohort Health Summary -->
            <div class="mb-6">
                <h3 class="font-semibold mb-2">Cohort Health Summary</h3>
                <p class="text-xs text-slate-400 mb-4">Key cohorts at a glance ‚Äî which to replicate, which need attention</p>
                <div id="cohortHealthCards" class="grid grid-cols-4 gap-4">
                    <div class="text-slate-400 text-sm p-8 text-center col-span-4">Load data to see cohort analysis...</div>
                </div>
            </div>

            <!-- Section 2: Cohort Breakdown (Why) -->
            <div class="glass rounded-xl p-5 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="font-semibold">Cohort Breakdown</h3>
                        <p class="text-xs text-slate-400">Understanding why cohorts perform differently</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="switchCohortBreakdownTab('service')" id="cohortTabService" class="cohort-tab px-3 py-1.5 rounded-lg text-sm bg-blue-500/20 text-blue-400">First Service</button>
                        <button onclick="switchCohortBreakdownTab('channel')" id="cohortTabChannel" class="cohort-tab px-3 py-1.5 rounded-lg text-sm bg-slate-700/50 text-slate-400 hover:bg-slate-700">Entry Channel</button>
                        <button onclick="switchCohortBreakdownTab('location')" id="cohortTabLocation" class="cohort-tab px-3 py-1.5 rounded-lg text-sm bg-slate-700/50 text-slate-400 hover:bg-slate-700">Location Mix</button>
                    </div>
                </div>
                <div id="cohortBreakdownContent" class="grid grid-cols-2 gap-6">
                    <div style="height: 280px;">
                        <canvas id="cohortBreakdownChart"></canvas>
                    </div>
                    <div id="cohortBreakdownLegend" class="flex flex-col justify-center">
                        <div class="text-slate-400 text-sm">Select a cohort card to see breakdown...</div>
                    </div>
                </div>
            </div>

            <!-- Section 3: Cohort ‚Üí Action -->
            <div class="glass rounded-xl p-5 mb-6">
                <h3 class="font-semibold mb-2">Recommended Actions by Cohort</h3>
                <p class="text-xs text-slate-400 mb-4">What to do next based on cohort characteristics</p>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-left text-slate-400 border-b border-slate-700">
                                <th class="pb-3 pr-4">Cohort</th>
                                <th class="pb-3 pr-4">Status</th>
                                <th class="pb-3 pr-4">Key Risk / Opportunity</th>
                                <th class="pb-3">Suggested Action</th>
                            </tr>
                        </thead>
                        <tbody id="cohortActionsTable">
                            <tr><td colspan="4" class="py-8 text-center text-slate-400">Load data to see cohort actions...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Collapsible: Raw Cohort Table -->
            <details class="glass rounded-xl p-5">
                <summary class="font-semibold cursor-pointer flex items-center gap-2">
                    <span class="text-slate-400">üìä</span> View All Cohorts (Raw Data)
                </summary>
                <div id="cohortRawTable" class="mt-4 overflow-x-auto">
                    <div class="text-slate-400 text-sm p-4 text-center">Load data to see full cohort table...</div>
                </div>
            </details>
        </div>

        <!-- Location Deep Dive View -->
        <div id="view-locations" class="view-content hidden">
            <!-- Header Section - Location Insights Intro -->
            <div class="glass rounded-xl p-5 mb-4 border-l-4 border-indigo-500">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-bold text-white mb-1">Location Insights</h2>
                        <p class="text-sm text-slate-400">Deep-dive analysis for individual locations ‚Äî growth trajectory, channel gaps, and operational maturity</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <label class="text-sm text-slate-400">Select Location:</label>
                        <select id="locationInsightSelector" onchange="switchLocationTab(this.value)" class="bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:border-blue-500 min-w-[200px]">
                            <option value="deerfield">Deerfield (New Location)</option>
                            <option value="lax">LAX (Established)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Deerfield Section -->
            <div id="loc-section-deerfield" class="loc-section">
                <!-- Header Card -->
                <div class="glass rounded-xl p-6 mb-4 border-l-4 border-blue-500">
                    <h3 class="text-xl font-bold text-white mb-2">Deerfield: A New Location Success Story</h3>
                    <p class="text-slate-400 text-sm">Compressed 12-18 months of typical maturation into just 6 months. Now operating at or above LAX benchmarks.</p>
                    <div class="mt-4 grid grid-cols-4 gap-4">
                        <div class="bg-slate-800/50 p-4 rounded-lg">
                            <p class="text-xs text-slate-400">Nov '25 Conv Rate</p>
                            <p class="text-2xl font-bold text-white">16.0%</p>
                        </div>
                        <div class="bg-slate-800/50 p-4 rounded-lg">
                            <p class="text-xs text-slate-400">Dec '25 Conv Rate</p>
                            <p class="text-2xl font-bold text-white">30.6%</p>
                        </div>
                        <div class="bg-slate-800/50 p-4 rounded-lg">
                            <p class="text-xs text-slate-400">Jan '26 Conv Rate</p>
                            <p class="text-2xl font-bold text-green-400">36.9%</p>
                        </div>
                        <div class="bg-slate-800/50 p-4 rounded-lg">
                            <p class="text-xs text-slate-400">Trajectory</p>
                            <p class="text-2xl font-bold text-green-400">‚Üë Exceeding</p>
                        </div>
                    </div>
                </div>

                <!-- Maturation Journey Chart -->
                <div class="glass rounded-xl p-5 mb-4">
                    <h3 class="font-semibold text-white mb-4">Deerfield Maturation Journey</h3>
                    <div style="height: 250px;">
                        <canvas id="deerfieldJourneyChart"></canvas>
                    </div>
                    <div class="mt-4 grid grid-cols-4 gap-3 text-center text-xs">
                        <div class="bg-slate-700/50 p-3 rounded-lg">
                            <p class="font-semibold text-slate-300">Pre-Launch</p>
                            <p class="text-slate-500">May 2025</p>
                            <p class="text-slate-400">Setup & Testing</p>
                        </div>
                        <div class="bg-amber-500/10 p-3 rounded-lg border border-amber-500/30">
                            <p class="font-semibold text-amber-400">Early Ramp</p>
                            <p class="text-slate-500">Jun-Aug 2025</p>
                            <p class="text-slate-400">0-0.6% Conv</p>
                        </div>
                        <div class="bg-blue-500/10 p-3 rounded-lg border border-blue-500/30">
                            <p class="font-semibold text-blue-400">Building Momentum</p>
                            <p class="text-slate-500">Sep-Oct 2025</p>
                            <p class="text-slate-400">1.5-2% Conv</p>
                        </div>
                        <div class="bg-green-500/10 p-3 rounded-lg border border-green-500/30">
                            <p class="font-semibold text-green-400">Maturity</p>
                            <p class="text-slate-500">Nov 2025+</p>
                            <p class="text-slate-400">16-37% Conv</p>
                        </div>
                    </div>
                </div>

                <!-- Channel Performance Gap -->
                <div class="glass rounded-xl p-5">
                    <h3 class="font-semibold text-white mb-4">Channel Performance Gap</h3>
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-sm font-medium text-slate-300 mb-3">Online Booking ‚úì Working Well</h4>
                            <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                                <div class="flex justify-between mb-2 text-sm">
                                    <span class="text-slate-400">Conversion Rate</span>
                                    <span class="font-bold text-green-400">21.0%</span>
                                </div>
                                <div class="flex justify-between mb-2 text-sm">
                                    <span class="text-slate-400">Leads</span>
                                    <span class="text-white">438</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-slate-400">Conversions</span>
                                    <span class="text-white">92</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-slate-300 mb-3">Manual Channel ‚úó Critical Gap</h4>
                            <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4">
                                <div class="flex justify-between mb-2 text-sm">
                                    <span class="text-slate-400">Conversion Rate</span>
                                    <span class="font-bold text-red-400">1.15%</span>
                                </div>
                                <div class="flex justify-between mb-2 text-sm">
                                    <span class="text-slate-400">Leads</span>
                                    <span class="text-white">434</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-slate-400">Conversions</span>
                                    <span class="text-white">5</span>
                                </div>
                                <div class="mt-3 pt-3 border-t border-red-500/30">
                                    <p class="text-xs text-red-400">LAX Benchmark: 32.87% ‚Üí 142+ conversions expected</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- LAX Section -->
            <div id="loc-section-lax" class="loc-section hidden">
                <!-- Header Card -->
                <div class="glass rounded-xl p-6 mb-4 border-l-4 border-purple-500">
                    <h3 class="text-xl font-bold text-white mb-2">LAX: The Established Benchmark</h3>
                    <p class="text-slate-400 text-sm">10+ months of operations with proven processes. MoeGo migration Oct 1, 2025 shows mature operation adapting to unified CRM.</p>
                    <div class="mt-4 grid grid-cols-4 gap-4">
                        <div class="bg-slate-800/50 p-4 rounded-lg">
                            <p class="text-xs text-slate-400">Overall Conv Rate</p>
                            <p class="text-2xl font-bold text-purple-400">25.5%</p>
                        </div>
                        <div class="bg-slate-800/50 p-4 rounded-lg">
                            <p class="text-xs text-slate-400">Manual Conv Rate</p>
                            <p class="text-2xl font-bold text-green-400">32.87%</p>
                        </div>
                        <div class="bg-slate-800/50 p-4 rounded-lg">
                            <p class="text-xs text-slate-400">Median Response</p>
                            <p class="text-2xl font-bold text-blue-400">1.7 hrs</p>
                        </div>
                        <div class="bg-slate-800/50 p-4 rounded-lg">
                            <p class="text-xs text-slate-400">Total Revenue</p>
                            <p class="text-2xl font-bold text-white">$358K</p>
                        </div>
                    </div>
                </div>

                <!-- LAX Monthly Performance Chart -->
                <div class="glass rounded-xl p-5 mb-4">
                    <h3 class="font-semibold text-white mb-4">LAX Monthly Performance on MoeGo</h3>
                    <div style="height: 250px;">
                        <canvas id="laxMonthlyChart"></canvas>
                    </div>
                </div>

                <!-- Top Referral Sources -->
                <div class="glass rounded-xl p-5">
                    <h3 class="font-semibold text-white mb-4">Top Converting Referral Sources</h3>
                    <div class="grid grid-cols-2 gap-6">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="text-left text-slate-400 border-b border-slate-700">
                                    <th class="pb-2">Source</th>
                                    <th class="pb-2 text-right">Leads</th>
                                    <th class="pb-2 text-right">Conv</th>
                                    <th class="pb-2 text-right">Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b border-slate-700/50">
                                    <td class="py-2 text-white">Search Engine Result</td>
                                    <td class="text-right text-slate-300">16</td>
                                    <td class="text-right text-slate-300">13</td>
                                    <td class="text-right font-semibold text-green-400">81.3%</td>
                                </tr>
                                <tr class="border-b border-slate-700/50">
                                    <td class="py-2 text-white">Referrals</td>
                                    <td class="text-right text-slate-300">5</td>
                                    <td class="text-right text-slate-300">4</td>
                                    <td class="text-right font-semibold text-green-400">80.0%</td>
                                </tr>
                                <tr class="border-b border-slate-700/50">
                                    <td class="py-2 text-white">Search Engine Ad</td>
                                    <td class="text-right text-slate-300">3</td>
                                    <td class="text-right text-slate-300">2</td>
                                    <td class="text-right font-semibold text-green-400">66.7%</td>
                                </tr>
                                <tr class="border-b border-slate-700/50">
                                    <td class="py-2 text-white">Other (likely WOM)</td>
                                    <td class="text-right text-slate-300">41</td>
                                    <td class="text-right text-slate-300">25</td>
                                    <td class="text-right font-semibold text-green-400">61.0%</td>
                                </tr>
                                <tr>
                                    <td class="py-2 text-white">Google</td>
                                    <td class="text-right text-slate-300">5</td>
                                    <td class="text-right text-slate-300">2</td>
                                    <td class="text-right font-semibold text-slate-300">40.0%</td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="bg-purple-500/10 border border-purple-500/30 p-4 rounded-lg">
                            <h4 class="font-medium text-purple-400 mb-3">Key Insight</h4>
                            <p class="text-sm text-slate-300 mb-3">LAX's "Other" category (61% conversion, 41 leads) likely represents word-of-mouth and referrals from 10+ months of building reputation.</p>
                            <p class="text-sm text-slate-300">High-intent sources (Search, Referrals) convert at 66-81% - these are qualified leads actively looking for pet care.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Insights View - Simplified -->
        <div id="view-insights" class="view-content hidden">
            <!-- Verdict Banner -->
            <div id="executiveVerdict" class="glass rounded-xl p-4 mb-4 border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div id="verdictText" class="text-white font-medium">Load data...</div>
                    <div id="verdictBadge" class="px-3 py-1 rounded-lg text-xs font-semibold bg-slate-700 text-slate-400">‚Äî</div>
                </div>
            </div>

            <!-- Compact Risk/Opportunity Cards -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="glass rounded-xl p-4">
                    <div class="text-xs text-red-400 font-medium mb-2">‚ö†Ô∏è Risks</div>
                    <div id="topGrowthRisks" class="space-y-2 text-sm"></div>
                </div>
                <div class="glass rounded-xl p-4">
                    <div class="text-xs text-green-400 font-medium mb-2">üìà Opportunities</div>
                    <div id="leverageOpportunities" class="space-y-2 text-sm"></div>
                </div>
            </div>

            <!-- Actions Table (compact) -->
            <div class="glass rounded-xl p-4 mb-4">
                <div class="text-xs text-purple-400 font-medium mb-2">üéØ Recommended Actions</div>
                <div id="recommendedActions" class="space-y-2 text-sm"></div>
            </div>

            <!-- Response Velocity Analysis -->
            <div class="glass rounded-xl p-5">
                <h3 class="font-semibold mb-2">Response Velocity Analysis</h3>
                <p class="text-xs text-slate-400 mb-4">Speed to convert is a competitive moat ‚Äî faster response correlates with higher conversion</p>
                <div id="velocityAnalysisContainer" class="grid grid-cols-2 gap-8">
                    <div class="text-sm text-slate-500">Load data to see velocity analysis...</div>
                </div>
            </div>
        </div>

        <!-- Enterprise Footer -->
        <footer class="glass mx-6 mt-8 mb-6 rounded-xl p-4 max-w-[1800px] mx-auto text-center">
            <div class="text-sm text-slate-400">
                MoeGo Growth Intelligence ¬∑ Decision Intelligence for Multi-Location Operators
            </div>
        </footer>
    </main>

    <!-- Growth Copilot Overlay -->
    <div id="copilotOverlay" class="copilot-overlay" onclick="closeCopilot()"></div>

    <!-- Growth Copilot Panel -->
    <div id="copilotPanel" class="copilot-panel">
        <!-- Header -->
        <div class="p-5 border-b border-slate-700/50">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="font-semibold text-white">Growth Copilot</h2>
                        <p class="text-xs text-slate-400">Executive Decision Intelligence</p>
                    </div>
                </div>
                <button onclick="closeCopilot()" class="text-slate-400 hover:text-white p-2 hover:bg-slate-700/50 rounded-lg transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <!-- Context Indicator -->
            <div id="copilotContext" class="mt-3 px-3 py-2 bg-slate-800/50 rounded-lg text-xs text-slate-400 flex items-center gap-2">
                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                    <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                </svg>
                <span>Viewing: <span id="copilotContextLabel" class="text-purple-400">Growth Health</span></span>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="p-4 border-b border-slate-700/50">
            <div class="flex gap-2" id="quickActionsContainer">
                <button onclick="askCopilot('summary')" class="quick-action flex-1 px-3 py-2 rounded-lg text-center">
                    <div class="text-sm font-medium text-white">Summary</div>
                </button>
                <button onclick="askCopilot('blockers')" class="quick-action flex-1 px-3 py-2 rounded-lg text-center">
                    <div class="text-sm font-medium text-white">Blockers</div>
                </button>
                <button onclick="askCopilot('opportunities')" class="quick-action flex-1 px-3 py-2 rounded-lg text-center">
                    <div class="text-sm font-medium text-white">Quick Wins</div>
                </button>
                <button onclick="askCopilot('comparison')" class="quick-action flex-1 px-3 py-2 rounded-lg text-center">
                    <div class="text-sm font-medium text-white">Locations</div>
                </button>
            </div>
        </div>

        <!-- Response Area -->
        <div class="flex-1 overflow-y-auto p-5" id="copilotResponseArea">
            <div class="text-center py-12">
                <h3 class="text-slate-400 font-medium mb-2">Ask me anything about your growth data</h3>
                <p class="text-sm text-slate-500 max-w-xs mx-auto">
                    Select a quick action above, or click "Explain This" on any section in the dashboard.
                </p>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-5 border-t border-slate-700/50">
            <div class="relative">
                <input type="text" id="copilotInput" placeholder="Ask about your growth metrics..."
                    class="w-full bg-slate-800/50 border border-slate-600 rounded-xl px-4 py-3 pr-12 text-sm text-white placeholder-slate-500 focus:outline-none focus:border-purple-500 transition"
                    onkeypress="if(event.key==='Enter') sendCopilotQuery()">
                <button onclick="sendCopilotQuery()" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 text-purple-400 hover:text-purple-300 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                </button>
            </div>
            <div class="text-xs text-slate-500 mt-2 text-center">
                Press Enter to send ¬∑ Copilot analyzes your current dashboard data
            </div>
        </div>
    </div>

    <script>
    // ============================================
    // GLOBAL STATE
    // ============================================
    let DATA = {
        leads: [],
        clients: [],
        appointments: [],
        transactions: [],
        pets: []
    };

    let COMPUTED = {
        customerMap: new Map(),      // customer_id -> merged data
        leadToCustomer: new Map(),   // lead_id -> customer_id
        channelMetrics: [],
        cohorts: [],
        segments: []
    };

    let FILTERS = {
        location: 'all',
        timeRange: 90  // days
    };

    let CHARTS = {};
    let LOCATIONS = [];

    // ============================================
    // FILE HANDLING
    // ============================================
    function showDataManager() {
        document.getElementById('dataManagerModal').classList.remove('hidden');
    }

    function hideDataManager() {
        document.getElementById('dataManagerModal').classList.add('hidden');
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.currentTarget.classList.add('dragover');
    }

    function handleDragLeave(e) {
        e.currentTarget.classList.remove('dragover');
    }

    function handleDrop(e, type) {
        e.preventDefault();
        e.currentTarget.classList.remove('dragover');
        const files = e.dataTransfer.files;
        processFiles(files, type);
    }

    function handleFileSelect(e, type) {
        const files = e.target.files;
        processFiles(files, type);
    }

    function processFiles(files, type) {
        const fileArray = Array.from(files);
        const infoEl = document.getElementById(`${type}FileInfo`);
        infoEl.textContent = `Loading ${fileArray.length} file(s)...`;

        let allData = [];
        let processed = 0;

        fileArray.forEach(file => {
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    allData = allData.concat(results.data);
                    processed++;

                    if (processed === fileArray.length) {
                        DATA[type] = allData;
                        infoEl.innerHTML = `<span class="text-green-400">‚úì ${allData.length} records loaded</span>`;
                        updateDataStatus(type, true);
                    }
                },
                error: (err) => {
                    infoEl.innerHTML = `<span class="text-red-400">Error: ${err.message}</span>`;
                }
            });
        });
    }

    function updateDataStatus(type, loaded) {
        const el = document.getElementById(`${type}Status`);
        el.classList.remove('missing', 'loaded');
        el.classList.add(loaded ? 'loaded' : 'missing');
    }

    function loadDemoData() {
        // Generate synthetic demo data for demonstration
        const locations = ['K9 Resort Davie', 'K9 Resort Horsham', 'K9 Resort Fairmount'];
        const sources = ['Google', 'Facebook', 'Instagram', 'Referral', 'Walk-in', 'Yelp'];
        const statuses = ['Converted', 'Converted', 'Converted', 'Open', 'Open', 'Lost'];

        // Generate 500 demo leads
        DATA.leads = [];
        for (let i = 0; i < 500; i++) {
            const createDate = new Date();
            createDate.setDate(createDate.getDate() - Math.floor(Math.random() * 180));
            const status = statuses[Math.floor(Math.random() * statuses.length)];

            DATA.leads.push({
                lead_id: `LEAD-${1000 + i}`,
                lead_create_time: createDate.toISOString(),
                lead_source: sources[Math.floor(Math.random() * sources.length)],
                converted_status: status,
                company_name: locations[Math.floor(Math.random() * locations.length)],
                business_location: locations[Math.floor(Math.random() * locations.length)],
                log_type_count: Math.random() > 0.3 ? 'MESSAGE:2,EMAIL:1' : ''
            });
        }

        // Generate 300 demo clients
        DATA.clients = [];
        for (let i = 0; i < 300; i++) {
            const daysSince = Math.floor(Math.random() * 200);
            const spend = Math.random() > 0.15 ? Math.floor(Math.random() * 2000) + 100 : 0;

            DATA.clients.push({
                customer_id: `CUST-${2000 + i}`,
                business_name: locations[Math.floor(Math.random() * locations.length)],
                total_spend_12m: spend,
                days_since_last: daysSince,
                visit_count: Math.floor(Math.random() * 20) + 1,
                had_grooming: Math.random() > 0.3,
                had_boarding: Math.random() > 0.5,
                had_daycare: Math.random() > 0.7,
                first_visit_date: new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000).toISOString()
            });
        }

        // Update status
        document.getElementById('leadsStatus').className = 'data-status loaded';
        document.getElementById('leadsFileInfo').textContent = '500 demo leads';
        document.getElementById('clientsStatus').className = 'data-status loaded';
        document.getElementById('clientsFileInfo').textContent = '300 demo clients';

        console.log('Demo data loaded:', { leads: DATA.leads.length, clients: DATA.clients.length });
        processAllData();
    }

    // ============================================
    // DATA PROCESSING
    // ============================================
    function processAllData() {
        if (DATA.leads.length === 0) {
            alert('Please load at least the Leads data to begin analysis.');
            return;
        }

        console.log('Processing data...', {
            leads: DATA.leads.length,
            clients: DATA.clients.length,
            appointments: DATA.appointments.length,
            transactions: DATA.transactions.length
        });

        // Extract unique locations
        extractLocations();

        // Build customer map (join leads to clients)
        buildCustomerMap();

        // Compute channel metrics
        computeChannelMetrics();

        // Compute cohorts
        computeCohorts();

        // Compute segments
        computeSegments();

        // Hide modal and refresh dashboard
        hideDataManager();
        applyFilters();
    }

    function extractLocations() {
        const locSet = new Set();

        DATA.leads.forEach(l => {
            if (l.company_name) locSet.add(l.company_name);
        });

        DATA.clients.forEach(c => {
            if (c.business_name) locSet.add(c.business_name);
        });

        LOCATIONS = Array.from(locSet).filter(l => l && !l.includes('Training'));

        // Update location dropdown
        const select = document.getElementById('globalLocation');
        select.innerHTML = '<option value="all">All Locations</option>';
        LOCATIONS.forEach(loc => {
            const shortName = loc.replace('K9 Resorts Luxury Pet Hotel ', '').replace('K9 Resorts - ', '');
            select.innerHTML += `<option value="${loc}">${shortName}</option>`;
        });
    }

    function buildCustomerMap() {
        COMPUTED.customerMap.clear();
        COMPUTED.leadToCustomer.clear();

        // First, index clients by customer_id
        const clientIndex = new Map();
        DATA.clients.forEach(c => {
            if (c.customer_id) {
                clientIndex.set(c.customer_id, c);
            }
        });

        // Then process leads and link to customers
        DATA.leads.forEach(lead => {
            const customerId = lead.convert_to_customer_id;

            if (customerId && customerId !== '0') {
                COMPUTED.leadToCustomer.set(lead.lead_id, customerId);

                const client = clientIndex.get(customerId) || {};

                if (!COMPUTED.customerMap.has(customerId)) {
                    COMPUTED.customerMap.set(customerId, {
                        customer_id: customerId,
                        lead_id: lead.lead_id,
                        lead_name: lead.lead_name,
                        channel: lead.channel || 'Unknown',
                        referral_source: lead.referral_source || '',
                        lead_create_time: lead.lead_create_time,
                        converted_on: lead.converted_on,
                        first_service_type: lead.converted_first_service_type,
                        first_service_dollar: parseFloat(lead.converted_first_service_dollar) || 0,
                        location: lead.company_name,
                        // From client data
                        total_spend_12m: parseFloat(client.total_spend_12m) || 0,
                        visits_12m: parseInt(client.visits_12m) || 0,
                        apv_12m: parseFloat(client.apv_12m) || 0,
                        days_since_last: parseInt(client.days_since_last_visit_12m) || 999,
                        had_boarding: client.had_boarding_12m === '1',
                        had_daycare: client.had_daycare_12m === '1',
                        had_grooming: client.had_grooming_12m === '1',
                        is_active: client.is_active === '1'
                    });
                }
            }
        });

        console.log(`Built customer map with ${COMPUTED.customerMap.size} customers`);
    }

    function computeChannelMetrics() {
        const channelStats = new Map();

        DATA.leads.forEach(lead => {
            const channel = normalizeChannel(lead.channel);

            if (!channelStats.has(channel)) {
                channelStats.set(channel, {
                    channel,
                    leads: 0,
                    converted: 0,
                    totalFirstOrder: 0,
                    total90DRevenue: 0,  // NEW: 90D revenue from converted customers
                    totalLTV: 0,
                    retained90d: 0,
                    customers: []
                });
            }

            const stats = channelStats.get(channel);
            stats.leads++;

            if (lead.converted_status === 'Converted' && lead.convert_to_customer_id && lead.convert_to_customer_id !== '0') {
                stats.converted++;
                stats.totalFirstOrder += parseFloat(lead.converted_first_service_dollar) || 0;

                const customer = COMPUTED.customerMap.get(lead.convert_to_customer_id);
                if (customer) {
                    // Use total_spend_12m as proxy for 90D revenue (or actual if available)
                    // In practice, you'd calculate actual 90D revenue from transactions
                    const revenue90d = customer.total_spend_12m;  // Proxy - ideally filter transactions to first 90 days
                    stats.total90DRevenue += revenue90d;
                    stats.totalLTV += customer.total_spend_12m;
                    if (customer.days_since_last <= 90) stats.retained90d++;
                    stats.customers.push(customer);
                }
            }
        });

        // Calculate derived metrics
        let metricsArray = Array.from(channelStats.values()).map(s => {
            const convRate = s.leads > 0 ? (s.converted / s.leads * 100) : 0;
            const retention90d = s.converted > 0 ? (s.retained90d / s.converted * 100) : 0;
            const revPerLead = s.leads > 0 ? (s.total90DRevenue / s.leads) : 0;  // PRIMARY KPI
            const avgLTV = s.converted > 0 ? s.totalLTV / s.converted : 0;

            return {
                ...s,
                convRate,
                avgFirstOrder: s.converted > 0 ? s.totalFirstOrder / s.converted : 0,
                avgLTV,
                retention90d,
                revPerLead  // ‚≠ê PRIMARY KPI: 90D Revenue per Lead
            };
        });

        // Calculate Quality Score with normalized values (need all metrics first)
        const maxRevPerLead = Math.max(...metricsArray.map(m => m.revPerLead), 1);
        const maxConvRate = Math.max(...metricsArray.map(m => m.convRate), 1);
        const maxRetention = Math.max(...metricsArray.map(m => m.retention90d), 1);

        metricsArray = metricsArray.map(m => ({
            ...m,
            qualityScore: calculateQualityScore(m, maxRevPerLead, maxConvRate, maxRetention)
        }));

        // Sort by custom order, Unknown always last
        COMPUTED.channelMetrics = metricsArray.sort((a, b) => {
            if (a.channel === 'Unknown') return 1;
            if (b.channel === 'Unknown') return -1;
            // Sort by revPerLead (primary KPI) descending
            return b.revPerLead - a.revPerLead;
        });
    }

    function calculateQualityScore(stats, maxRevPerLead, maxConvRate, maxRetention) {
        if (stats.channel === 'Unknown') return '-';
        if (stats.leads === 0) return 0;

        const revScore = maxRevPerLead > 0 ? (stats.revPerLead / maxRevPerLead * 100) : 0;
        const convScore = maxConvRate > 0 ? (stats.convRate / maxConvRate * 100) : 0;
        const retScore = maxRetention > 0 ? (stats.retention90d / maxRetention * 100) : 0;

        const score = (revScore * 0.4 + convScore * 0.3 + retScore * 0.3);
        return Math.round(score);
    }

    // Filtered version for location-aware channel metrics
    function computeChannelMetricsFiltered(leads, customers) {
        const customerMap = new Map();
        customers.forEach(c => customerMap.set(c.customer_id, c));

        const channelStats = new Map();

        leads.forEach(lead => {
            const channel = normalizeChannel(lead.channel);

            if (!channelStats.has(channel)) {
                channelStats.set(channel, {
                    channel,
                    leads: 0,
                    converted: 0,
                    total90DRevenue: 0,
                    totalLTV: 0,
                    retained90d: 0
                });
            }

            const stats = channelStats.get(channel);
            stats.leads++;

            if (lead.converted_status === 'Converted' && lead.convert_to_customer_id && lead.convert_to_customer_id !== '0') {
                stats.converted++;
                const customer = customerMap.get(lead.convert_to_customer_id) || COMPUTED.customerMap.get(lead.convert_to_customer_id);
                if (customer) {
                    stats.total90DRevenue += customer.total_spend_12m || 0;
                    stats.totalLTV += customer.total_spend_12m || 0;
                    if (customer.days_since_last <= 90) stats.retained90d++;
                }
            }
        });

        let metricsArray = Array.from(channelStats.values()).map(s => {
            const convRate = s.leads > 0 ? (s.converted / s.leads * 100) : 0;
            const retention90d = s.converted > 0 ? (s.retained90d / s.converted * 100) : 0;
            const revPerLead = s.leads > 0 ? (s.total90DRevenue / s.leads) : 0;
            const avgLTV = s.converted > 0 ? s.totalLTV / s.converted : 0;

            return { ...s, convRate, avgLTV, retention90d, revPerLead };
        });

        const maxRevPerLead = Math.max(...metricsArray.map(m => m.revPerLead), 1);
        const maxConvRate = Math.max(...metricsArray.map(m => m.convRate), 1);
        const maxRetention = Math.max(...metricsArray.map(m => m.retention90d), 1);

        return metricsArray.map(m => ({
            ...m,
            qualityScore: calculateQualityScore(m, maxRevPerLead, maxConvRate, maxRetention)
        })).sort((a, b) => {
            if (a.channel === 'Unknown') return 1;
            if (b.channel === 'Unknown') return -1;
            return b.revPerLead - a.revPerLead;
        });
    }

    function normalizeChannel(channel) {
        if (!channel) return 'Unknown';
        const ch = channel.toLowerCase().trim();

        // Online Booking
        if (ch === 'ob' || ch === 'online booking' || ch === 'online') return 'Online Booking';

        // Phone (merge Call + Text + Phone Call)
        if (ch === 'call' || ch === 'phone call' || ch === 'text' || ch === 'phone' || ch === 'sms') return 'Phone';

        // Walk-in (separate from phone)
        if (ch === 'walk-in' || ch === 'walkin' || ch === 'walk in') return 'Walk-in';

        // Manual ‚Üí could be Walk-in or Phone, default to Walk-in
        if (ch === 'manual') return 'Walk-in';

        // Paid Social (Instagram/Facebook)
        if (ch === 'if' || ch === 'instagram/facebook' || ch === 'instagram' || ch === 'facebook' ||
            ch === 'paid social' || ch === 'social') return 'Paid Social';

        // Google/Search
        if (ch === 'google' || ch === 'search' || ch === 'sem' || ch === 'ppc') return 'Google/Search';

        // Referral
        if (ch === 'referral' || ch === 'ref' || ch === 'word of mouth') return 'Referral';

        // Unknown - catch all
        return 'Unknown';
    }

    // Channel display order (Unknown always last)
    const CHANNEL_ORDER = ['Online Booking', 'Phone', 'Walk-in', 'Paid Social', 'Google/Search', 'Referral', 'Unknown'];

    function computeCohorts() {
        // Group customers by first purchase month
        const cohortMap = new Map();

        COMPUTED.customerMap.forEach((customer, id) => {
            if (!customer.converted_on) return;

            const cohortMonth = customer.converted_on.substring(0, 7); // YYYY-MM

            if (!cohortMap.has(cohortMonth)) {
                cohortMap.set(cohortMonth, []);
            }
            cohortMap.get(cohortMonth).push(customer);
        });

        COMPUTED.cohorts = Array.from(cohortMap.entries())
            .map(([month, customers]) => ({
                month,
                customers,
                count: customers.length,
                totalLTV: customers.reduce((sum, c) => sum + c.total_spend_12m, 0),
                avgLTV: customers.reduce((sum, c) => sum + c.total_spend_12m, 0) / customers.length,
                retention: customers.filter(c => c.days_since_last <= 90).length / customers.length * 100
            }))
            .sort((a, b) => a.month.localeCompare(b.month));
    }

    function computeSegments() {
        // Segment customers by value tier
        const customers = Array.from(COMPUTED.customerMap.values());

        const highValue = customers.filter(c => c.total_spend_12m >= 500);
        const midValue = customers.filter(c => c.total_spend_12m >= 100 && c.total_spend_12m < 500);
        const lowValue = customers.filter(c => c.total_spend_12m > 0 && c.total_spend_12m < 100);
        const noSpend = customers.filter(c => c.total_spend_12m === 0);

        COMPUTED.segments = [
            { name: 'VIP ($500+)', customers: highValue, color: '#22c55e' },
            { name: 'Regular ($100-500)', customers: midValue, color: '#3b82f6' },
            { name: 'Light ($1-100)', customers: lowValue, color: '#f59e0b' },
            { name: 'Converted Only', customers: noSpend, color: '#94a3b8' }
        ];
    }

    // ============================================
    // FILTERING
    // ============================================
    function applyFilters() {
        FILTERS.location = document.getElementById('globalLocation').value;
        FILTERS.timeRange = parseInt(document.getElementById('globalTimeRange').value);

        renderAllViews();
    }

    function getFilteredLeads() {
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - FILTERS.timeRange);

        return DATA.leads.filter(l => {
            // Location filter
            if (FILTERS.location !== 'all' && l.company_name !== FILTERS.location) return false;

            // Time filter
            if (l.lead_create_time) {
                const leadDate = new Date(l.lead_create_time);
                if (leadDate < cutoffDate) return false;
            }

            return true;
        });
    }

    function getFilteredCustomers() {
        const customers = Array.from(COMPUTED.customerMap.values());
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - FILTERS.timeRange);

        return customers.filter(c => {
            // Location filter
            if (FILTERS.location !== 'all' && c.location !== FILTERS.location) return false;

            // Time filter - filter by converted_on date if available
            if (c.converted_on) {
                const convertedDate = new Date(c.converted_on);
                if (convertedDate < cutoffDate) return false;
            }

            return true;
        });
    }

    // ============================================
    // VIEW SWITCHING
    // ============================================
    function showView(viewName) {
        // Hide all views
        document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));

        // Show selected view
        document.getElementById(`view-${viewName}`).classList.remove('hidden');

        // Update nav tabs
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.remove('active');
            if (tab.dataset.view === viewName) tab.classList.add('active');
        });
    }

    // ============================================
    // RENDERING
    // ============================================
    function renderAllViews() {
        renderOverview();
        renderFunnel();
        renderChannels();
        renderCustomers();
        renderCohorts();
        renderLocationsView();
        renderInsights();
    }

    function renderOverview() {
        const leads = getFilteredLeads();
        const customers = getFilteredCustomers();

        // THREE-LAYER METRICS
        const newLeads = leads.length;
        const convertedCustomers = leads.filter(l => l.converted_status === 'Converted').length;
        const payingCustomers = customers.filter(c => c.total_spend_12m > 0).length;
        const activeCustomers = customers.filter(c => c.days_since_last <= 90).length;

        const leadToCustomerRate = newLeads > 0 ? (convertedCustomers / newLeads * 100).toFixed(0) : 0;
        const customerToPaidRate = convertedCustomers > 0 ? (payingCustomers / convertedCustomers * 100).toFixed(0) : 0;
        const activeRate = customers.length > 0 ? (activeCustomers / customers.length * 100).toFixed(0) : 0;

        // Update KPI cards
        document.getElementById('metricNewLeads').textContent = newLeads.toLocaleString();
        document.getElementById('metricConverted').textContent = convertedCustomers.toLocaleString();
        document.getElementById('metricPaying').textContent = payingCustomers.toLocaleString();

        const rateEl1 = document.getElementById('metricLeadToCustomer');
        const rateEl2 = document.getElementById('metricCustomerToPaid');
        const rateEl3 = document.getElementById('metricRetention');

        rateEl1.textContent = leadToCustomerRate + '%';
        rateEl1.className = `text-3xl font-bold ${leadToCustomerRate >= 30 ? 'text-green-400' : leadToCustomerRate >= 20 ? 'text-amber-400' : 'text-red-400'}`;

        rateEl2.textContent = customerToPaidRate + '%';
        rateEl2.className = `text-3xl font-bold ${customerToPaidRate >= 70 ? 'text-green-400' : customerToPaidRate >= 50 ? 'text-amber-400' : 'text-red-400'}`;

        rateEl3.textContent = activeRate + '%';
        rateEl3.className = `text-3xl font-bold ${activeRate >= 50 ? 'text-green-400' : activeRate >= 30 ? 'text-amber-400' : 'text-red-400'}`;

        // NEW: Performance Gaps (replaces Key Decision)
        renderPerformanceGaps(leads, customers);

        // NEW: Week-over-Week Delta
        renderWoWDelta(leads, customers);

        // NEW: Performance vs Target
        renderPerformanceVsTarget(leads, customers);

        // NEW: Portfolio Matrix
        renderPortfolioMatrix(leads, customers);

        // NEW: Quick Pulse
        renderQuickPulse(leads, customers);
    }

    // ============================================
    // EXECUTIVE DECISION SURFACE - NEW OVERVIEW FUNCTIONS
    // ============================================

    function renderPerformanceGaps(leads, customers) {
        const container = document.getElementById('performanceGaps');
        if (!container || leads.length === 0) {
            if (container) container.innerHTML = '<div class="text-sm text-slate-500">Load data to see gaps...</div>';
            return;
        }

        const gaps = [];
        const locationStats = computeLocationStats(leads, customers);

        // 1. Channel Gap Analysis - find channels underperforming vs benchmark
        const channelByLoc = {};
        leads.forEach(l => {
            const ch = normalizeChannel(l.channel);
            const loc = l.company_name || 'Unknown';
            const key = `${loc}|${ch}`;
            if (!channelByLoc[key]) channelByLoc[key] = { loc, ch, leads: 0, converted: 0 };
            channelByLoc[key].leads++;
            if (l.converted_status === 'Converted') channelByLoc[key].converted++;
        });

        // Find biggest channel gap
        Object.values(channelByLoc).forEach(stat => {
            if (stat.leads < 15) return;
            const rate = stat.converted / stat.leads * 100;
            const sameChannelOther = Object.values(channelByLoc)
                .filter(s => s.ch === stat.ch && s.loc !== stat.loc && s.leads >= 10)
                .map(s => s.converted / s.leads * 100);
            if (sameChannelOther.length > 0) {
                const benchmark = Math.max(...sameChannelOther);
                const gap = benchmark - rate;
                if (gap > 10) {
                    const potentialConv = Math.round(stat.leads * (gap / 100));
                    const shortLoc = stat.loc.replace('K9 Resorts Luxury Pet Hotel ', '').replace('K9 Resorts - ', '');
                    gaps.push({
                        type: 'channel',
                        label: `${shortLoc} ${stat.ch}`,
                        current: rate.toFixed(0) + '%',
                        benchmark: benchmark.toFixed(0) + '%',
                        impact: `+${potentialConv} conv`,
                        impactNum: potentialConv,
                        gapPct: gap
                    });
                }
            }
        });

        // 2. Location Gap - underperforming locations vs top performer
        if (locationStats.length >= 2) {
            const sorted = [...locationStats].sort((a, b) => b.convRate - a.convRate);
            const top = sorted[0];
            sorted.slice(1).forEach(loc => {
                const gap = top.convRate - loc.convRate;
                if (gap > 10 && loc.leads >= 20) {
                    const potentialConv = Math.round(loc.leads * (gap / 100));
                    gaps.push({
                        type: 'location',
                        label: loc.shortName,
                        current: loc.convRate.toFixed(0) + '%',
                        benchmark: top.convRate.toFixed(0) + '% (' + top.shortName + ')',
                        impact: `+${potentialConv} conv`,
                        impactNum: potentialConv,
                        gapPct: gap
                    });
                }
            });
        }

        // 3. Response Time Gap - slow responders losing conversions
        const slowLeads = leads.filter(l => {
            if (l.converted_status === 'Converted') return false;
            return l.first_response_hours && l.first_response_hours > 4;
        }).length;
        if (slowLeads > 10) {
            gaps.push({
                type: 'response',
                label: 'Slow Response (>4hrs)',
                current: slowLeads + ' leads',
                benchmark: '<2 hrs optimal',
                impact: `~${Math.round(slowLeads * 0.15)} conv`,
                impactNum: Math.round(slowLeads * 0.15),
                gapPct: 0
            });
        }

        // Sort by impact and take top 3
        gaps.sort((a, b) => b.impactNum - a.impactNum);

        if (gaps.length === 0) {
            container.innerHTML = '<div class="text-sm text-green-400">‚úì No significant gaps detected</div>';
            return;
        }

        container.innerHTML = gaps.slice(0, 3).map(g => {
            const icon = g.type === 'channel' ? 'üì¢' : g.type === 'location' ? 'üìç' : '‚è±Ô∏è';
            return `
                <div class="flex items-center gap-3 bg-slate-800/50 rounded-lg p-3">
                    <span class="text-lg">${icon}</span>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium text-white truncate">${g.label}</div>
                        <div class="text-xs text-slate-400">${g.current} ‚Üí ${g.benchmark}</div>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <div class="text-sm font-bold text-amber-400">${g.impact}</div>
                        <div class="text-xs text-slate-500">potential</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderWoWDelta(leads, customers) {
        // Calculate week-over-week changes
        const now = new Date();
        const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        const twoWeeksAgo = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);

        // This week's leads
        const thisWeekLeads = leads.filter(l => {
            const d = new Date(l.lead_create_time);
            return d >= oneWeekAgo && d <= now;
        });

        // Last week's leads
        const lastWeekLeads = leads.filter(l => {
            const d = new Date(l.lead_create_time);
            return d >= twoWeeksAgo && d < oneWeekAgo;
        });

        // Calculate metrics
        const thisWeekCount = thisWeekLeads.length;
        const lastWeekCount = lastWeekLeads.length;
        const leadsDelta = lastWeekCount > 0 ? ((thisWeekCount - lastWeekCount) / lastWeekCount * 100) : 0;

        const thisWeekConv = thisWeekLeads.filter(l => l.converted_status === 'Converted').length;
        const lastWeekConv = lastWeekLeads.filter(l => l.converted_status === 'Converted').length;
        const convDelta = lastWeekConv > 0 ? ((thisWeekConv - lastWeekConv) / lastWeekConv * 100) : 0;

        const thisWeekRate = thisWeekCount > 0 ? (thisWeekConv / thisWeekCount * 100) : 0;
        const lastWeekRate = lastWeekCount > 0 ? (lastWeekConv / lastWeekCount * 100) : 0;
        const rateDelta = thisWeekRate - lastWeekRate;

        // Revenue (estimate from customers converted this week)
        const thisWeekRevenue = customers
            .filter(c => c.converted_on && new Date(c.converted_on) >= oneWeekAgo)
            .reduce((s, c) => s + c.total_spend_12m, 0);
        const lastWeekRevenue = customers
            .filter(c => c.converted_on && new Date(c.converted_on) >= twoWeeksAgo && new Date(c.converted_on) < oneWeekAgo)
            .reduce((s, c) => s + c.total_spend_12m, 0);
        const revDelta = lastWeekRevenue > 0 ? ((thisWeekRevenue - lastWeekRevenue) / lastWeekRevenue * 100) : 0;

        // Helper to format delta
        const formatDelta = (val, isPercent = false) => {
            if (val === 0) return '<span class="text-slate-400">‚Äî</span>';
            const arrow = val > 0 ? '‚Üë' : '‚Üì';
            const color = val > 0 ? 'text-green-400' : 'text-red-400';
            const display = isPercent ? Math.abs(val).toFixed(0) + 'pp' : Math.abs(val).toFixed(0) + '%';
            return `<span class="${color}">${arrow} ${display}</span>`;
        };

        // Update DOM
        document.getElementById('wowLeadsValue').textContent = thisWeekCount;
        document.getElementById('wowLeadsDelta').innerHTML = formatDelta(leadsDelta);

        document.getElementById('wowConvValue').textContent = thisWeekConv;
        document.getElementById('wowConvDelta').innerHTML = formatDelta(convDelta);

        document.getElementById('wowRateValue').textContent = thisWeekRate.toFixed(0) + '%';
        document.getElementById('wowRateDelta').innerHTML = formatDelta(rateDelta, true);

        document.getElementById('wowRevValue').textContent = '$' + Math.round(thisWeekRevenue / 1000) + 'K';
        document.getElementById('wowRevDelta').innerHTML = formatDelta(revDelta);
    }

    function renderPerformanceVsTarget(leads, customers) {
        // Targets (could be configurable)
        const targets = {
            convRate: 25,
            revenue: 50000,
            responseTime: 2 // hours
        };

        // Calculate actuals
        const convRate = leads.length > 0 ? leads.filter(l => l.converted_status === 'Converted').length / leads.length * 100 : 0;
        const totalRevenue = customers.reduce((s, c) => s + c.total_spend_12m, 0);
        const monthlyRevenue = totalRevenue / 12; // Rough estimate

        // Calculate response times
        let avgResponseTime = 0;
        const leadsWithResponse = leads.filter(l => l.first_response_hours && l.first_response_hours > 0);
        if (leadsWithResponse.length > 0) {
            avgResponseTime = leadsWithResponse.reduce((s, l) => s + l.first_response_hours, 0) / leadsWithResponse.length;
        }

        // Update Conversion Rate
        document.getElementById('currentConvRate').textContent = convRate.toFixed(0) + '%';
        document.getElementById('convRateProgress').style.width = Math.min(convRate / targets.convRate * 100, 100) + '%';
        const convGap = targets.convRate - convRate;
        document.getElementById('convRateGap').textContent = convGap > 0 ? `${convGap.toFixed(0)}pp to target` : '‚úì On target';
        document.getElementById('convRateGap').className = `text-xs ${convGap > 0 ? 'text-amber-400' : 'text-green-400'}`;
        document.getElementById('convRateProjection').textContent = convGap > 5 ? 'Needs focus' : convGap > 0 ? 'Close to target' : 'Exceeding';

        // Update Revenue
        const revenueK = monthlyRevenue / 1000;
        const targetK = targets.revenue / 1000;
        document.getElementById('currentRevenue').textContent = '$' + Math.round(revenueK) + 'K';
        document.getElementById('targetRevenue').textContent = '$' + Math.round(targetK) + 'K';
        document.getElementById('revenueProgress').style.width = Math.min(revenueK / targetK * 100, 100) + '%';
        const revGap = targetK - revenueK;
        document.getElementById('revenueGap').textContent = revGap > 0 ? `$${Math.round(revGap)}K to target` : '‚úì Exceeding';
        document.getElementById('revenueGap').className = `text-xs ${revGap > 0 ? 'text-amber-400' : 'text-green-400'}`;
        document.getElementById('revenueProjection').textContent = revGap > 10 ? 'Needs acceleration' : revGap > 0 ? 'On track' : 'Strong';

        // Update Response Time
        document.getElementById('currentResponseTime').textContent = avgResponseTime > 0 ? avgResponseTime.toFixed(1) + ' hrs' : '-';
        const rtProgress = avgResponseTime > 0 ? Math.max(0, 100 - (avgResponseTime / targets.responseTime * 50)) : 50;
        document.getElementById('responseTimeProgress').style.width = rtProgress + '%';
        const rtStatus = avgResponseTime <= targets.responseTime ? '‚úì Within target' : `${(avgResponseTime - targets.responseTime).toFixed(1)} hrs over`;
        document.getElementById('responseTimeGap').textContent = rtStatus;
        document.getElementById('responseTimeGap').className = `text-xs ${avgResponseTime <= targets.responseTime ? 'text-green-400' : 'text-amber-400'}`;
        document.getElementById('responseTimeStatus').textContent = avgResponseTime <= 1 ? 'Excellent' : avgResponseTime <= targets.responseTime ? 'Good' : 'Needs improvement';
    }

    function renderPortfolioMatrix(leads, customers) {
        const container = document.getElementById('portfolioMatrixDots');
        if (!container) return;

        const stats = computeLocationStats(leads, customers);
        if (stats.length === 0) {
            container.innerHTML = '';
            return;
        }

        // Normalize values for positioning
        const maxLeads = Math.max(...stats.map(s => s.leads), 1);
        const maxConvRate = Math.max(...stats.map(s => s.convRate), 1);

        container.innerHTML = stats.map(s => {
            // X position: volume (leads) - 0 to 100%
            const xPct = Math.min((s.leads / maxLeads) * 90 + 5, 95);
            // Y position: health (conv rate) - inverted because CSS top is 0 at top
            const yPct = Math.max(95 - (s.convRate / maxConvRate) * 90, 5);

            // Color based on quadrant
            const isHighHealth = s.convRate >= 25;
            const isHighVolume = s.leads >= maxLeads * 0.4;
            let dotColor = 'bg-slate-400'; // default
            if (isHighHealth && isHighVolume) dotColor = 'bg-green-400'; // Star
            else if (isHighHealth && !isHighVolume) dotColor = 'bg-amber-400'; // High health, low volume
            else if (!isHighHealth && isHighVolume) dotColor = 'bg-red-400'; // Needs attention
            else dotColor = 'bg-blue-400'; // Emerging

            return `
                <div class="absolute w-4 h-4 rounded-full ${dotColor} border-2 border-white/30 cursor-pointer hover:scale-125 transition-transform flex items-center justify-center group"
                     style="left: ${xPct}%; top: ${yPct}%;"
                     onclick="showView('locations')">
                    <div class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-slate-800 px-2 py-1 rounded text-xs whitespace-nowrap opacity-0 group-hover:opacity-100 transition pointer-events-none z-10">
                        <div class="font-medium text-white">${s.shortName}</div>
                        <div class="text-slate-400">${s.leads} leads ¬∑ ${s.convRate.toFixed(0)}% conv</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderQuickPulse(leads, customers) {
        const leadTrendEl = document.getElementById('pulseLeadTrend');
        const convTrendEl = document.getElementById('pulseConvTrend');
        const topChannelEl = document.getElementById('pulseTopChannel');
        const alertCountEl = document.getElementById('pulseAlertCount');

        // Guard against missing elements
        if (!leadTrendEl || !convTrendEl || !topChannelEl || !alertCountEl) return;

        if (leads.length === 0) {
            leadTrendEl.textContent = '-';
            convTrendEl.textContent = '-';
            topChannelEl.textContent = '-';
            alertCountEl.textContent = '-';
            return;
        }

        // Lead Trend: compare first half vs second half of leads by date
        const sortedLeads = [...leads].sort((a, b) => new Date(a.lead_create_time) - new Date(b.lead_create_time));
        const midpoint = Math.floor(sortedLeads.length / 2);
        const firstHalfCount = midpoint;
        const secondHalfCount = sortedLeads.length - midpoint;
        const leadTrend = secondHalfCount > firstHalfCount * 1.1 ? 'üìà' : secondHalfCount < firstHalfCount * 0.9 ? 'üìâ' : '‚û°Ô∏è';
        leadTrendEl.textContent = leadTrend;

        // Conv Trend
        const firstHalfConv = sortedLeads.slice(0, midpoint).filter(l => l.converted_status === 'Converted').length;
        const secondHalfConv = sortedLeads.slice(midpoint).filter(l => l.converted_status === 'Converted').length;
        const firstHalfRate = midpoint > 0 ? firstHalfConv / midpoint * 100 : 0;
        const secondHalfRate = secondHalfCount > 0 ? secondHalfConv / secondHalfCount * 100 : 0;
        const convTrend = secondHalfRate > firstHalfRate + 2 ? 'üìà' : secondHalfRate < firstHalfRate - 2 ? 'üìâ' : '‚û°Ô∏è';
        convTrendEl.textContent = convTrend;

        // Top Channel
        const channelCounts = {};
        leads.forEach(l => {
            const ch = normalizeChannel(l.channel);
            channelCounts[ch] = (channelCounts[ch] || 0) + 1;
        });
        const sortedChannels = Object.entries(channelCounts).sort((a, b) => b[1] - a[1]);
        if (sortedChannels.length > 0) {
            const topCh = sortedChannels[0];
            const shortName = topCh[0].length > 8 ? topCh[0].substring(0, 7) + '‚Ä¶' : topCh[0];
            topChannelEl.innerHTML = `<span class="text-sm font-medium text-white">${shortName}</span>`;
        } else {
            topChannelEl.textContent = '-';
        }

        // Alert Count
        let alertCount = 0;
        const convRate = leads.length > 0 ? leads.filter(l => l.converted_status === 'Converted').length / leads.length * 100 : 0;
        if (convRate < 20 && leads.length >= 20) alertCount++;
        const paying = customers.filter(c => c.total_spend_12m > 0).length;
        const converted = leads.filter(l => l.converted_status === 'Converted').length;
        if (converted > 0 && paying / converted < 0.5) alertCount++;

        alertCountEl.innerHTML = alertCount === 0
            ? '<span class="text-green-400">‚úì</span>'
            : `<span class="text-red-400 font-bold">${alertCount}</span>`;
    }

    function renderTopGrowthDrivers(leads, customers) {
        const container = document.getElementById('topGrowthDrivers');
        if (!container) return;

        if (leads.length === 0) {
            container.innerHTML = '<div class="text-sm text-slate-500">Load data to see drivers...</div>';
            return;
        }

        const drivers = [];

        // Analyze channel performance
        const channelStats = {};
        leads.forEach(l => {
            const ch = normalizeChannel(l.channel);
            if (!channelStats[ch]) channelStats[ch] = { leads: 0, converted: 0 };
            channelStats[ch].leads++;
            if (l.converted_status === 'Converted') channelStats[ch].converted++;
        });

        const topChannel = Object.entries(channelStats)
            .filter(([, s]) => s.leads >= 5)
            .map(([ch, s]) => ({ channel: ch, rate: s.converted / s.leads * 100, leads: s.leads }))
            .sort((a, b) => b.rate - a.rate)[0];

        if (topChannel && topChannel.rate > 30) {
            drivers.push({
                icon: 'üéØ',
                title: `${topChannel.channel} channel`,
                detail: `${topChannel.rate.toFixed(0)}% conversion (${topChannel.leads} leads)`,
                impact: 'high'
            });
        }

        // Analyze location performance
        const locationStats = computeLocationStats(leads, customers);
        const topLoc = locationStats.sort((a, b) => b.convRate - a.convRate)[0];
        if (topLoc && topLoc.convRate > 25) {
            drivers.push({
                icon: 'üìç',
                title: topLoc.shortName,
                detail: `${topLoc.convRate.toFixed(0)}% conversion rate`,
                impact: 'high'
            });
        }

        // Analyze conversion speed
        const quickConversions = leads.filter(l => {
            if (l.converted_status !== 'Converted' || !l.conversion_time) return false;
            const days = (new Date(l.conversion_time) - new Date(l.lead_create_time)) / 86400000;
            return days <= 7;
        }).length;
        const quickRate = leads.filter(l => l.converted_status === 'Converted').length > 0
            ? quickConversions / leads.filter(l => l.converted_status === 'Converted').length * 100 : 0;
        if (quickRate > 40) {
            drivers.push({
                icon: '‚ö°',
                title: 'Fast response',
                detail: `${quickRate.toFixed(0)}% convert within 7 days`,
                impact: 'medium'
            });
        }

        if (drivers.length === 0) {
            container.innerHTML = '<div class="text-sm text-slate-500">No strong drivers identified yet</div>';
            return;
        }

        container.innerHTML = drivers.slice(0, 3).map(d => `
            <div class="flex items-center gap-3 bg-slate-800/50 rounded-lg p-3">
                <span class="text-lg">${d.icon}</span>
                <div class="flex-1">
                    <div class="text-sm font-medium text-white">${d.title}</div>
                    <div class="text-xs text-slate-400">${d.detail}</div>
                </div>
                <span class="px-2 py-0.5 rounded text-xs ${d.impact === 'high' ? 'bg-green-500/20 text-green-400' : 'bg-blue-500/20 text-blue-400'}">${d.impact}</span>
            </div>
        `).join('');
    }

    function renderLocationMaturityTable(leads, customers) {
        const container = document.getElementById('locationMaturityTable');
        if (!container) return;

        const stats = computeLocationStats(leads, customers);
        if (stats.length === 0) {
            container.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-slate-500">Load data to see locations...</td></tr>';
            return;
        }

        // Sort by conversion rate descending
        stats.sort((a, b) => b.convRate - a.convRate);

        container.innerHTML = stats.slice(0, 8).map(s => {
            const trendIcon = s.convRate >= 30 ? '‚Üë' : s.convRate >= 20 ? '‚Üí' : '‚Üì';
            const trendColor = s.convRate >= 30 ? 'text-green-400' : s.convRate >= 20 ? 'text-amber-400' : 'text-red-400';
            return `
                <tr class="border-b border-slate-700/50 hover:bg-slate-800/50 transition cursor-pointer" onclick="showView('locations');">
                    <td class="py-3 text-white">${s.shortName}</td>
                    <td class="py-3 text-right text-slate-300">${s.leads}</td>
                    <td class="py-3 text-right text-slate-300">${s.converted}</td>
                    <td class="py-3 text-right ${trendColor}">${s.convRate.toFixed(0)}%</td>
                    <td class="py-3 text-right ${trendColor}">${trendIcon}</td>
                </tr>
            `;
        }).join('');
    }

    function renderLocationBars(leads, customers) {
        const container = document.getElementById('locationBarsContainer');
        if (!container) return;

        const stats = computeLocationStats(leads, customers);
        if (stats.length === 0) {
            container.innerHTML = '<div class="text-xs text-slate-500">No location data</div>';
            return;
        }

        const maxConv = Math.max(...stats.map(s => s.convRate), 1);

        container.innerHTML = stats.slice(0, 5).map(s => `
            <div class="flex items-center gap-3">
                <div class="w-24 text-xs text-slate-400 truncate">${s.shortName}</div>
                <div class="flex-1 h-5 bg-slate-800 rounded overflow-hidden">
                    <div class="h-full rounded ${s.convRate >= 30 ? 'bg-green-500' : s.convRate >= 20 ? 'bg-amber-500' : 'bg-red-500'}"
                         style="width: ${s.convRate / maxConv * 100}%"></div>
                </div>
                <div class="w-12 text-xs text-right ${s.convRate >= 30 ? 'text-green-400' : s.convRate >= 20 ? 'text-amber-400' : 'text-red-400'}">${s.convRate.toFixed(0)}%</div>
            </div>
        `).join('');
    }

    function renderAlertsStrip(leads, customers) {
        const container = document.getElementById('alertsStrip');
        if (!container) return;

        const alerts = [];
        const convRate = leads.length > 0 ? leads.filter(l => l.converted_status === 'Converted').length / leads.length * 100 : 0;
        const converted = leads.filter(l => l.converted_status === 'Converted').length;
        const paying = customers.filter(c => c.total_spend_12m > 0).length;
        const customerToPaid = converted > 0 ? paying / converted * 100 : 100;

        if (convRate < 20 && leads.length >= 20) alerts.push({ type: 'danger', text: `Low conv: ${convRate.toFixed(0)}%` });
        if (customerToPaid < 50 && converted >= 10) alerts.push({ type: 'danger', text: `C‚ÜíP gap: ${customerToPaid.toFixed(0)}%` });

        const slowLeads = leads.filter(l => {
            const age = Math.floor((new Date() - new Date(l.lead_create_time)) / 86400000);
            return age > 3 && !l.log_type_count?.includes('MESSAGE:');
        }).length;
        if (slowLeads > 10) alerts.push({ type: 'warning', text: `${slowLeads} slow leads` });

        if (alerts.length === 0) {
            container.innerHTML = '<div class="text-xs text-green-400">‚úì No critical alerts</div>';
            return;
        }

        container.innerHTML = alerts.map(a => `
            <div class="flex-shrink-0 px-3 py-1.5 rounded-lg text-xs font-medium ${a.type === 'danger' ? 'bg-red-500/20 text-red-400' : 'bg-amber-500/20 text-amber-400'}">
                ${a.text}
            </div>
        `).join('');
    }

    function renderChannelMixChart(leads) {
        const ctx = document.getElementById('channelMixChart');
        if (!ctx) return;

        if (CHARTS.channelMix) CHARTS.channelMix.destroy();

        const channelCounts = {};
        leads.forEach(l => {
            const ch = normalizeChannel(l.channel);
            channelCounts[ch] = (channelCounts[ch] || 0) + 1;
        });

        const sorted = Object.entries(channelCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
        if (sorted.length === 0) return;

        CHARTS.channelMix = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: sorted.map(([ch]) => ch),
                datasets: [{
                    data: sorted.map(([, v]) => v),
                    backgroundColor: ['#3b82f6', '#8b5cf6', '#22c55e', '#f59e0b', '#6366f1'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    function renderTopDrivers(leads, customers) {
        const container = document.getElementById('topDrivers');

        if (leads.length === 0) {
            container.innerHTML = '<div class="text-slate-400 text-sm">No data available</div>';
            return;
        }

        const drivers = [];

        // Top Channel analysis with structural reason
        const topChannel = COMPUTED.channelMetrics.length > 0 ? COMPUTED.channelMetrics[0] : null;
        if (topChannel) {
            const channelInsight = topChannel.convRate > 30 ? 'High volume + strong conversion' :
                                   topChannel.convRate > 20 ? 'High volume, moderate conversion' :
                                   'High volume, low conversion (' + topChannel.convRate.toFixed(1) + '%)';
            drivers.push({
                conclusion: `Top Channel: ${topChannel.channel}`,
                factor: channelInsight
            });
        }

        // Best converting first service with reason
        const serviceConv = {};
        const serviceTotal = {};
        leads.forEach(l => {
            const svc = l.converted_first_service_type || 'Other';
            serviceTotal[svc] = (serviceTotal[svc] || 0) + 1;
            if (l.converted_status === 'Converted') {
                serviceConv[svc] = (serviceConv[svc] || 0) + 1;
            }
        });
        const serviceRates = Object.entries(serviceConv).map(([svc, conv]) => ({
            service: svc,
            conversions: conv,
            rate: (conv / (serviceTotal[svc] || 1) * 100)
        })).sort((a, b) => b.conversions - a.conversions);

        if (serviceRates.length > 0) {
            const top = serviceRates[0];
            drivers.push({
                conclusion: `Best First Service: ${top.service}`,
                factor: `Highest conversion to paid customers (${top.conversions})`
            });
        }

        // Revenue driver
        const boardingRev = customers.filter(c => c.had_boarding).reduce((s, c) => s + c.total_spend_12m, 0);
        const totalRev = customers.reduce((s, c) => s + c.total_spend_12m, 0);
        const boardingPct = totalRev > 0 ? (boardingRev / totalRev * 100).toFixed(0) : 0;

        if (boardingPct > 50) {
            drivers.push({
                conclusion: 'Revenue Growth',
                factor: `Driven by boarding-heavy mix (${boardingPct}% of revenue)`
            });
        } else {
            const multiService = customers.filter(c =>
                (c.had_boarding ? 1 : 0) + (c.had_daycare ? 1 : 0) + (c.had_grooming ? 1 : 0) >= 2
            ).length;
            const multiPct = customers.length > 0 ? (multiService / customers.length * 100).toFixed(0) : 0;
            drivers.push({
                conclusion: 'Revenue Growth',
                factor: multiPct > 30 ? `Multi-service customers (${multiPct}%) driving LTV` : 'Building service mix diversity'
            });
        }

        container.innerHTML = drivers.map(d => `
            <div class="bg-slate-800/50 rounded-lg p-3">
                <div class="text-sm font-medium text-white">${d.conclusion}</div>
                <div class="text-xs text-slate-400 mt-1">‚Üí ${d.factor}</div>
            </div>
        `).join('');
    }

    function renderAnomalyAlerts(leads, customers) {
        const container = document.getElementById('anomalyAlerts');
        const alerts = [];

        // Compute location-level data for alert targeting
        const locationStats = computeLocationStats(leads, customers);

        // Check conversion rate (Company level)
        const convRate = leads.length > 0 ? leads.filter(l => l.converted_status === 'Converted').length / leads.length * 100 : 0;
        if (convRate < 25) {
            alerts.push({
                type: 'warning',
                text: `Conversion rate at ${convRate.toFixed(1)}% (below 25% threshold)`,
                level: 'Company'
            });
        }

        // Check churn risk with location breakdown
        const atRisk = customers.filter(c => c.days_since_last > 60 && c.days_since_last <= 120);
        if (atRisk.length > 5) {
            // Find primary locations affected
            const locRisk = {};
            atRisk.forEach(c => {
                const loc = c.location?.replace('K9 Resorts - ', '') || 'Unknown';
                locRisk[loc] = (locRisk[loc] || 0) + 1;
            });
            const topLocs = Object.entries(locRisk).sort((a, b) => b[1] - a[1]).slice(0, 2).map(([l]) => l);

            alerts.push({
                type: 'danger',
                text: `${atRisk.length} customers at churn risk (60-120 days inactive)`,
                level: 'Location',
                locations: topLocs
            });
        }

        // Check for underperforming locations
        const lowConvLocs = locationStats.filter(l => l.convRate < 20 && l.leads >= 10);
        if (lowConvLocs.length > 0) {
            alerts.push({
                type: 'warning',
                text: `${lowConvLocs.length} location(s) below 20% conversion`,
                level: 'Location',
                locations: lowConvLocs.map(l => l.name.replace('K9 Resorts - ', ''))
            });
        }

        // Check unconverted leads aging
        const unconverted = leads.filter(l => !l.converted_status || l.converted_status !== 'Converted');
        const staleLeads = unconverted.filter(l => {
            const age = Math.floor((new Date() - new Date(l.lead_create_time)) / (1000 * 60 * 60 * 24));
            return age > 14 && age <= 30;
        });
        if (staleLeads.length > 15) {
            alerts.push({
                type: 'warning',
                text: `${staleLeads.length} leads aging 14-30 days without conversion`,
                level: 'Company'
            });
        }

        if (alerts.length === 0) {
            container.innerHTML = '<div class="bg-green-500/10 border border-green-500/30 rounded-lg p-3"><div class="text-sm text-green-400">‚úÖ No anomalies detected</div></div>';
        } else {
            container.innerHTML = alerts.map(a => `
                <div class="${a.type === 'danger' ? 'bg-red-500/10 border border-red-500/30' : 'bg-amber-500/10 border border-amber-500/30'} rounded-lg p-3">
                    <div class="flex items-start justify-between">
                        <div class="text-sm">${a.type === 'danger' ? 'üö®' : '‚ö†Ô∏è'} ${a.text}</div>
                        <span class="text-xs px-1.5 py-0.5 rounded ${a.level === 'Company' ? 'bg-blue-500/20 text-blue-400' : 'bg-purple-500/20 text-purple-400'}">${a.level}</span>
                    </div>
                    ${a.locations ? `<div class="text-xs text-slate-400 mt-1">üìç ${a.locations.join(', ')}</div>` : ''}
                </div>
            `).join('');
        }
    }

    // NEW: Compute location-level statistics
    function computeLocationStats(leads, customers) {
        const locMap = new Map();

        // Process leads by location
        leads.forEach(l => {
            const loc = l.company_name || 'Unknown';
            if (!locMap.has(loc)) {
                locMap.set(loc, { name: loc, leads: 0, converted: 0, customers: [], totalRev: 0, atRisk: 0 });
            }
            const stats = locMap.get(loc);
            stats.leads++;
            if (l.converted_status === 'Converted') {
                stats.converted++;
            }
        });

        // Add customer data
        customers.forEach(c => {
            const loc = c.location || 'Unknown';
            if (!locMap.has(loc)) {
                locMap.set(loc, { name: loc, leads: 0, converted: 0, customers: [], totalRev: 0, atRisk: 0 });
            }
            const stats = locMap.get(loc);
            stats.customers.push(c);
            stats.totalRev += c.total_spend_12m;
            if (c.days_since_last > 60 && c.days_since_last <= 120) {
                stats.atRisk++;
            }
        });

        // Calculate derived metrics
        return Array.from(locMap.values()).map(loc => ({
            ...loc,
            shortName: loc.name.replace('K9 Resorts Luxury Pet Hotel ', '').replace('K9 Resorts - ', '').replace('K9 Resort ', ''),
            convRate: loc.leads > 0 ? (loc.converted / loc.leads * 100) : 0,
            avgValue: loc.customers.length > 0 ? loc.totalRev / loc.customers.length : 0,
            status: getLocationStatus(loc)
        }));
    }

    function getLocationStatus(loc) {
        // Enterprise-safe maturity trajectory determination
        // Uses benchmark-relative language, not comparative rankings
        const highLeadsLowConv = loc.leads >= 20 && loc.convRate < 20;
        const highAtRisk = loc.atRisk > 5;
        const lowActivity = loc.leads < 5 && loc.customers.length < 10;

        // Maturity trajectory labels (enterprise-safe)
        if (loc.convRate >= 35 && loc.avgValue >= 250) return 'Exceeding Benchmark';
        if (loc.convRate >= 30 && loc.avgValue >= 200) return 'On Track';
        if (lowActivity) return 'Early Ramp';
        if (highAtRisk || (highLeadsLowConv && loc.convRate < 15)) return 'Needs Attention';
        if (highLeadsLowConv) return 'Building Momentum';
        return 'Maturing';
    }

    // Location Maturity Overview
    function renderLocationPerformance(leads, customers) {
        const tbody = document.getElementById('locationPerformanceTable');
        if (!tbody) return;

        const locationStats = computeLocationStats(leads, customers);

        if (locationStats.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-slate-400">No location data available</td></tr>';
            return;
        }

        // Select key locations to display (max 5):
        // Focus on trajectory diversity, not ranking
        const validLocs = locationStats.filter(l => l.leads >= 5);
        if (validLocs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-slate-400">Insufficient data for location analysis</td></tr>';
            return;
        }

        const byConvHigh = [...validLocs].sort((a, b) => b.convRate - a.convRate)[0];
        const byConvLow = [...validLocs].filter(l => l.leads >= 10).sort((a, b) => a.convRate - b.convRate)[0];
        const byRevenue = [...validLocs].sort((a, b) => b.totalRev - a.totalRev)[0];
        const needsAttention = [...validLocs].filter(l => l.status === 'Needs Attention').sort((a, b) => b.atRisk - a.atRisk)[0];

        // Deduplicate and tag with enterprise-safe language
        const selectedLocs = [];
        const addedNames = new Set();

        const addLoc = (loc, tag) => {
            if (loc && !addedNames.has(loc.name)) {
                selectedLocs.push({ ...loc, tag });
                addedNames.add(loc.name);
            }
        };

        addLoc(byConvHigh, 'Benchmark Leader');
        addLoc(byConvLow, 'Building Momentum');
        addLoc(byRevenue, 'Revenue Leader');
        addLoc(needsAttention, 'Focus Area');

        // If we have few locations, add remaining
        if (selectedLocs.length < 4) {
            validLocs.forEach(l => {
                if (selectedLocs.length < 5 && !addedNames.has(l.name)) {
                    selectedLocs.push({ ...l, tag: '' });
                    addedNames.add(l.name);
                }
            });
        }

        // Trajectory colors (maturity-based, not judgment-based)
        const statusColors = {
            'Exceeding Benchmark': 'bg-green-500/20 text-green-400',
            'On Track': 'bg-blue-500/20 text-blue-400',
            'Maturing': 'bg-slate-500/20 text-slate-300',
            'Building Momentum': 'bg-amber-500/20 text-amber-400',
            'Early Ramp': 'bg-purple-500/20 text-purple-400',
            'Needs Attention': 'bg-orange-500/20 text-orange-400'
        };

        tbody.innerHTML = selectedLocs.map(loc => `
            <tr class="border-b border-slate-700/50 hover:bg-slate-800/30 cursor-pointer">
                <td class="py-3 pr-4">
                    <div class="font-medium">${loc.name.replace('K9 Resorts - ', '')}</div>
                    ${loc.tag ? `<div class="text-xs text-slate-500">${loc.tag}</div>` : ''}
                </td>
                <td class="py-3 pr-4 text-right">${loc.leads}</td>
                <td class="py-3 pr-4 text-right">${loc.converted}</td>
                <td class="py-3 pr-4 text-right">${loc.convRate.toFixed(1)}%</td>
                <td class="py-3 pr-4 text-right">$${Math.round(loc.avgValue).toLocaleString()}</td>
                <td class="py-3 text-center">
                    <span class="px-2 py-1 rounded text-xs font-medium ${statusColors[loc.status] || 'bg-slate-500/20 text-slate-300'}">${loc.status}</span>
                </td>
            </tr>
        `).join('');
    }

    function renderGrowthTrendChart(leads) {
        const ctx = document.getElementById('growthTrendChart');
        if (!ctx) return;

        // Group leads by month
        const monthlyData = {};
        leads.forEach(l => {
            const month = l.lead_create_time?.substring(0, 7);
            if (!month) return;

            if (!monthlyData[month]) {
                monthlyData[month] = { leads: 0, converted: 0 };
            }
            monthlyData[month].leads++;
            if (l.converted_status === 'Converted') {
                monthlyData[month].converted++;
            }
        });

        const months = Object.keys(monthlyData).sort();
        const leadsData = months.map(m => monthlyData[m].leads);
        const convertedData = months.map(m => monthlyData[m].converted);

        if (CHARTS.growthTrend) CHARTS.growthTrend.destroy();

        CHARTS.growthTrend = new Chart(ctx, {
            type: 'line',
            data: {
                labels: months.map(m => {
                    const [y, mo] = m.split('-');
                    return new Date(y, mo - 1).toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                }),
                datasets: [
                    {
                        label: 'New Leads',
                        data: leadsData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Paid Customers',
                        data: convertedData,
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: '#94a3b8' } }
                },
                scales: {
                    x: { ticks: { color: '#64748b' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } },
                    y: { ticks: { color: '#64748b' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } }
                }
            }
        });
    }

    function renderFunnel() {
        const leads = getFilteredLeads();

        const totalLeads = leads.length;
        // Fix: log_type_count format is "MESSAGE:1, EMAIL:2" not just "MESSAGE"
        const contacted = leads.filter(l => {
            if (!l.log_type_count) return false;
            return l.log_type_count.includes('MESSAGE:') ||
                   l.log_type_count.includes('EMAIL:') ||
                   l.log_type_count.includes('CALL:') ||
                   l.log_type_count.includes('NOTE:');
        }).length;
        const booked = leads.filter(l => l.first_order_id && l.first_order_id !== '' && l.first_order_id !== '0').length;
        const paid = leads.filter(l => l.converted_status === 'Converted').length;

        // Qualified = Hot Lead + Prospect (leads with engagement signals)
        const qualified = leads.filter(l => {
            const lifecycle = (l.life_cycle || '').toLowerCase();
            return lifecycle === 'lead' || lifecycle === 'prospect' ||
                   l.action_state_name?.includes('Followup') ||
                   (l.log_type_count && l.log_type_count.includes('MESSAGE:'));
        }).length;

        // 1. Top KPI Strip
        document.getElementById('funnelLeads').textContent = totalLeads.toLocaleString();
        document.getElementById('funnelContacted').textContent = contacted.toLocaleString();
        document.getElementById('funnelBooked').textContent = booked.toLocaleString();
        document.getElementById('funnelPaid').textContent = paid.toLocaleString();

        // End-to-end conversion rate
        const endToEndRate = totalLeads > 0 ? (paid / totalLeads * 100).toFixed(1) : 0;
        document.getElementById('funnelEndToEnd').textContent = `${endToEndRate}% end-to-end`;

        // 2. Simplified Lead Conversion Funnel
        renderSimplifiedFunnel(totalLeads, qualified, paid);

        // 3. Sankey Diagram (new 3-layer: Total ‚Üí Channel ‚Üí Outcome)
        renderFunnelSankey(leads);

        // 4. Drop-off Chart
        renderDropoffChart(totalLeads, contacted, booked, paid);

        // 5. Time to Convert
        renderTimeToConvertChart(leads);

        // 5. First Service Distribution (converted only)
        renderFirstServiceChart(leads);

        // 6. Monthly Conversion Trend by Location
        renderMonthlyConversionTrend(leads);
    }

    function renderSimplifiedFunnel(totalLeads, qualified, converted) {
        const container = document.getElementById('simplifiedFunnel');
        if (!container) return;

        const maxHeight = 100;
        const totalHeight = maxHeight;
        const qualifiedHeight = totalLeads > 0 ? (qualified / totalLeads) * maxHeight : 0;
        const convertedHeight = totalLeads > 0 ? (converted / totalLeads) * maxHeight : 0;

        const qualifiedRate = totalLeads > 0 ? (qualified / totalLeads * 100).toFixed(0) : 0;
        const convertedRate = totalLeads > 0 ? (converted / totalLeads * 100).toFixed(0) : 0;

        container.innerHTML = `
            <div class="flex flex-col items-center">
                <div class="w-24 rounded-t-lg bg-blue-500" style="height: ${totalHeight}px;"></div>
                <div class="text-center mt-2">
                    <div class="text-lg font-bold">${totalLeads.toLocaleString()}</div>
                    <div class="text-xs text-slate-400">Total Leads</div>
                </div>
            </div>
            <div class="text-2xl text-slate-500">‚Üí</div>
            <div class="flex flex-col items-center">
                <div class="w-24 rounded-t-lg bg-purple-500" style="height: ${Math.max(qualifiedHeight, 10)}px;"></div>
                <div class="text-center mt-2">
                    <div class="text-lg font-bold">${qualified.toLocaleString()}</div>
                    <div class="text-xs text-slate-400">Qualified (${qualifiedRate}%)</div>
                </div>
            </div>
            <div class="text-2xl text-slate-500">‚Üí</div>
            <div class="flex flex-col items-center">
                <div class="w-24 rounded-t-lg bg-green-500" style="height: ${Math.max(convertedHeight, 10)}px;"></div>
                <div class="text-center mt-2">
                    <div class="text-lg font-bold">${converted.toLocaleString()}</div>
                    <div class="text-xs text-slate-400">Converted (${convertedRate}%)</div>
                </div>
            </div>
        `;
    }

    function renderFunnelSankey(leads) {
        const container = document.getElementById('funnelSankey');
        if (!container) return;
        container.innerHTML = '';

        const totalLeads = leads.length;
        if (totalLeads === 0) {
            container.innerHTML = '<div class="text-slate-400 text-center py-20">No data available</div>';
            return;
        }

        // Wait for container to have width (may be hidden initially)
        if (container.clientWidth === 0) {
            setTimeout(() => renderFunnelSankey(leads), 100);
            return;
        }

        // Group leads by channel (using the normalized channel function)
        const channelData = {};
        leads.forEach(l => {
            let channel = normalizeChannel(l.channel);
            // Map to Sankey channel names
            if (channel === 'Walk-in') channel = 'Manual';
            if (channel === 'Phone') channel = 'Manual';  // Merge into Manual Entry
            if (channel === 'Paid Social') channel = 'Inbound Form';
            if (channel === 'Google/Search') channel = 'Inbound Form';
            if (channel === 'Referral') channel = 'Other';
            if (channel === 'Unknown') channel = 'Other';

            if (!channelData[channel]) {
                channelData[channel] = { total: 0, converted: 0 };
            }
            channelData[channel].total++;
            if (l.converted_status === 'Converted') {
                channelData[channel].converted++;
            }
        });

        const width = container.clientWidth;
        const height = 380;

        const svg = d3.select(container)
            .append('svg')
            .attr('width', width)
            .attr('height', height);

        // Build 3-layer Sankey: Total Leads ‚Üí Channel ‚Üí Outcome
        const totalConverted = leads.filter(l => l.converted_status === 'Converted').length;
        const totalNotConverted = totalLeads - totalConverted;

        // Node indices:
        // 0: Total Leads
        // 1: Online Booking, 2: Manual, 3: Inbound Form, 4: Other
        // 5: Converted, 6: Not Converted
        const nodes = [
            { name: `Total Leads (${totalLeads.toLocaleString()})` },
            { name: `Online Booking (${channelData['Online Booking']?.total || 0})` },
            { name: `Manual (${channelData['Manual']?.total || 0})` },
            { name: `Inbound Form (${channelData['Inbound Form']?.total || 0})` },
            { name: `Other (${channelData['Other']?.total || 0})` },
            { name: `Converted (${totalConverted})` },
            { name: `Not Converted (${totalNotConverted})` }
        ];

        const links = [];

        // Layer 1 ‚Üí Layer 2: Total Leads ‚Üí Channels
        if (channelData['Online Booking']?.total > 0) links.push({ source: 0, target: 1, value: channelData['Online Booking'].total });
        if (channelData['Manual']?.total > 0) links.push({ source: 0, target: 2, value: channelData['Manual'].total });
        if (channelData['Inbound Form']?.total > 0) links.push({ source: 0, target: 3, value: channelData['Inbound Form'].total });
        if (channelData['Other']?.total > 0) links.push({ source: 0, target: 4, value: channelData['Other'].total });

        // Layer 2 ‚Üí Layer 3: Channels ‚Üí Outcome
        ['Online Booking', 'Manual', 'Inbound Form', 'Other'].forEach((ch, i) => {
            const data = channelData[ch];
            if (data && data.total > 0) {
                if (data.converted > 0) links.push({ source: i + 1, target: 5, value: data.converted });
                if (data.total - data.converted > 0) links.push({ source: i + 1, target: 6, value: data.total - data.converted });
            }
        });

        if (links.length === 0) {
            container.innerHTML = '<div class="text-slate-400 text-center py-20">No channel data available</div>';
            return;
        }

        const sankey = d3.sankey()
            .nodeWidth(20)
            .nodePadding(25)
            .extent([[40, 20], [width - 40, height - 40]]);

        const { nodes: sankeyNodes, links: sankeyLinks } = sankey({
            nodes: nodes.map(d => Object.assign({}, d)),
            links: links.map(d => Object.assign({}, d))
        });

        // ============================================
        // COLOR SEMANTIC SYSTEM (Critical)
        // ============================================
        // OUTCOME COLORS (Reserved - only for success/failure):
        const COLOR_CONVERTED = '#22c55e';      // Green = Success (only use of green)
        const COLOR_NOT_CONVERTED = '#ef4444';  // Red = Failure (only use of red)

        // CHANNEL COLORS (Neutral - no positive/negative meaning):
        const COLOR_TOTAL = '#64748b';          // Grey - neutral background
        const COLOR_ONLINE_BOOKING = '#3b82f6'; // Blue
        const COLOR_MANUAL = '#8b5cf6';         // Purple
        const COLOR_INBOUND_FORM = '#06b6d4';   // Teal
        const COLOR_OTHER = '#94a3b8';          // Grey (de-emphasized)

        // Get node color (channels = neutral, outcomes = semantic)
        const getNodeColor = (name) => {
            if (name.includes('Total Leads')) return COLOR_TOTAL;
            if (name.includes('Online Booking')) return COLOR_ONLINE_BOOKING;
            if (name.includes('Manual')) return COLOR_MANUAL;
            if (name.includes('Inbound Form')) return COLOR_INBOUND_FORM;
            if (name.includes('Other')) return COLOR_OTHER;
            if (name.includes('Converted') && !name.includes('Not')) return COLOR_CONVERTED;
            if (name.includes('Not Converted')) return COLOR_NOT_CONVERTED;
            return COLOR_TOTAL;
        };

        // Get FLOW color based on TARGET (outcome determines color)
        const getFlowColor = (link) => {
            const targetName = link.target.name;
            // Flows to Converted = Green
            if (targetName.includes('Converted') && !targetName.includes('Not')) {
                return COLOR_CONVERTED;
            }
            // Flows to Not Converted = Red
            if (targetName.includes('Not Converted')) {
                return COLOR_NOT_CONVERTED;
            }
            // Flows to channels = subtle grey (layer 1 ‚Üí layer 2)
            return 'rgba(148, 163, 184, 0.5)';
        };

        // Draw links (CRITICAL: color based on outcome, not source)
        svg.append('g')
            .selectAll('path')
            .data(sankeyLinks)
            .join('path')
            .attr('d', d3.sankeyLinkHorizontal())
            .attr('stroke', d => getFlowColor(d))
            .attr('stroke-width', d => Math.max(2, d.width))
            .attr('fill', 'none')
            .attr('opacity', d => {
                // Outcome flows more visible, background flows subtle
                const targetName = d.target.name;
                if (targetName.includes('Converted')) return 0.5;
                return 0.3;  // Layer 1‚Üí2 flows are subtle
            })
            .on('mouseover', function() { d3.select(this).attr('opacity', 0.8); })
            .on('mouseout', function(event, d) {
                const targetName = d.target.name;
                d3.select(this).attr('opacity', targetName.includes('Converted') ? 0.5 : 0.3);
            });

        // Draw nodes
        svg.append('g')
            .selectAll('rect')
            .data(sankeyNodes)
            .join('rect')
            .attr('x', d => d.x0)
            .attr('y', d => d.y0)
            .attr('height', d => Math.max(d.y1 - d.y0, 4))
            .attr('width', d => d.x1 - d.x0)
            .attr('fill', d => getNodeColor(d.name))
            .attr('rx', 3)
            .style('cursor', d => {
                // Only channel nodes are clickable
                if (d.name.includes('Online Booking') || d.name.includes('Manual') ||
                    d.name.includes('Inbound Form') || d.name.includes('Other')) {
                    return 'pointer';
                }
                return 'default';
            })
            .on('click', function(event, d) {
                // Drill-down to Channel ROI page for channel nodes
                if (d.name.includes('Online Booking') || d.name.includes('Manual') ||
                    d.name.includes('Inbound Form') || d.name.includes('Other')) {
                    showView('channels');
                }
            });

        // Draw labels
        svg.append('g')
            .selectAll('text')
            .data(sankeyNodes)
            .join('text')
            .attr('x', d => d.x0 < width / 3 ? d.x1 + 8 : (d.x0 > width * 2/3 ? d.x0 - 8 : (d.x0 + d.x1) / 2))
            .attr('y', d => (d.y1 + d.y0) / 2)
            .attr('dy', '0.35em')
            .attr('text-anchor', d => d.x0 < width / 3 ? 'start' : (d.x0 > width * 2/3 ? 'end' : 'middle'))
            .attr('fill', '#e2e8f0')
            .attr('font-size', '12px')
            .attr('font-weight', d => d.name.includes('Total') || d.name.includes('Converted') ? '600' : '400')
            .text(d => d.name);

        // Add conversion rate labels for channel nodes
        svg.append('g')
            .selectAll('text.rate')
            .data(sankeyNodes.filter(d => d.name.includes('Online Booking') || d.name.includes('Manual') ||
                                          d.name.includes('Inbound Form') || d.name.includes('Other')))
            .join('text')
            .attr('class', 'rate')
            .attr('x', d => (d.x0 + d.x1) / 2)
            .attr('y', d => d.y1 + 14)
            .attr('text-anchor', 'middle')
            .attr('fill', '#94a3b8')
            .attr('font-size', '10px')
            .text(d => {
                const channelName = d.name.split(' (')[0];
                const data = channelData[channelName];
                if (data && data.total > 0) {
                    return `${(data.converted / data.total * 100).toFixed(0)}% conv`;
                }
                return '';
            });
    }

    function renderDropoffChart(totalLeads, contacted, booked, paid) {
        const ctx = document.getElementById('dropoffChart');
        if (!ctx) return;

        // Calculate absolute losses at each stage
        const lostAtContact = totalLeads - contacted;
        const lostAtBook = contacted - booked;
        const lostAtPay = booked - paid;

        const dropoffs = [
            {
                stage: 'Lead ‚Üí Contact',
                rate: totalLeads > 0 ? (lostAtContact / totalLeads * 100) : 0,
                lost: lostAtContact
            },
            {
                stage: 'Contact ‚Üí Book',
                rate: contacted > 0 ? (lostAtBook / contacted * 100) : 0,
                lost: lostAtBook
            },
            {
                stage: 'Book ‚Üí Pay',
                rate: booked > 0 ? (lostAtPay / booked * 100) : 0,
                lost: lostAtPay
            }
        ];

        // Find the worst stage (highest drop-off)
        const worstStage = dropoffs.reduce((max, d) => d.rate > max.rate ? d : max, dropoffs[0]);

        if (CHARTS.dropoff) CHARTS.dropoff.destroy();

        // COLOR RULE: Drop-off uses Orange/Amber, NOT Red
        // Red is reserved for "Not Converted" outcome only
        // Use darker amber for worst stage, lighter for others
        CHARTS.dropoff = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dropoffs.map(d => `${d.stage}\n(${d.lost.toLocaleString()} lost)`),
                datasets: [{
                    label: 'Drop-off Rate',
                    data: dropoffs.map(d => d.rate),
                    backgroundColor: dropoffs.map(d =>
                        d.stage === worstStage.stage ? '#d97706' : '#f59e0b'  // Dark amber for worst, amber for others
                    ),
                    borderColor: dropoffs.map(d =>
                        d.stage === worstStage.stage ? '#b45309' : '#d97706'  // Darker borders
                    ),
                    borderWidth: 2
                }]
            },
            options: {
                indexAxis: 'y',  // Horizontal bars for better readability
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const d = dropoffs[ctx.dataIndex];
                                return `${d.rate.toFixed(1)}% lost (${d.lost.toLocaleString()} leads)`;
                            }
                        }
                    }
                },
                scales: {
                    y: { ticks: { color: '#e2e8f0', font: { size: 11 } }, grid: { display: false } },
                    x: {
                        ticks: {
                            color: '#64748b',
                            callback: v => v + '% lost'
                        },
                        grid: { color: 'rgba(148, 163, 184, 0.1)' },
                        max: 100
                    }
                }
            }
        });
    }

    function renderTimeToConvertChart(leads) {
        const ctx = document.getElementById('timeToConvertChart');
        if (!ctx) return;

        const convertedLeads = leads.filter(l => l.converted_status === 'Converted' && l.lead_create_time && l.converted_on);

        const timeBuckets = { '0-1 day': 0, '1-3 days': 0, '3-7 days': 0, '7-14 days': 0, '14-30 days': 0, '30+ days': 0 };

        convertedLeads.forEach(l => {
            const createDate = new Date(l.lead_create_time);
            const convDate = new Date(l.converted_on);
            const days = Math.floor((convDate - createDate) / (1000 * 60 * 60 * 24));

            if (days <= 1) timeBuckets['0-1 day']++;
            else if (days <= 3) timeBuckets['1-3 days']++;
            else if (days <= 7) timeBuckets['3-7 days']++;
            else if (days <= 14) timeBuckets['7-14 days']++;
            else if (days <= 30) timeBuckets['14-30 days']++;
            else timeBuckets['30+ days']++;
        });

        if (CHARTS.timeToConvert) CHARTS.timeToConvert.destroy();

        CHARTS.timeToConvert = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(timeBuckets),
                datasets: [{
                    label: 'Leads Converted',
                    data: Object.values(timeBuckets),
                    backgroundColor: '#3b82f6'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { ticks: { color: '#64748b' }, grid: { display: false } },
                    y: { ticks: { color: '#64748b' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } }
                }
            }
        });
    }

    function renderFirstServiceChart(leads) {
        const ctx = document.getElementById('firstServiceChart');
        if (!ctx) return;

        // Only count converted customers
        const convertedLeads = leads.filter(l => l.converted_status === 'Converted');
        const serviceCounts = {};
        convertedLeads.forEach(l => {
            const svc = l.converted_first_service_type || 'Other';
            serviceCounts[svc] = (serviceCounts[svc] || 0) + 1;
        });

        if (CHARTS.firstService) CHARTS.firstService.destroy();

        // Sort by count descending
        const sortedServices = Object.entries(serviceCounts)
            .sort((a, b) => b[1] - a[1]);

        CHARTS.firstService = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: sortedServices.map(([svc, count]) => `${svc} (${count})`),
                datasets: [{
                    data: sortedServices.map(([, count]) => count),
                    backgroundColor: ['#3b82f6', '#8b5cf6', '#22c55e', '#f59e0b', '#ef4444', '#ec4899']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { color: '#94a3b8', font: { size: 11 } }
                    },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const total = convertedLeads.length;
                                const value = ctx.raw;
                                const pct = total > 0 ? (value / total * 100).toFixed(1) : 0;
                                return `${value} customers (${pct}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    function renderMonthlyConversionTrend(leads) {
        const ctx = document.getElementById('monthlyConversionTrendChart');
        if (!ctx) return;

        // Group by month and location
        const monthlyData = {};
        const locations = new Set();

        leads.forEach(l => {
            const month = l.lead_create_time?.substring(0, 7);
            if (!month) return;

            const location = l.company_name?.replace('K9 Resorts - ', '').replace('K9 Resorts Luxury Pet Hotel ', '') || 'Unknown';
            locations.add(location);

            if (!monthlyData[month]) monthlyData[month] = {};
            if (!monthlyData[month][location]) monthlyData[month][location] = { leads: 0, converted: 0 };

            monthlyData[month][location].leads++;
            if (l.converted_status === 'Converted') {
                monthlyData[month][location].converted++;
            }
        });

        const months = Object.keys(monthlyData).sort();
        const locationList = Array.from(locations).filter(l => l !== 'Unknown').slice(0, 5);
        const colors = ['#3b82f6', '#8b5cf6', '#22c55e', '#f59e0b', '#ef4444'];

        if (CHARTS.monthlyConversionTrend) CHARTS.monthlyConversionTrend.destroy();

        CHARTS.monthlyConversionTrend = new Chart(ctx, {
            type: 'line',
            data: {
                labels: months.map(m => {
                    const [y, mo] = m.split('-');
                    return new Date(y, mo - 1).toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                }),
                datasets: locationList.map((loc, i) => ({
                    label: loc,
                    data: months.map(m => {
                        const data = monthlyData[m]?.[loc];
                        if (!data || data.leads === 0) return null;
                        return (data.converted / data.leads * 100).toFixed(1);
                    }),
                    borderColor: colors[i],
                    backgroundColor: 'transparent',
                    tension: 0.4,
                    spanGaps: true
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#94a3b8', boxWidth: 12 }
                    }
                },
                scales: {
                    x: { ticks: { color: '#64748b' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } },
                    y: {
                        ticks: {
                            color: '#64748b',
                            callback: v => v + '%'
                        },
                        grid: { color: 'rgba(148, 163, 184, 0.1)' },
                        title: { display: true, text: 'Conversion Rate', color: '#64748b' }
                    }
                }
            }
        });
    }

    // Track current trend metric
    let currentTrendMetric = 'leads';

    function setTrendMetric(metric) {
        currentTrendMetric = metric;
        document.getElementById('trendBtn-leads').className = metric === 'leads'
            ? 'px-3 py-1 text-xs rounded bg-blue-600 text-white'
            : 'px-3 py-1 text-xs rounded bg-slate-700 text-slate-300 hover:bg-slate-600';
        document.getElementById('trendBtn-revPerLead').className = metric === 'revPerLead'
            ? 'px-3 py-1 text-xs rounded bg-blue-600 text-white'
            : 'px-3 py-1 text-xs rounded bg-slate-700 text-slate-300 hover:bg-slate-600';
        renderChannelTrendChart();
    }

    function renderChannels() {
        const tbody = document.getElementById('channelTable');
        const leads = getFilteredLeads();
        const customers = getFilteredCustomers();

        if (leads.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="py-8 text-center text-slate-400">Load data to see channel ROI...</td></tr>';
            return;
        }

        // Recompute channel metrics based on filtered data
        const metrics = computeChannelMetricsFiltered(leads, customers);
        const validMetrics = metrics.filter(m => m.channel !== 'Unknown');

        // Update Summary Strip
        if (validMetrics.length > 0) {
            // Sort by revPerLead for rankings
            const sortedByROI = [...validMetrics].sort((a, b) => b.revPerLead - a.revPerLead);
            const topROI = sortedByROI[0];
            const highestValue = sortedByROI[0];  // Same as top ROI since that's our primary metric

            document.getElementById('topROIChannel').textContent = `${topROI.channel} ($${topROI.revPerLead.toFixed(0)}/lead)`;
            document.getElementById('highestValueChannel').textContent = `${highestValue.channel} ($${highestValue.revPerLead.toFixed(0)})`;
        }

        // Render table
        tbody.innerHTML = metrics.map(m => {
            const isUnknown = m.channel === 'Unknown';
            const rowClass = isUnknown ? 'opacity-50' : '';
            const qualityDisplay = m.qualityScore === '-' ? '-' : m.qualityScore;
            const qualityClass = isUnknown ? 'text-slate-500' :
                m.qualityScore >= 70 ? 'text-green-400' :
                m.qualityScore >= 40 ? 'text-amber-400' : 'text-red-400';

            return `
                <tr class="border-b border-slate-700/50 hover:bg-slate-800/30 ${rowClass}">
                    <td class="py-3 pr-4 font-medium">${m.channel}</td>
                    <td class="py-3 pr-4 text-right">${m.leads.toLocaleString()}</td>
                    <td class="py-3 pr-4 text-right">${m.convRate.toFixed(1)}%</td>
                    <td class="py-3 pr-4 text-right">$${m.revPerLead.toFixed(0)}</td>
                    <td class="py-3 pr-4 text-right">${m.retention90d.toFixed(0)}%</td>
                    <td class="py-3 pr-4 text-right">$${m.avgLTV.toFixed(0)}</td>
                    <td class="py-3 text-right ${qualityClass} font-bold">${qualityDisplay}</td>
                </tr>
            `;
        }).join('');

        // Channel scatter chart (ROI focus)
        renderChannelScatterChart(metrics.filter(m => m.channel !== 'Unknown'));

        // Channel trend chart
        renderChannelTrendChart();
    }

    function renderChannelScatterChart(metrics) {
        const ctx = document.getElementById('channelScatterChart');
        if (!ctx) return;

        if (CHARTS.channelScatter) CHARTS.channelScatter.destroy();

        // Color based on retention (high=green, low=orange)
        const getRetentionColor = (retention) => {
            if (retention >= 60) return 'rgba(34, 197, 94, 0.7)';   // Green
            if (retention >= 40) return 'rgba(59, 130, 246, 0.7)';  // Blue
            if (retention >= 20) return 'rgba(245, 158, 11, 0.7)';  // Amber
            return 'rgba(239, 68, 68, 0.7)';  // Red
        };

        const data = metrics.filter(m => m.leads > 0).map(m => ({
            x: m.leads,
            y: m.revPerLead,  // ‚≠ê PRIMARY KPI on Y-axis
            r: Math.max(8, Math.min(25, m.leads / 20)),  // Size = lead volume
            label: m.channel,
            retention: m.retention90d,
            backgroundColor: getRetentionColor(m.retention90d)
        }));

        CHARTS.channelScatter = new Chart(ctx, {
            type: 'bubble',
            data: {
                datasets: [{
                    label: 'Channels',
                    data: data,
                    backgroundColor: data.map(d => d.backgroundColor),
                    borderColor: data.map(d => d.backgroundColor.replace('0.7', '1')),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const d = data[ctx.dataIndex];
                                return [
                                    `${d.label}`,
                                    `Leads: ${d.x}`,
                                    `90D Rev/Lead: $${d.y.toFixed(0)}`,
                                    `Retention: ${d.retention.toFixed(0)}%`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'Lead Volume', color: '#64748b' },
                        ticks: { color: '#64748b' },
                        grid: { color: 'rgba(148, 163, 184, 0.1)' }
                    },
                    y: {
                        title: { display: true, text: '‚≠ê 90D Revenue / Lead ($)', color: '#f59e0b' },
                        ticks: {
                            color: '#64748b',
                            callback: v => '$' + v
                        },
                        grid: { color: 'rgba(148, 163, 184, 0.1)' }
                    }
                }
            }
        });
    }

    function renderChannelTrendChart() {
        const ctx = document.getElementById('channelTrendChart');
        if (!ctx) return;

        const leads = DATA.leads;  // Use all leads for trend
        const monthlyByChannel = {};
        const monthlyRevenueByChannel = {};

        leads.forEach(l => {
            const month = l.lead_create_time?.substring(0, 7);
            const channel = normalizeChannel(l.channel);
            if (!month || channel === 'Unknown') return;

            if (!monthlyByChannel[month]) {
                monthlyByChannel[month] = {};
                monthlyRevenueByChannel[month] = {};
            }

            monthlyByChannel[month][channel] = (monthlyByChannel[month][channel] || 0) + 1;

            // Track revenue for converted leads
            if (l.converted_status === 'Converted' && l.convert_to_customer_id) {
                const customer = COMPUTED.customerMap.get(l.convert_to_customer_id);
                if (customer) {
                    monthlyRevenueByChannel[month][channel] = (monthlyRevenueByChannel[month][channel] || 0) + customer.total_spend_12m;
                }
            }
        });

        const months = Object.keys(monthlyByChannel).sort();
        const allChannels = [...new Set(leads.map(l => normalizeChannel(l.channel)))].filter(c => c !== 'Unknown');

        // Sort channels by total leads
        const channelTotals = {};
        allChannels.forEach(ch => {
            channelTotals[ch] = months.reduce((sum, m) => sum + (monthlyByChannel[m]?.[ch] || 0), 0);
        });
        const channels = allChannels.sort((a, b) => channelTotals[b] - channelTotals[a]).slice(0, 5);

        const colors = ['#3b82f6', '#8b5cf6', '#22c55e', '#f59e0b', '#ef4444'];

        if (CHARTS.channelTrend) CHARTS.channelTrend.destroy();

        // Choose data based on toggle
        const isRevPerLead = currentTrendMetric === 'revPerLead';

        CHARTS.channelTrend = new Chart(ctx, {
            type: 'line',
            data: {
                labels: months.map(m => {
                    const [y, mo] = m.split('-');
                    return new Date(y, mo - 1).toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                }),
                datasets: channels.map((ch, i) => ({
                    label: ch,
                    data: months.map(m => {
                        if (isRevPerLead) {
                            const leads = monthlyByChannel[m]?.[ch] || 0;
                            const revenue = monthlyRevenueByChannel[m]?.[ch] || 0;
                            return leads > 0 ? revenue / leads : 0;
                        } else {
                            return monthlyByChannel[m]?.[ch] || 0;
                        }
                    }),
                    borderColor: colors[i],
                    backgroundColor: 'transparent',
                    tension: 0.4
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#94a3b8', boxWidth: 12, padding: 15 }
                    }
                },
                scales: {
                    x: { ticks: { color: '#64748b' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } },
                    y: {
                        ticks: {
                            color: '#64748b',
                            callback: v => isRevPerLead ? '$' + v.toFixed(0) : v
                        },
                        grid: { color: 'rgba(148, 163, 184, 0.1)' },
                        title: {
                            display: true,
                            text: isRevPerLead ? '90D Revenue / Lead ($)' : 'Lead Count',
                            color: '#64748b'
                        }
                    }
                }
            }
        });
    }

    function renderCustomers() {
        const customers = getFilteredCustomers();

        // Metrics
        document.getElementById('totalCustomers').textContent = customers.length.toLocaleString();

        const active = customers.filter(c => c.days_since_last <= 90).length;
        document.getElementById('activeCustomers').textContent = active.toLocaleString();

        const atRisk = customers.filter(c => c.days_since_last > 60 && c.days_since_last <= 120).length;
        document.getElementById('atRiskCustomers').textContent = atRisk.toLocaleString();

        // Calculate 90D average revenue per customer
        const avgRevenue90d = customers.length > 0
            ? customers.reduce((s, c) => s + c.total_spend_12m, 0) / customers.length
            : 0;
        document.getElementById('avgRevenue90d').textContent = '$' + Math.round(avgRevenue90d).toLocaleString();

        // PRIMARY: Revenue by Care Type (anchor chart)
        renderCareTypeRevenueChart(customers);

        // Segment Chart
        renderSegmentChart();

        // Service Mix √ó Value Lift Chart
        renderServiceMixChart(customers);

        // Frequency Distribution
        renderFrequencyChart(customers);

        // Churn Risk Table
        renderChurnRiskTable(customers);
    }

    function renderSegmentChart() {
        const ctx = document.getElementById('segmentChart');
        if (!ctx) return;

        if (CHARTS.segment) CHARTS.segment.destroy();

        CHARTS.segment = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: COMPUTED.segments.map(s => `${s.name} (${s.customers.length})`),
                datasets: [{
                    data: COMPUTED.segments.map(s => s.customers.length),
                    backgroundColor: COMPUTED.segments.map(s => s.color)
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { color: '#94a3b8' }
                    }
                }
            }
        });
    }

    // NEW: Revenue by Care Type (Primary Anchor Chart)
    function renderCareTypeRevenueChart(customers) {
        const ctx1 = document.getElementById('careTypeRevenueChart');
        const ctx2 = document.getElementById('careTypeBreakdownChart');
        if (!ctx1 || !ctx2) return;

        // Calculate revenue by care type
        const careTypes = {
            'Boarding': { revenue: 0, customers: 0, color: '#3b82f6' },
            'Daycare': { revenue: 0, customers: 0, color: '#8b5cf6' },
            'Grooming': { revenue: 0, customers: 0, color: '#06b6d4' },
            'Multi-Service': { revenue: 0, customers: 0, color: '#f59e0b' }
        };

        customers.forEach(c => {
            const serviceCount = (c.had_boarding ? 1 : 0) + (c.had_daycare ? 1 : 0) + (c.had_grooming ? 1 : 0);

            if (serviceCount >= 2) {
                careTypes['Multi-Service'].revenue += c.total_spend_12m;
                careTypes['Multi-Service'].customers++;
            } else if (c.had_boarding) {
                careTypes['Boarding'].revenue += c.total_spend_12m;
                careTypes['Boarding'].customers++;
            } else if (c.had_daycare) {
                careTypes['Daycare'].revenue += c.total_spend_12m;
                careTypes['Daycare'].customers++;
            } else if (c.had_grooming) {
                careTypes['Grooming'].revenue += c.total_spend_12m;
                careTypes['Grooming'].customers++;
            }
        });

        // Calculate avg revenue per customer for each type
        Object.keys(careTypes).forEach(k => {
            careTypes[k].avgRevenue = careTypes[k].customers > 0
                ? careTypes[k].revenue / careTypes[k].customers
                : 0;
        });

        // Filter out empty categories
        const activeTypes = Object.entries(careTypes).filter(([k, v]) => v.customers > 0);

        if (CHARTS.careTypeRevenue) CHARTS.careTypeRevenue.destroy();
        if (CHARTS.careTypeBreakdown) CHARTS.careTypeBreakdown.destroy();

        // LEFT: Horizontal bar showing total revenue by care type
        CHARTS.careTypeRevenue = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: activeTypes.map(([k]) => k),
                datasets: [{
                    label: 'Total Revenue',
                    data: activeTypes.map(([k, v]) => v.revenue),
                    backgroundColor: activeTypes.map(([k, v]) => v.color),
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const [k, v] = activeTypes[ctx.dataIndex];
                                return [
                                    `Revenue: $${Math.round(v.revenue).toLocaleString()}`,
                                    `Customers: ${v.customers}`,
                                    `Avg/Customer: $${Math.round(v.avgRevenue).toLocaleString()}`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: '#64748b',
                            callback: v => '$' + (v >= 1000 ? Math.round(v/1000) + 'k' : v)
                        },
                        grid: { color: 'rgba(148, 163, 184, 0.1)' }
                    },
                    y: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                }
            }
        });

        // RIGHT: Doughnut showing revenue distribution
        CHARTS.careTypeBreakdown = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: activeTypes.map(([k, v]) => `${k} (${Math.round(v.revenue / customers.reduce((s,c) => s + c.total_spend_12m, 0) * 100 || 0)}%)`),
                datasets: [{
                    data: activeTypes.map(([k, v]) => v.revenue),
                    backgroundColor: activeTypes.map(([k, v]) => v.color)
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { color: '#94a3b8', boxWidth: 12, padding: 8 }
                    },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const [k, v] = activeTypes[ctx.dataIndex];
                                return `$${Math.round(v.revenue).toLocaleString()}`;
                            }
                        }
                    }
                }
            }
        });

        // Update center text with total revenue
        const totalRevenue = customers.reduce((s, c) => s + c.total_spend_12m, 0);
        const centerEl = document.getElementById('donutTotalRevenue');
        if (centerEl) {
            centerEl.textContent = '$' + (totalRevenue >= 1000 ? Math.round(totalRevenue / 1000) + 'K' : Math.round(totalRevenue));
        }
    }

    // UPDATED: Service Mix √ó Value Lift (shows Avg Revenue per Customer)
    function renderServiceMixChart(customers) {
        const ctx = document.getElementById('serviceMixChart');
        if (!ctx) return;

        // Calculate AVG REVENUE PER CUSTOMER by service type (value lift analysis)
        const serviceGroups = {
            'Boarding Only': customers.filter(c => c.had_boarding && !c.had_daycare && !c.had_grooming),
            'Daycare Only': customers.filter(c => c.had_daycare && !c.had_boarding && !c.had_grooming),
            'Grooming Only': customers.filter(c => c.had_grooming && !c.had_boarding && !c.had_daycare),
            'Multi-Service': customers.filter(c =>
                (c.had_boarding ? 1 : 0) + (c.had_daycare ? 1 : 0) + (c.had_grooming ? 1 : 0) >= 2
            )
        };

        // Calculate average revenue per customer for each service type
        const labels = [];
        const avgRevenues = [];
        const counts = [];
        const colors = ['#3b82f6', '#8b5cf6', '#06b6d4', '#f59e0b'];

        Object.entries(serviceGroups).forEach(([name, group], idx) => {
            if (group.length > 0) {
                labels.push(name);
                const avgRev = group.reduce((s, c) => s + c.total_spend_12m, 0) / group.length;
                avgRevenues.push(avgRev);
                counts.push(group.length);
            }
        });

        if (CHARTS.serviceMix) CHARTS.serviceMix.destroy();

        CHARTS.serviceMix = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Avg Revenue/Customer',
                    data: avgRevenues,
                    backgroundColor: colors.slice(0, labels.length),
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                return [
                                    `Avg Revenue: $${Math.round(ctx.raw).toLocaleString()}`,
                                    `Customers: ${counts[ctx.dataIndex]}`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#64748b', maxRotation: 45 },
                        grid: { display: false }
                    },
                    y: {
                        ticks: {
                            color: '#64748b',
                            callback: v => '$' + v
                        },
                        grid: { color: 'rgba(148, 163, 184, 0.1)' },
                        title: {
                            display: true,
                            text: 'Avg Revenue/Customer',
                            color: '#64748b',
                            font: { size: 10 }
                        }
                    }
                }
            }
        });
    }

    function renderFrequencyChart(customers) {
        const ctx = document.getElementById('frequencyChart');
        if (!ctx) return;

        const freqBuckets = { '1 visit': 0, '2-3 visits': 0, '4-6 visits': 0, '7-12 visits': 0, '12+ visits': 0 };

        customers.forEach(c => {
            const v = c.visits_12m;
            if (v <= 1) freqBuckets['1 visit']++;
            else if (v <= 3) freqBuckets['2-3 visits']++;
            else if (v <= 6) freqBuckets['4-6 visits']++;
            else if (v <= 12) freqBuckets['7-12 visits']++;
            else freqBuckets['12+ visits']++;
        });

        if (CHARTS.frequency) CHARTS.frequency.destroy();

        CHARTS.frequency = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(freqBuckets),
                datasets: [{
                    label: 'Customers',
                    data: Object.values(freqBuckets),
                    backgroundColor: '#8b5cf6'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { ticks: { color: '#64748b' }, grid: { display: false } },
                    y: { ticks: { color: '#64748b' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } }
                }
            }
        });
    }

    function renderChurnRiskTable(customers) {
        const tbody = document.getElementById('churnRiskTable');

        // Find at-risk customers (60-180 days since last visit, any value)
        const atRisk = customers
            .filter(c => c.days_since_last > 60 && c.days_since_last <= 180 && c.total_spend_12m > 50)
            .sort((a, b) => b.total_spend_12m - a.total_spend_12m)
            .slice(0, 10);

        if (atRisk.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="py-8 text-center text-slate-400">No high-risk customers identified</td></tr>';
            return;
        }

        // SERVICE-AWARE, VALUE-AWARE recommendation generator
        function getSmartRecommendation(c) {
            const isHighValue = c.total_spend_12m >= 500;
            const isMidValue = c.total_spend_12m >= 100 && c.total_spend_12m < 500;
            const isMultiService = (c.had_boarding ? 1 : 0) + (c.had_daycare ? 1 : 0) + (c.had_grooming ? 1 : 0) >= 2;
            const daysSince = c.days_since_last;

            // HIGH VALUE CUSTOMERS ($500+)
            if (isHighValue) {
                if (isMultiService) {
                    if (daysSince > 120) return 'üìû VIP personal call: exclusive multi-service package offer';
                    return 'üìû VIP call: ask about upcoming travel plans, offer priority booking';
                }
                if (c.had_boarding) {
                    if (daysSince > 120) return 'üìû Personal call: 15% boarding discount + free bath upon return';
                    return 'üìß Email: Holiday boarding availability reminder';
                }
                if (c.had_daycare) {
                    if (daysSince > 120) return 'üìû Personal call: daycare package deal + complimentary grooming';
                    return 'üìß Email: New daycare enrichment activities announcement';
                }
                return 'üìû VIP outreach: understand needs, offer personalized package';
            }

            // MID VALUE CUSTOMERS ($100-500)
            if (isMidValue) {
                if (isMultiService) {
                    if (daysSince > 120) return 'üìß Win-back: 20% off next service + loyalty points bonus';
                    return 'üìß Cross-sell: Highlight services they haven\'t tried recently';
                }
                if (c.had_boarding) {
                    if (daysSince > 120) return 'üìß Win-back: $25 off next boarding stay';
                    return 'üì± SMS: Upcoming holiday boarding availability';
                }
                if (c.had_grooming) {
                    if (daysSince > 120) return 'üìß Win-back: Free nail trim with next grooming';
                    return 'üì± SMS: Seasonal grooming package reminder';
                }
                if (c.had_daycare) {
                    if (daysSince > 120) return 'üìß Win-back: Buy 5 daycare sessions, get 1 free';
                    return 'üì± SMS: New playgroup schedule announcement';
                }
                return 'üìß Re-engagement: Share new services & special offers';
            }

            // LOWER VALUE CUSTOMERS (<$100)
            if (c.had_grooming) {
                return 'üì± SMS: Grooming reminder with first-time multi-service discount';
            }
            if (c.had_boarding || c.had_daycare) {
                return 'üì± SMS: Daycare trial offer to increase engagement';
            }
            return 'üì± SMS: General re-engagement with intro offer';
        }

        tbody.innerHTML = atRisk.map(c => {
            const riskLevel = c.days_since_last > 120 ? 'High' : c.days_since_last > 90 ? 'Medium' : 'Watch';
            const riskColor = riskLevel === 'High' ? 'text-red-400' : riskLevel === 'Medium' ? 'text-amber-400' : 'text-yellow-400';
            const action = getSmartRecommendation(c);
            const valueTag = c.total_spend_12m >= 500 ? '<span class="px-1.5 py-0.5 bg-green-500/20 text-green-400 text-xs rounded mr-2">VIP</span>' :
                            c.total_spend_12m >= 100 ? '<span class="px-1.5 py-0.5 bg-blue-500/20 text-blue-400 text-xs rounded mr-2">Regular</span>' : '';

            return `
                <tr class="border-b border-slate-700/50 hover:bg-slate-800/30">
                    <td class="py-3 pr-4">${valueTag}${c.lead_name || 'Customer ' + c.customer_id}</td>
                    <td class="py-3 pr-4 text-slate-400">${c.location?.replace('K9 Resorts - ', '') || '-'}</td>
                    <td class="py-3 pr-4 text-right">$${c.total_spend_12m.toLocaleString()}</td>
                    <td class="py-3 pr-4 text-right">${c.visits_12m}</td>
                    <td class="py-3 pr-4 text-right">${c.days_since_last}</td>
                    <td class="py-3 pr-4 ${riskColor} font-medium">${riskLevel}</td>
                    <td class="py-3 text-sm text-slate-300">${action}</td>
                </tr>
            `;
        }).join('');
    }

    // ============================================
    // COHORT ANALYSIS - DECISION FOCUSED
    // ============================================
    let SELECTED_COHORT = null;
    let COHORT_BREAKDOWN_TAB = 'service';

    function renderCohorts() {
        // Recompute cohorts with location filter applied
        computeFilteredCohorts();

        if (COMPUTED.filteredCohorts.length === 0) {
            document.getElementById('cohortHealthCards').innerHTML = '<div class="text-slate-400 text-sm p-8 text-center col-span-4">Load data to see cohort analysis...</div>';
            return;
        }

        // Enrich cohorts with additional metrics for decision-making
        enrichCohortData();

        // Render all cohort sections
        renderCohortHealthCards();
        renderCohortActionsTable();
        renderCohortRawTable();

        // Select the most recent cohort by default
        if (COMPUTED.keyCohorts.length > 0 && !SELECTED_COHORT) {
            selectCohort(COMPUTED.keyCohorts[0].month);
        }
    }

    function computeFilteredCohorts() {
        // Get filtered customers based on location
        const filteredCustomers = getFilteredCustomers();

        // Group by cohort month
        const cohortMap = new Map();

        filteredCustomers.forEach(customer => {
            if (!customer.converted_on) return;

            const cohortMonth = customer.converted_on.substring(0, 7); // YYYY-MM

            if (!cohortMap.has(cohortMonth)) {
                cohortMap.set(cohortMonth, []);
            }
            cohortMap.get(cohortMonth).push(customer);
        });

        COMPUTED.filteredCohorts = Array.from(cohortMap.entries())
            .map(([month, customers]) => ({
                month,
                customers,
                count: customers.length,
                totalLTV: customers.reduce((sum, c) => sum + c.total_spend_12m, 0),
                avgLTV: customers.length > 0 ? customers.reduce((sum, c) => sum + c.total_spend_12m, 0) / customers.length : 0,
                retention: customers.length > 0 ? customers.filter(c => c.days_since_last <= 90).length / customers.length * 100 : 0
            }))
            .sort((a, b) => a.month.localeCompare(b.month));
    }

    function enrichCohortData() {
        // Enrich each cohort with breakdown data (use filtered cohorts)
        COMPUTED.filteredCohorts.forEach(cohort => {
            const customers = cohort.customers;

            // First Service breakdown
            cohort.serviceBreakdown = {
                'Boarding': customers.filter(c => c.first_service_type?.toLowerCase().includes('board')).length,
                'Daycare': customers.filter(c => c.first_service_type?.toLowerCase().includes('daycare') || c.first_service_type?.toLowerCase().includes('day care')).length,
                'Grooming': customers.filter(c => c.first_service_type?.toLowerCase().includes('groom')).length,
                'Other': customers.filter(c => {
                    const fst = c.first_service_type?.toLowerCase() || '';
                    return !fst.includes('board') && !fst.includes('daycare') && !fst.includes('day care') && !fst.includes('groom');
                }).length
            };

            // Channel breakdown
            cohort.channelBreakdown = {};
            customers.forEach(c => {
                const ch = normalizeChannel(c.channel);
                cohort.channelBreakdown[ch] = (cohort.channelBreakdown[ch] || 0) + 1;
            });

            // Location breakdown
            cohort.locationBreakdown = {};
            customers.forEach(c => {
                const loc = c.location?.replace('K9 Resorts - ', '') || 'Unknown';
                cohort.locationBreakdown[loc] = (cohort.locationBreakdown[loc] || 0) + 1;
            });

            // Multi-service rate
            cohort.multiServiceRate = customers.filter(c =>
                (c.had_boarding ? 1 : 0) + (c.had_daycare ? 1 : 0) + (c.had_grooming ? 1 : 0) >= 2
            ).length / customers.length * 100;

            // Avg first order value
            cohort.avgFirstOrder = customers.reduce((s, c) => s + (c.first_service_dollar || 0), 0) / customers.length;

            // Determine status
            cohort.status = getCohortStatus(cohort);

            // Generate insight
            cohort.insight = getCohortInsight(cohort);
        });

        // Identify key cohorts: Latest, Best, Worst (by composite score)
        const recentCohorts = COMPUTED.filteredCohorts.slice(-6);  // Only consider recent 6 months

        // Composite score: 50% retention + 30% LTV + 20% multi-service rate
        const scored = recentCohorts.map(c => ({
            ...c,
            score: (c.retention / 100 * 0.5) + (c.avgLTV / Math.max(...recentCohorts.map(x => x.avgLTV)) * 0.3) + (c.multiServiceRate / 100 * 0.2)
        })).sort((a, b) => b.score - a.score);

        const latest = COMPUTED.filteredCohorts[COMPUTED.filteredCohorts.length - 1];
        const best = scored[0];
        const worst = scored[scored.length - 1];

        // Build key cohorts array (deduplicated)
        COMPUTED.keyCohorts = [];
        const addedMonths = new Set();

        // Always add latest first
        COMPUTED.keyCohorts.push({ ...latest, label: 'Latest' });
        addedMonths.add(latest.month);

        // Add best if different
        if (!addedMonths.has(best.month)) {
            COMPUTED.keyCohorts.push({ ...best, label: 'Best Performing' });
            addedMonths.add(best.month);
        }

        // Add worst if different
        if (!addedMonths.has(worst.month)) {
            COMPUTED.keyCohorts.push({ ...worst, label: 'Needs Attention' });
            addedMonths.add(worst.month);
        }

        // Add one more if we have room (second best or second latest)
        if (COMPUTED.keyCohorts.length < 4 && recentCohorts.length > 3) {
            const secondLatest = COMPUTED.filteredCohorts[COMPUTED.filteredCohorts.length - 2];
            if (!addedMonths.has(secondLatest.month)) {
                COMPUTED.keyCohorts.push({ ...secondLatest, label: 'Previous' });
            }
        }
    }

    function getCohortStatus(cohort) {
        // Strong: High retention (>60%) AND decent LTV
        // Watch: Medium retention (40-60%) OR low multi-service
        // Risk: Low retention (<40%) OR very low LTV
        if (cohort.retention >= 60 && cohort.avgLTV >= 150) return 'Strong';
        if (cohort.retention < 40 || cohort.avgLTV < 80) return 'Risk';
        return 'Watch';
    }

    function getCohortInsight(cohort) {
        const insights = [];

        // Retention-based insights
        if (cohort.retention >= 70) {
            insights.push('High retention driven by');
        } else if (cohort.retention < 40) {
            insights.push('Low retention due to');
        } else {
            insights.push('Moderate performance with');
        }

        // Service-based reasoning
        const topService = Object.entries(cohort.serviceBreakdown).sort((a, b) => b[1] - a[1])[0];
        if (topService && topService[1] > cohort.count * 0.5) {
            insights.push(`${topService[0].toLowerCase()}-heavy entry`);
        } else if (cohort.multiServiceRate > 30) {
            insights.push('multi-service entry mix');
        } else {
            insights.push('single-service focus');
        }

        // Channel insight
        const topChannel = Object.entries(cohort.channelBreakdown).sort((a, b) => b[1] - a[1])[0];
        if (topChannel && topChannel[0] === 'Online Booking' && topChannel[1] > cohort.count * 0.4) {
            insights.push('(strong online booking)');
        } else if (topChannel && topChannel[0] === 'Walk-in' && topChannel[1] > cohort.count * 0.4) {
            insights.push('(walk-in dominant)');
        }

        return insights.join(' ');
    }

    function renderCohortHealthCards() {
        const container = document.getElementById('cohortHealthCards');
        if (!container) return;

        const statusColors = {
            'Strong': { bg: 'bg-green-500/10 border-green-500/30', text: 'text-green-400', badge: 'bg-green-500/20' },
            'Watch': { bg: 'bg-amber-500/10 border-amber-500/30', text: 'text-amber-400', badge: 'bg-amber-500/20' },
            'Risk': { bg: 'bg-red-500/10 border-red-500/30', text: 'text-red-400', badge: 'bg-red-500/20' }
        };

        container.innerHTML = COMPUTED.keyCohorts.map(cohort => {
            const colors = statusColors[cohort.status];
            const isSelected = SELECTED_COHORT === cohort.month;

            return `
                <div onclick="selectCohort('${cohort.month}')"
                     class="glass rounded-xl p-4 cursor-pointer transition-all border-2 ${isSelected ? 'border-blue-500 ring-2 ring-blue-500/20' : 'border-transparent hover:border-slate-600'}">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <span class="text-xs text-slate-400">${cohort.label}</span>
                            <div class="text-lg font-bold">${cohort.month}</div>
                        </div>
                        <span class="px-2 py-1 rounded text-xs font-medium ${colors.badge} ${colors.text}">${cohort.status}</span>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center mb-3">
                        <div>
                            <div class="text-xs text-slate-400">Customers</div>
                            <div class="font-semibold">${cohort.count}</div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-400">Avg LTV</div>
                            <div class="font-semibold">$${Math.round(cohort.avgLTV)}</div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-400">90D Ret.</div>
                            <div class="font-semibold ${cohort.retention >= 60 ? 'text-green-400' : cohort.retention < 40 ? 'text-red-400' : 'text-amber-400'}">${Math.round(cohort.retention)}%</div>
                        </div>
                    </div>
                    <div class="text-xs text-slate-300 italic border-t border-slate-700/50 pt-2">
                        ${cohort.insight}
                    </div>
                </div>
            `;
        }).join('');
    }

    function selectCohort(month) {
        SELECTED_COHORT = month;
        renderCohortHealthCards();  // Re-render to show selection
        renderCohortBreakdown();
    }

    function switchCohortBreakdownTab(tab) {
        COHORT_BREAKDOWN_TAB = tab;

        // Update tab styles
        document.querySelectorAll('.cohort-tab').forEach(t => {
            t.classList.remove('bg-blue-500/20', 'text-blue-400');
            t.classList.add('bg-slate-700/50', 'text-slate-400');
        });
        document.getElementById(`cohortTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.remove('bg-slate-700/50', 'text-slate-400');
        document.getElementById(`cohortTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('bg-blue-500/20', 'text-blue-400');

        renderCohortBreakdown();
    }

    function renderCohortBreakdown() {
        if (!SELECTED_COHORT) return;

        const cohort = COMPUTED.filteredCohorts.find(c => c.month === SELECTED_COHORT);
        if (!cohort) return;

        const ctx = document.getElementById('cohortBreakdownChart');
        const legendEl = document.getElementById('cohortBreakdownLegend');
        if (!ctx || !legendEl) return;

        let data, labels, colors, title;

        if (COHORT_BREAKDOWN_TAB === 'service') {
            data = cohort.serviceBreakdown;
            title = 'First Service Type';
            colors = { 'Boarding': '#3b82f6', 'Daycare': '#8b5cf6', 'Grooming': '#06b6d4', 'Other': '#94a3b8' };
        } else if (COHORT_BREAKDOWN_TAB === 'channel') {
            data = cohort.channelBreakdown;
            title = 'Entry Channel';
            colors = { 'Online Booking': '#3b82f6', 'Phone': '#8b5cf6', 'Walk-in': '#06b6d4', 'Paid Social': '#f59e0b', 'Unknown': '#94a3b8' };
        } else {
            data = cohort.locationBreakdown;
            title = 'Location Distribution';
            colors = {};
            const locColors = ['#3b82f6', '#8b5cf6', '#06b6d4', '#f59e0b', '#22c55e'];
            Object.keys(data).forEach((k, i) => colors[k] = locColors[i % locColors.length]);
        }

        // Filter out zeros
        const filteredData = Object.entries(data).filter(([k, v]) => v > 0);
        labels = filteredData.map(([k]) => k);
        const values = filteredData.map(([k, v]) => v);
        const chartColors = filteredData.map(([k]) => colors[k] || '#94a3b8');

        if (CHARTS.cohortBreakdown) CHARTS.cohortBreakdown.destroy();

        CHARTS.cohortBreakdown = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: chartColors
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '55%',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const pct = (ctx.raw / cohort.count * 100).toFixed(0);
                                return `${ctx.label}: ${ctx.raw} (${pct}%)`;
                            }
                        }
                    }
                }
            }
        });

        // Render custom legend with insights
        const total = values.reduce((s, v) => s + v, 0);
        legendEl.innerHTML = `
            <div class="text-sm font-medium mb-3">${title} for ${cohort.month}</div>
            <div class="space-y-2">
                ${filteredData.map(([k, v]) => `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded" style="background: ${colors[k] || '#94a3b8'}"></div>
                            <span class="text-slate-300">${k}</span>
                        </div>
                        <div class="text-slate-400">
                            <span class="font-medium text-white">${v}</span>
                            <span class="text-xs">(${(v / total * 100).toFixed(0)}%)</span>
                        </div>
                    </div>
                `).join('')}
            </div>
            <div class="mt-4 pt-3 border-t border-slate-700/50 text-xs text-slate-400">
                ${getBreakdownInsight(cohort, COHORT_BREAKDOWN_TAB, filteredData)}
            </div>
        `;
    }

    function getBreakdownInsight(cohort, tab, data) {
        const top = data.sort((a, b) => b[1] - a[1])[0];
        const topPct = (top[1] / cohort.count * 100).toFixed(0);

        if (tab === 'service') {
            if (top[0] === 'Grooming' && topPct > 50) {
                return `‚ö†Ô∏è Grooming-heavy cohort (${topPct}%) ‚Äî consider cross-sell to boarding/daycare`;
            }
            if (top[0] === 'Boarding' && topPct > 50) {
                return `‚úì Boarding-first cohort tends to have higher LTV`;
            }
            return `Mixed entry services ‚Äî ${top[0]} leads at ${topPct}%`;
        }

        if (tab === 'channel') {
            if (top[0] === 'Online Booking' && topPct > 50) {
                return `‚úì Strong online booking adoption (${topPct}%) ‚Äî typically higher retention`;
            }
            if (top[0] === 'Walk-in' && topPct > 40) {
                return `‚ö†Ô∏è Walk-in dominant (${topPct}%) ‚Äî opportunity to shift to online booking`;
            }
            return `${top[0]} is primary channel at ${topPct}%`;
        }

        return `${top[0]} has the largest share at ${topPct}%`;
    }

    function renderCohortActionsTable() {
        const tbody = document.getElementById('cohortActionsTable');
        if (!tbody) return;

        const statusColors = {
            'Strong': 'text-green-400',
            'Watch': 'text-amber-400',
            'Risk': 'text-red-400'
        };

        tbody.innerHTML = COMPUTED.keyCohorts.map(cohort => {
            const { risk, action } = getCohortAction(cohort);

            return `
                <tr class="border-b border-slate-700/50 hover:bg-slate-800/30">
                    <td class="py-3 pr-4 font-medium">${cohort.month}</td>
                    <td class="py-3 pr-4">
                        <span class="${statusColors[cohort.status]} font-medium">${cohort.status}</span>
                    </td>
                    <td class="py-3 pr-4 text-slate-300">${risk}</td>
                    <td class="py-3 text-sm">${action}</td>
                </tr>
            `;
        }).join('');
    }

    function getCohortAction(cohort) {
        // Rule-based action recommendations
        const isLowRetention = cohort.retention < 50;
        const isHighLTV = cohort.avgLTV >= 300;
        const isLowLTV = cohort.avgLTV < 100;
        const isSingleService = cohort.multiServiceRate < 20;
        const isMultiService = cohort.multiServiceRate >= 40;

        // Grooming-heavy check
        const groomingPct = (cohort.serviceBreakdown['Grooming'] || 0) / cohort.count * 100;
        const isGroomingHeavy = groomingPct > 50;

        // Walk-in heavy check
        const walkInPct = (cohort.channelBreakdown['Walk-in'] || 0) / cohort.count * 100;
        const isWalkInHeavy = walkInPct > 40;

        // Generate risk/opportunity and action
        if (isLowRetention && isSingleService) {
            return {
                risk: `Low retention (${Math.round(cohort.retention)}%) + single-service pattern`,
                action: 'üìß Cross-sell campaign: Introduce boarding/daycare to grooming-only customers'
            };
        }

        if (isHighLTV && isMultiService) {
            return {
                risk: `High-value multi-service customers ‚Äî retention opportunity`,
                action: 'üéÅ Offer membership/package deals to lock in loyalty'
            };
        }

        if (isGroomingHeavy && isLowLTV) {
            return {
                risk: `Grooming-only entry (${Math.round(groomingPct)}%) limiting LTV growth`,
                action: 'üì± "First Boarding" promo: $25 off first overnight stay'
            };
        }

        if (isWalkInHeavy) {
            return {
                risk: `Walk-in heavy (${Math.round(walkInPct)}%) ‚Äî lower digital engagement`,
                action: 'üì≤ Incentivize online booking: 10% off next visit for app download'
            };
        }

        if (isLowRetention) {
            return {
                risk: `Below-average retention (${Math.round(cohort.retention)}%)`,
                action: 'üìû Win-back outreach: Personal call + special return offer'
            };
        }

        if (cohort.status === 'Strong') {
            return {
                risk: `Strong cohort ‚Äî model for future acquisition`,
                action: 'üìä Analyze acquisition source to replicate success'
            };
        }

        return {
            risk: `Moderate performance ‚Äî room for improvement`,
            action: 'üìß General engagement: Share new services & seasonal offers'
        };
    }

    function renderCohortRawTable() {
        const container = document.getElementById('cohortRawTable');
        if (!container) return;

        const cohorts = COMPUTED.filteredCohorts.slice(-12);  // Last 12 months

        let html = `
            <table class="w-full text-sm">
                <thead>
                    <tr class="text-slate-400 text-left">
                        <th class="pb-3 pr-4">Cohort</th>
                        <th class="pb-3 pr-4 text-right">Customers</th>
                        <th class="pb-3 pr-4 text-right">Avg LTV</th>
                        <th class="pb-3 pr-4 text-right">90D Retention</th>
                        <th class="pb-3 pr-4 text-right">Multi-Service %</th>
                        <th class="pb-3 text-center">Status</th>
                    </tr>
                </thead>
                <tbody>
        `;

        const statusColors = {
            'Strong': 'bg-green-500/20 text-green-400',
            'Watch': 'bg-amber-500/20 text-amber-400',
            'Risk': 'bg-red-500/20 text-red-400'
        };

        cohorts.forEach(c => {
            html += `
                <tr class="border-b border-slate-700/50">
                    <td class="py-2 pr-4 font-medium">${c.month}</td>
                    <td class="py-2 pr-4 text-right">${c.count}</td>
                    <td class="py-2 pr-4 text-right">$${Math.round(c.avgLTV)}</td>
                    <td class="py-2 pr-4 text-right">${Math.round(c.retention)}%</td>
                    <td class="py-2 pr-4 text-right">${Math.round(c.multiServiceRate || 0)}%</td>
                    <td class="py-2 text-center">
                        <span class="px-2 py-0.5 rounded text-xs ${statusColors[c.status]}">${c.status}</span>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // ============================================
    // LOCATION DEEP DIVE
    // ============================================
    function renderLocationsView() {
        // Render the location charts when view is first loaded
        renderDeerfieldChart();
        renderLAXChart();
    }

    function switchLocationTab(tab) {
        // Update dropdown selector to match
        const selector = document.getElementById('locationInsightSelector');
        if (selector) {
            selector.value = tab;
        }

        // Show/hide sections
        document.querySelectorAll('.loc-section').forEach(s => s.classList.add('hidden'));
        document.getElementById(`loc-section-${tab}`).classList.remove('hidden');

        // Render chart for the active tab
        if (tab === 'deerfield') {
            renderDeerfieldChart();
        } else {
            renderLAXChart();
        }
    }

    let deerfieldChartInstance = null;
    let laxChartInstance = null;

    function renderDeerfieldChart() {
        const ctx = document.getElementById('deerfieldJourneyChart');
        if (!ctx) return;

        if (deerfieldChartInstance) {
            deerfieldChartInstance.destroy();
        }

        deerfieldChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan'],
                datasets: [{
                    label: 'Leads',
                    data: [119, 167, 29, 157, 99, 65, 81, 183, 65],
                    backgroundColor: 'rgba(59, 130, 246, 0.3)',
                    borderColor: 'rgb(59, 130, 246)',
                    borderWidth: 1,
                    yAxisID: 'y'
                }, {
                    label: 'Conversions',
                    data: [0, 0, 0, 1, 2, 1, 13, 56, 24],
                    backgroundColor: 'rgba(16, 185, 129, 0.7)',
                    borderColor: 'rgb(16, 185, 129)',
                    borderWidth: 1,
                    yAxisID: 'y'
                }, {
                    label: 'Conv Rate %',
                    data: [0, 0, 0, 0.6, 2.0, 1.5, 16.0, 30.6, 36.9],
                    type: 'line',
                    borderColor: 'rgb(245, 158, 11)',
                    backgroundColor: 'transparent',
                    borderWidth: 3,
                    yAxisID: 'y1',
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { color: '#94a3b8', boxWidth: 12, padding: 15 }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#64748b' },
                        grid: { color: 'rgba(148, 163, 184, 0.1)' }
                    },
                    y: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: 'Count', color: '#64748b' },
                        ticks: { color: '#64748b' },
                        grid: { color: 'rgba(148, 163, 184, 0.1)' }
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: 'Conv Rate %', color: '#64748b' },
                        ticks: { color: '#64748b' },
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });
    }

    function renderLAXChart() {
        const ctx = document.getElementById('laxMonthlyChart');
        if (!ctx) return;

        if (laxChartInstance) {
            laxChartInstance.destroy();
        }

        laxChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Sep*', 'Oct', 'Nov', 'Dec', 'Jan'],
                datasets: [{
                    label: 'Leads',
                    data: [43, 120, 124, 203, 121],
                    backgroundColor: 'rgba(147, 51, 234, 0.3)',
                    borderColor: 'rgb(147, 51, 234)',
                    borderWidth: 1,
                    yAxisID: 'y'
                }, {
                    label: 'Conversions',
                    data: [25, 18, 40, 52, 21],
                    backgroundColor: 'rgba(16, 185, 129, 0.7)',
                    borderColor: 'rgb(16, 185, 129)',
                    borderWidth: 1,
                    yAxisID: 'y'
                }, {
                    label: 'Conv Rate %',
                    data: [58.1, 15.0, 32.3, 25.6, 17.4],
                    type: 'line',
                    borderColor: 'rgb(245, 158, 11)',
                    backgroundColor: 'transparent',
                    borderWidth: 3,
                    yAxisID: 'y1',
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { color: '#94a3b8', boxWidth: 12, padding: 15 }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#64748b' },
                        grid: { color: 'rgba(148, 163, 184, 0.1)' }
                    },
                    y: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: 'Count', color: '#64748b' },
                        ticks: { color: '#64748b' },
                        grid: { color: 'rgba(148, 163, 184, 0.1)' }
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: 'Conv Rate %', color: '#64748b' },
                        ticks: { color: '#64748b' },
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });
    }

    // ============================================
    // AI INSIGHTS - ENTERPRISE GROWTH INTELLIGENCE
    // ============================================
    function renderInsights() {
        const leads = getFilteredLeads();
        const customers = getFilteredCustomers();
        const locationStats = computeLocationStats(leads, customers);

        // Compute risks and opportunities first (needed for verdict)
        const risks = computeGrowthRisks(leads, customers, locationStats);
        const opportunities = computeLeverageOpportunities(leads, customers, locationStats);

        // Section 1: AI Executive Verdict
        renderExecutiveVerdict(leads, customers, locationStats, risks, opportunities);

        // Section 2: Top Growth Risks (max 3, ranked)
        renderTopGrowthRisks(risks);

        // Section 3: Highest Leverage Opportunities (max 2)
        renderLeverageOpportunities(opportunities);

        // Section 4: AI-Recommended Actions
        renderRecommendedActionsEnterprise(leads, customers, locationStats, risks);

        // Section 5: Supporting Observations (collapsed)
        renderSupportingObservations(leads, customers, locationStats);

        // Section 6: Response Velocity Analysis
        renderVelocityAnalysis(leads, locationStats);
    }

    // ============================================
    // EXECUTIVE DECISION SURFACE - Core Compute Functions
    // ============================================

    function computeGrowthRisks(leads, customers, locationStats) {
        if (leads.length === 0) return [];

        const risks = [];

        // Risk 1: Manual channel scaling bottleneck
        const manualLeads = leads.filter(l =>
            normalizeChannel(l.channel) === 'Walk-in' || normalizeChannel(l.channel) === 'Phone'
        );
        const manualPct = manualLeads.length / leads.length * 100;
        const onlineLeads = leads.filter(l => normalizeChannel(l.channel) === 'Online Booking');
        const manualConv = manualLeads.length > 0 ?
            manualLeads.filter(l => l.converted_status === 'Converted').length / manualLeads.length * 100 : 0;
        const onlineConv = onlineLeads.length > 0 ?
            onlineLeads.filter(l => l.converted_status === 'Converted').length / onlineLeads.length * 100 : 0;

        if (manualPct > 50) {
            const convGap = onlineConv - manualConv;
            risks.push({
                id: 'channel-bottleneck',
                title: 'Manual Channel Bottleneck',
                explanation: 'Human-dependent lead processing limits scalability.',
                metrics: [
                    `${manualPct.toFixed(0)}% of leads via manual channels`,
                    convGap > 0 ? `${convGap.toFixed(0)}pp lower conversion vs online` : null
                ].filter(Boolean),
                impact: manualPct > 60 ? 'High' : 'Medium',
                priority: manualPct > 60 ? 1 : 2
            });
        }

        // Risk 2: Speed-to-lead failure
        const staleLeads = leads.filter(l => {
            if (l.converted_status === 'Converted') return false;
            const age = Math.floor((new Date() - new Date(l.lead_create_time)) / (1000 * 60 * 60 * 24));
            const hasContact = l.log_type_count && (l.log_type_count.includes('MESSAGE:') || l.log_type_count.includes('EMAIL:') || l.log_type_count.includes('CALL:'));
            return age > 3 && !hasContact;
        });
        const stalePct = staleLeads.length / leads.length * 100;

        if (stalePct > 15) {
            risks.push({
                id: 'speed-to-lead',
                title: 'Speed-to-Lead Failure',
                explanation: 'Delayed contact drops conversion probability by 50%+.',
                metrics: [
                    `${staleLeads.length} leads not contacted in 3+ days`,
                    `${stalePct.toFixed(0)}% of active pipeline affected`
                ],
                impact: stalePct > 25 ? 'High' : 'Medium',
                priority: stalePct > 25 ? 1 : 2
            });
        }

        // Risk 3: Single-service retention decay
        const groomingOnly = customers.filter(c => c.had_grooming && !c.had_boarding && !c.had_daycare);
        const groomingRetention = groomingOnly.length > 0 ?
            groomingOnly.filter(c => c.days_since_last <= 90).length / groomingOnly.length * 100 : 0;
        const groomingPct = customers.length > 0 ? groomingOnly.length / customers.length * 100 : 0;

        if (groomingPct > 30 && groomingRetention < 40) {
            risks.push({
                id: 'retention-decay',
                title: 'Single-Service Retention Decay',
                explanation: 'Grooming-only customers lack stickiness and will churn.',
                metrics: [
                    `${groomingOnly.length} grooming-only customers (${groomingPct.toFixed(0)}%)`,
                    `${groomingRetention.toFixed(0)}% retention rate (below 40% threshold)`
                ],
                impact: 'High',
                priority: 1
            });
        }

        // Risk 4: Customer ‚Üí Paid Conversion Gap (THREE-LAYER MODEL)
        // CRITICAL: Detects when converted customers are not monetizing
        const convertedCount = leads.filter(l => l.converted_status === 'Converted').length;
        const payingCount = customers.filter(c => c.total_spend_12m > 0).length;
        const customerToPaidRate = convertedCount > 0 ? payingCount / convertedCount * 100 : 100;

        if (customerToPaidRate < 70 && convertedCount >= 10) {
            const notPaying = convertedCount - payingCount;
            risks.push({
                id: 'conversion-gap',
                title: 'Customer ‚Üí Paid Conversion Gap',
                explanation: 'Converted customers are not completing transactions. Revenue leakage.',
                metrics: [
                    `${customerToPaidRate.toFixed(0)}% Customer ‚Üí Paid rate (target ‚â•70%)`,
                    `${notPaying} converted customers with $0 spend`
                ],
                impact: customerToPaidRate < 50 ? 'High' : 'Medium',
                priority: customerToPaidRate < 50 ? 1 : 2
            });
        }

        // Risk 5: Revenue concentration
        const topCustomers = [...customers].sort((a, b) => b.total_spend_12m - a.total_spend_12m);
        const top20Pct = Math.ceil(customers.length * 0.2);
        const top20Revenue = topCustomers.slice(0, top20Pct).reduce((s, c) => s + c.total_spend_12m, 0);
        const totalRevenue = customers.reduce((s, c) => s + c.total_spend_12m, 0);
        const top20Share = totalRevenue > 0 ? top20Revenue / totalRevenue * 100 : 0;

        if (top20Share > 70) {
            risks.push({
                id: 'revenue-concentration',
                title: 'Revenue Concentration Risk',
                explanation: 'Heavy reliance on top customers creates churn vulnerability.',
                metrics: [
                    `Top 20% customers = ${top20Share.toFixed(0)}% of revenue`,
                    `$${Math.round(top20Revenue).toLocaleString()} concentrated revenue`
                ],
                impact: 'Medium',
                priority: 3
            });
        }

        // Risk 6: Location conversion variance
        if (locationStats.length >= 2) {
            const convRates = locationStats.filter(l => l.leads >= 10).map(l => l.convRate);
            if (convRates.length >= 2) {
                const maxConv = Math.max(...convRates);
                const minConv = Math.min(...convRates);
                const variance = maxConv - minConv;

                if (variance > 20) {
                    risks.push({
                        id: 'location-variance',
                        title: 'Location Performance Variance',
                        explanation: 'Inconsistent operations across locations limiting enterprise conversion.',
                        metrics: [
                            `${variance.toFixed(0)}pp conversion spread across locations`,
                            `Best: ${maxConv.toFixed(0)}% vs Worst: ${minConv.toFixed(0)}%`
                        ],
                        impact: variance > 30 ? 'High' : 'Medium',
                        priority: 2
                    });
                }
            }
        }

        // Sort by priority
        return risks.sort((a, b) => a.priority - b.priority);
    }

    function computeLeverageOpportunities(leads, customers, locationStats) {
        if (leads.length === 0) return [];

        const opportunities = [];

        // Opportunity 1: Channel shift (addresses channel-bottleneck risk)
        const onlineBooking = COMPUTED.channelMetrics.find(c => c.channel === 'Online Booking');
        const manualChannels = COMPUTED.channelMetrics.filter(c => c.channel === 'Walk-in' || c.channel === 'Phone');
        const manualTotal = manualChannels.reduce((s, c) => s + c.leads, 0);
        const manualAvgConv = manualChannels.length > 0 ?
            manualChannels.reduce((s, c) => s + c.convRate * c.leads, 0) / manualTotal : 0;

        if (onlineBooking && manualTotal > 0 && onlineBooking.convRate > manualAvgConv) {
            const convLift = onlineBooking.convRate - manualAvgConv;
            const potentialConversions = Math.round(manualTotal * convLift / 100);
            const avgLTV = customers.length > 0 ?
                customers.reduce((s, c) => s + c.total_spend_12m, 0) / customers.length : 200;

            opportunities.push({
                id: 'channel-shift',
                addressesRisk: 'channel-bottleneck',
                condition: `Shift ${manualTotal} manual-channel leads to online booking`,
                outcome: `+${potentialConversions} conversions ‚Üí +$${Math.round(potentialConversions * avgLTV).toLocaleString()} revenue`,
                quantifiedUpside: `+${potentialConversions} customers`,
                logic: `${onlineBooking.convRate.toFixed(0)}% online conv vs ${manualAvgConv.toFixed(0)}% manual = ${convLift.toFixed(0)}pp lift`
            });
        }

        // Opportunity 2: Speed-to-lead SLA (addresses speed-to-lead risk)
        const staleLeads = leads.filter(l => {
            if (l.converted_status === 'Converted') return false;
            const age = Math.floor((new Date() - new Date(l.lead_create_time)) / (1000 * 60 * 60 * 24));
            const hasContact = l.log_type_count && (l.log_type_count.includes('MESSAGE:') || l.log_type_count.includes('EMAIL:') || l.log_type_count.includes('CALL:'));
            return age > 3 && !hasContact;
        });

        if (staleLeads.length > 10) {
            const estimatedRecovery = Math.round(staleLeads.length * 0.15); // 15% recovery with fast follow-up
            opportunities.push({
                id: 'speed-sla',
                addressesRisk: 'speed-to-lead',
                condition: `Implement 24-hour first-contact SLA for all new leads`,
                outcome: `Recover ${estimatedRecovery} leads ‚Üí prevent ${staleLeads.length} from going cold`,
                quantifiedUpside: `+${estimatedRecovery} recoverable leads`,
                logic: `Industry data: 15-20% lift from sub-24hr response`
            });
        }

        // Opportunity 3: Cross-sell to multi-service (addresses retention-decay risk)
        const crossSellPool = customers.filter(c => c.had_grooming && !c.had_boarding && c.days_since_last <= 90);
        if (crossSellPool.length >= 10) {
            const avgBoardingValue = 200;
            const targetConversion = 0.2;
            const potentialRevenue = Math.round(crossSellPool.length * targetConversion * avgBoardingValue);

            opportunities.push({
                id: 'cross-sell',
                addressesRisk: 'retention-decay',
                condition: `Launch boarding intro campaign to ${crossSellPool.length} active grooming-only customers`,
                outcome: `Convert 20% to multi-service ‚Üí +$${potentialRevenue.toLocaleString()} boarding revenue`,
                quantifiedUpside: `+$${potentialRevenue.toLocaleString()} revenue`,
                logic: `Multi-service customers show 2-3x higher retention`
            });
        }

        // Opportunity 4: Playbook replication (addresses location-variance risk)
        if (locationStats.length >= 2) {
            const bestLoc = locationStats.filter(l => l.leads >= 10).reduce((a, b) => a.convRate > b.convRate ? a : b, locationStats[0]);
            const otherLocs = locationStats.filter(l => l.name !== bestLoc.name && l.leads >= 10);
            const avgOtherConv = otherLocs.length > 0 ?
                otherLocs.reduce((s, l) => s + l.convRate, 0) / otherLocs.length : 0;
            const convGap = bestLoc.convRate - avgOtherConv;

            if (convGap > 10 && otherLocs.length > 0) {
                const totalOtherLeads = otherLocs.reduce((s, l) => s + l.leads, 0);
                const potentialConversions = Math.round(totalOtherLeads * (convGap * 0.5) / 100); // 50% of gap closeable

                opportunities.push({
                    id: 'playbook-replication',
                    addressesRisk: 'location-variance',
                    condition: `Replicate ${bestLoc.name.replace('K9 Resorts - ', '')} processes to other locations`,
                    outcome: `Close half the conversion gap ‚Üí +${potentialConversions} conversions`,
                    quantifiedUpside: `+${(convGap * 0.5).toFixed(0)}pp conversion lift`,
                    logic: `${bestLoc.name.replace('K9 Resorts - ', '')} at ${bestLoc.convRate.toFixed(0)}% vs ${avgOtherConv.toFixed(0)}% avg`
                });
            }
        }

        return opportunities;
    }

    // ============================================
    // EXECUTIVE DECISION SURFACE - Render Functions
    // ============================================

    function renderExecutiveVerdict(leads, customers, locationStats, risks, opportunities) {
        const verdictText = document.getElementById('verdictText');
        const verdictBadge = document.getElementById('verdictBadge');
        const verdictCard = document.getElementById('executiveVerdict');

        if (leads.length === 0) {
            verdictText.textContent = 'Load data to generate executive assessment...';
            verdictBadge.textContent = '‚Äî';
            verdictBadge.className = 'px-4 py-2 rounded-lg text-sm font-semibold bg-slate-700 text-slate-400';
            return;
        }

        // ============================================
        // THREE-LAYER METRICS FOR VERDICT
        // ============================================

        // Layer 1 ‚Üí Layer 2: Lead ‚Üí Customer Rate
        const convertedCount = leads.filter(l => l.converted_status === 'Converted').length;
        const leadToCustomerRate = leads.length > 0 ? convertedCount / leads.length * 100 : 0;

        // Layer 2 ‚Üí Layer 3: Customer ‚Üí Paid Rate
        const payingCount = customers.filter(c => c.total_spend_12m > 0).length;
        const customerToPaidRate = convertedCount > 0 ? payingCount / convertedCount * 100 : 0;

        // 90D Active Rate
        const activeCount = customers.filter(c => c.days_since_last <= 90).length;
        const activeRate = customers.length > 0 ? activeCount / customers.length * 100 : 0;

        // Count high-impact risks
        const highRisks = risks.filter(r => r.impact === 'High').length;

        // ============================================
        // VERDICT DETERMINATION (THREE-LAYER AWARE)
        // ============================================
        let verdict, status, borderColor, badgeColor;

        // At Risk: 2+ high risks OR critical paid conversion gap
        if (highRisks >= 2 || customerToPaidRate < 50) {
            status = 'At Risk';
            borderColor = 'border-red-500';
            badgeColor = 'bg-red-500/20 text-red-400';

            if (customerToPaidRate < 50) {
                verdict = `Critical: Customer ‚Üí Paid rate at ${customerToPaidRate.toFixed(0)}% (below 50% threshold). Converted customers are not monetizing.`;
            } else {
                const topRisk = risks[0];
                verdict = `Growth constrained by ${highRisks} critical issues. Priority: ${topRisk.title.toLowerCase()}.`;
            }
        }
        // Watch: 1 high risk OR below benchmarks
        else if (highRisks === 1 || leadToCustomerRate < 25 || customerToPaidRate < 70 || activeRate < 40) {
            status = 'Watch';
            borderColor = 'border-amber-500';
            badgeColor = 'bg-amber-500/20 text-amber-400';

            if (highRisks === 1) {
                const topRisk = risks[0];
                verdict = `On track with one constraint: ${topRisk.title.toLowerCase()}. Lead‚ÜíCustomer ${leadToCustomerRate.toFixed(0)}%, Customer‚ÜíPaid ${customerToPaidRate.toFixed(0)}%.`;
            } else if (customerToPaidRate < 70) {
                verdict = `Customer ‚Üí Paid rate at ${customerToPaidRate.toFixed(0)}% needs attention. ${convertedCount - payingCount} converted customers have not transacted.`;
            } else {
                verdict = `Metrics developing. Lead‚ÜíCustomer ${leadToCustomerRate.toFixed(0)}%, 90D Active ${activeRate.toFixed(0)}%.`;
            }
        }
        // Healthy: All metrics above threshold
        else if (leadToCustomerRate >= 30 && customerToPaidRate >= 70 && activeRate >= 50) {
            status = 'Healthy';
            borderColor = 'border-green-500';
            badgeColor = 'bg-green-500/20 text-green-400';

            if (opportunities.length > 0) {
                verdict = `Business healthy: ${leadToCustomerRate.toFixed(0)}% Lead‚ÜíCustomer, ${customerToPaidRate.toFixed(0)}% Customer‚ÜíPaid. Top opportunity: ${opportunities[0].condition.toLowerCase()}.`;
            } else {
                verdict = `Business healthy: ${leadToCustomerRate.toFixed(0)}% Lead‚ÜíCustomer, ${customerToPaidRate.toFixed(0)}% Customer‚ÜíPaid, ${activeRate.toFixed(0)}% 90D Active.`;
            }
        }
        // Default: Watch
        else {
            status = 'Watch';
            borderColor = 'border-amber-500';
            badgeColor = 'bg-amber-500/20 text-amber-400';
            verdict = `Metrics developing. Lead‚ÜíCustomer ${leadToCustomerRate.toFixed(0)}%, Customer‚ÜíPaid ${customerToPaidRate.toFixed(0)}%, 90D Active ${activeRate.toFixed(0)}%.`;
        }

        verdictText.textContent = verdict;
        verdictBadge.textContent = status;
        verdictBadge.className = `px-4 py-2 rounded-lg text-sm font-semibold ${badgeColor}`;
        verdictCard.className = `glass rounded-xl p-6 mb-6 border-l-4 ${borderColor}`;
    }

    function renderTopGrowthRisks(risks) {
        const container = document.getElementById('topGrowthRisks');

        if (risks.length === 0) {
            container.innerHTML = `
                <div class="text-center py-6">
                    <div class="text-green-400 font-medium">No Critical Risks Identified</div>
                    <div class="text-sm text-slate-500 mt-1">Operations are within healthy parameters</div>
                </div>
            `;
            return;
        }

        const impactStyles = {
            'High': 'bg-red-500/10 border-red-500/50 text-red-400',
            'Medium': 'bg-amber-500/10 border-amber-500/50 text-amber-400'
        };

        container.innerHTML = risks.slice(0, 3).map((risk, i) => `
            <div class="rounded-lg border ${impactStyles[risk.impact]} p-3">
                <div class="flex items-start justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <span class="w-5 h-5 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-white">${i + 1}</span>
                        <span class="font-medium text-white text-sm">${risk.title}</span>
                    </div>
                    <span class="text-xs px-1.5 py-0.5 rounded ${risk.impact === 'High' ? 'bg-red-500/20 text-red-400' : 'bg-amber-500/20 text-amber-400'}">${risk.impact}</span>
                </div>
                <p class="text-xs text-slate-400 mb-2 ml-7">${risk.explanation}</p>
                <div class="flex flex-wrap gap-1.5 ml-7">
                    ${risk.metrics.map(m => `<span class="text-xs px-1.5 py-0.5 rounded bg-slate-700/50 text-slate-300">${m}</span>`).join('')}
                </div>
            </div>
        `).join('');
    }

    function renderLeverageOpportunities(opportunities) {
        const container = document.getElementById('leverageOpportunities');

        if (opportunities.length === 0) {
            container.innerHTML = `
                <div class="text-center py-6">
                    <div class="text-slate-400">No high-leverage opportunities identified</div>
                    <div class="text-sm text-slate-500 mt-1">Continue current optimization efforts</div>
                </div>
            `;
            return;
        }

        container.innerHTML = opportunities.slice(0, 2).map(opp => `
            <div class="rounded-lg border border-green-500/30 bg-green-500/5 p-3">
                <div class="flex items-start justify-between mb-2">
                    <div class="text-xs font-medium text-slate-500 uppercase tracking-wide">If ‚Üí Then</div>
                    <span class="text-xs px-1.5 py-0.5 rounded bg-green-500/20 text-green-400 font-semibold">${opp.quantifiedUpside}</span>
                </div>
                <div class="space-y-1.5">
                    <div class="flex items-start gap-2">
                        <span class="text-green-400 font-bold text-xs">IF</span>
                        <span class="text-white text-sm">${opp.condition}</span>
                    </div>
                    <div class="flex items-start gap-2">
                        <span class="text-green-400 font-bold text-xs">‚Üí</span>
                        <span class="text-slate-300 text-sm">${opp.outcome}</span>
                    </div>
                </div>
                <div class="mt-2 pt-2 border-t border-slate-700/50">
                    <span class="text-xs text-slate-500">${opp.logic}</span>
                </div>
            </div>
        `).join('');
    }

    function renderSupportingObservations(leads, customers, locationStats) {
        const container = document.getElementById('supportingObservations');

        if (leads.length === 0) {
            container.innerHTML = '<div class="text-slate-400 text-sm">Load data to generate observations...</div>';
            return;
        }

        const observations = [];

        // Observation 1: Conversion pattern
        const convRate = leads.filter(l => l.converted_status === 'Converted').length / leads.length * 100;
        if (convRate > 35) {
            observations.push(`Strong conversion at ${convRate.toFixed(1)}% indicates healthy lead quality and follow-up processes.`);
        } else if (convRate < 20) {
            observations.push(`Conversion at ${convRate.toFixed(1)}% suggests lead qualification or follow-up improvements needed.`);
        }

        // Observation 2: Multi-service correlation
        const multiService = customers.filter(c =>
            (c.had_boarding ? 1 : 0) + (c.had_daycare ? 1 : 0) + (c.had_grooming ? 1 : 0) >= 2
        );
        const singleService = customers.filter(c =>
            (c.had_boarding ? 1 : 0) + (c.had_daycare ? 1 : 0) + (c.had_grooming ? 1 : 0) === 1
        );
        const multiRetention = multiService.length > 0 ?
            multiService.filter(c => c.days_since_last <= 90).length / multiService.length * 100 : 0;
        const singleRetention = singleService.length > 0 ?
            singleService.filter(c => c.days_since_last <= 90).length / singleService.length * 100 : 0;

        if (multiRetention > singleRetention + 15 && multiService.length >= 10) {
            observations.push(`Multi-service customers show ${Math.round(multiRetention - singleRetention)}pp higher retention (${multiRetention.toFixed(0)}% vs ${singleRetention.toFixed(0)}%).`);
        }

        // Observation 3: Channel ROI variance
        const channelsByROI = [...COMPUTED.channelMetrics].sort((a, b) => b.revPerLead - a.revPerLead);
        if (channelsByROI.length >= 2) {
            const best = channelsByROI[0];
            const worst = channelsByROI[channelsByROI.length - 1];
            if (best.revPerLead > worst.revPerLead * 2 && worst.leads > 20) {
                observations.push(`Channel ROI varies: ${best.channel} at $${Math.round(best.revPerLead)}/lead vs ${worst.channel} at $${Math.round(worst.revPerLead)}/lead.`);
            }
        }

        // Observation 4: Location patterns
        if (locationStats.length >= 2) {
            const topLoc = locationStats.reduce((a, b) => a.convRate > b.convRate ? a : b);
            observations.push(`Top performer: ${topLoc.name.replace('K9 Resorts - ', '')} at ${topLoc.convRate.toFixed(0)}% conversion.`);
        }

        if (observations.length === 0) {
            observations.push('Metrics are within expected ranges. Continue monitoring as data accumulates.');
        }

        container.innerHTML = observations.map(o => `
            <div class="text-sm text-slate-300 leading-relaxed py-2 border-l-2 border-slate-600 pl-4">
                ${o}
            </div>
        `).join('');
    }

    function renderVelocityAnalysis(leads, locationStats) {
        const container = document.getElementById('velocityAnalysisContainer');
        if (!container) return;

        if (leads.length === 0 || locationStats.length === 0) {
            container.innerHTML = '<div class="text-sm text-slate-500">Load data to see velocity analysis...</div>';
            return;
        }

        // Get top 2 locations by lead count
        const topLocs = locationStats.sort((a, b) => b.leads - a.leads).slice(0, 2);

        // Calculate velocity buckets for each location
        const velocityData = topLocs.map(loc => {
            const locLeads = leads.filter(l =>
                l.company_name === loc.name || l.business_location === loc.name
            ).filter(l => l.converted_status === 'Converted' && l.conversion_time);

            const buckets = {
                '<1 hour': { count: 0, color: 'bg-green-500' },
                '1-4 hrs': { count: 0, color: 'bg-green-400' },
                '4-24 hrs': { count: 0, color: 'bg-yellow-400' },
                '1-3 days': { count: 0, color: 'bg-orange-400' },
                '>3 days': { count: 0, color: 'bg-red-400' }
            };

            const convTimes = [];
            locLeads.forEach(l => {
                const hours = (new Date(l.conversion_time) - new Date(l.lead_create_time)) / (1000 * 60 * 60);
                convTimes.push(hours);

                if (hours < 1) buckets['<1 hour'].count++;
                else if (hours < 4) buckets['1-4 hrs'].count++;
                else if (hours < 24) buckets['4-24 hrs'].count++;
                else if (hours < 72) buckets['1-3 days'].count++;
                else buckets['>3 days'].count++;
            });

            // Calculate median
            convTimes.sort((a, b) => a - b);
            const median = convTimes.length > 0 ? convTimes[Math.floor(convTimes.length / 2)] : 0;
            const medianText = median < 1 ? `${Math.round(median * 60)} min` :
                              median < 24 ? `${median.toFixed(1)} hours` :
                              `${(median / 24).toFixed(1)} days`;

            const total = locLeads.length || 1;
            const bucketData = Object.entries(buckets).map(([label, data]) => ({
                label,
                pct: (data.count / total * 100).toFixed(1),
                color: data.color
            }));

            return {
                name: loc.shortName,
                median: medianText,
                medianHours: median,
                buckets: bucketData
            };
        });

        // Render two-column velocity comparison
        container.innerHTML = velocityData.map(loc => `
            <div>
                <div class="flex justify-between items-center mb-3">
                    <span class="font-medium text-white">${loc.name}</span>
                    <span class="text-sm ${loc.medianHours < 4 ? 'text-green-400' : loc.medianHours < 24 ? 'text-amber-400' : 'text-red-400'} font-semibold">Median: ${loc.median}</span>
                </div>
                <div class="space-y-2">
                    ${loc.buckets.map(b => `
                        <div class="flex items-center gap-3">
                            <span class="text-xs text-slate-400 w-16">${b.label}</span>
                            <div class="flex-1 h-4 bg-slate-800 rounded overflow-hidden">
                                <div class="h-full ${b.color} rounded" style="width: ${Math.min(b.pct, 100)}%"></div>
                            </div>
                            <span class="text-xs font-medium w-12 text-right">${b.pct}%</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    function renderRecommendedActionsEnterprise(leads, customers, locationStats, risks) {
        const container = document.getElementById('recommendedActions');

        if (leads.length === 0) {
            container.innerHTML = '<div class="text-slate-400 text-sm">Load data to generate action recommendations...</div>';
            return;
        }

        const actions = [];
        const riskIds = (risks || []).map(r => r.id);

        // Action 1: Online booking default (maps to channel-bottleneck)
        const manualPct = leads.filter(l =>
            normalizeChannel(l.channel) === 'Walk-in' || normalizeChannel(l.channel) === 'Phone'
        ).length / leads.length * 100;

        if (manualPct > 40) {
            actions.push({
                owner: 'Operations Lead',
                trigger: `${manualPct.toFixed(0)}% leads via manual channels`,
                action: 'Enable online booking as default entry point',
                outcome: 'Reduce manual dependency, improve scalability',
                mapsTo: riskIds.includes('channel-bottleneck') ? 'Channel Bottleneck' : null
            });
        }

        // Action 2: Speed-to-lead SLA (maps to speed-to-lead)
        const slowLeads = leads.filter(l => {
            if (l.converted_status === 'Converted') return false;
            const age = Math.floor((new Date() - new Date(l.lead_create_time)) / (1000 * 60 * 60 * 24));
            const hasContact = l.log_type_count && (l.log_type_count.includes('MESSAGE:') || l.log_type_count.includes('EMAIL:') || l.log_type_count.includes('CALL:'));
            return age > 3 && !hasContact;
        });

        if (slowLeads.length > 10) {
            actions.push({
                owner: 'Sales Manager',
                trigger: `${slowLeads.length} leads not contacted in 3+ days`,
                action: 'Implement 24-hour first-contact SLA with auto-escalation',
                outcome: '+15-20% conversion from faster response',
                mapsTo: riskIds.includes('speed-to-lead') ? 'Speed-to-Lead' : null
            });
        }

        // Action 3: Cross-sell campaign (maps to retention-decay)
        const crossSellPool = customers.filter(c => c.had_grooming && !c.had_boarding && c.days_since_last <= 90);
        if (crossSellPool.length >= 10) {
            actions.push({
                owner: 'Marketing Team',
                trigger: `${crossSellPool.length} active grooming-only customers`,
                action: 'Launch "First Boarding" campaign with intro offer',
                outcome: 'Convert 15-20% to multi-service, improve retention',
                mapsTo: riskIds.includes('retention-decay') ? 'Retention Decay' : null
            });
        }

        // Action 4: Churn prevention
        const churnRisk = customers.filter(c => c.days_since_last > 60 && c.days_since_last <= 120 && c.total_spend_12m > 200);
        if (churnRisk.length > 5) {
            const atRiskRevenue = Math.round(churnRisk.reduce((s,c) => s + c.total_spend_12m * 0.4, 0));
            actions.push({
                owner: 'Customer Success',
                trigger: `${churnRisk.length} high-value customers inactive 60-120d`,
                action: 'Personal outreach with loyalty reward + booking',
                outcome: `Retain $${atRiskRevenue.toLocaleString()} annual revenue`,
                mapsTo: null
            });
        }

        // Action 5: Location playbook (maps to location-variance)
        if (locationStats.length >= 2) {
            const lowConvLocs = locationStats.filter(l => l.convRate < 25 && l.leads >= 10);
            if (lowConvLocs.length > 0) {
                actions.push({
                    owner: 'Regional Manager',
                    trigger: `${lowConvLocs.length} location(s) below 25% conversion`,
                    action: 'Deploy top-performer playbook enterprise-wide',
                    outcome: 'Standardize operations, close conversion gap',
                    mapsTo: riskIds.includes('location-variance') ? 'Location Variance' : null
                });
            }
        }

        if (actions.length === 0) {
            actions.push({
                owner: 'Leadership',
                trigger: 'All metrics on track',
                action: 'Maintain current operations',
                outcome: 'Sustain healthy growth trajectory',
                mapsTo: null
            });
        }

        container.innerHTML = actions.slice(0, 4).map((a, i) => `
            <div class="bg-slate-800/50 rounded-lg p-4 ${a.mapsTo ? 'border-l-2 border-purple-500/50' : ''}">
                <div class="flex items-start gap-3">
                    <div class="w-6 h-6 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-xs font-bold flex-shrink-0">
                        ${i + 1}
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-medium text-white text-sm">${a.action}</div>
                            ${a.mapsTo ? `<span class="text-xs px-2 py-0.5 rounded bg-purple-500/20 text-purple-400">‚Üí ${a.mapsTo}</span>` : ''}
                        </div>
                        <div class="grid grid-cols-3 gap-3 text-xs">
                            <div>
                                <span class="text-slate-500 uppercase tracking-wide">Owner</span>
                                <div class="text-slate-300 mt-0.5">${a.owner}</div>
                            </div>
                            <div>
                                <span class="text-slate-500 uppercase tracking-wide">Trigger</span>
                                <div class="text-slate-300 mt-0.5">${a.trigger}</div>
                            </div>
                            <div>
                                <span class="text-slate-500 uppercase tracking-wide">Outcome</span>
                                <div class="text-green-400 mt-0.5">${a.outcome}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Keep these for backward compatibility but they're no longer used
    function renderNextBestLeads(leads) {
        const container = document.getElementById('nextBestLeads');
        if (!container) return;
    }

    function renderCrossSellOpps(customers) {
        const container = document.getElementById('crossSellOpps');
        if (!container) return;
    }

    // Legacy function - no longer needed
    function renderRecommendedActions(leads, customers) {
        // Deprecated - now using renderRecommendedActionsEnterprise
    }

    // Legacy render functions kept for compatibility
    function _legacyRenderCrossSellOpps(customers) {
        const opps = [
            {
                segment: 'Grooming to Boarding',
                count: customers.filter(c => c.had_grooming && !c.had_boarding).length,
                avgValue: '$150+',
                tactic: 'Holiday boarding packages'
            },
            {
                segment: 'Boarding to Daycare',
                count: customers.filter(c => c.had_boarding && !c.had_daycare).length,
                avgValue: '$200+/mo',
                tactic: 'Daycare membership trial'
            },
            {
                segment: 'Single to Multi-Pet',
                count: Math.round(customers.length * 0.15),
                avgValue: '2x LTV',
                tactic: 'Referral for second pet'
            }
        ].filter(o => o.count > 0);

        return opps.map(o => `
            <div class="bg-slate-800/50 rounded-lg p-3">
                <div class="flex justify-between items-start">
                    <div class="font-medium text-sm">${o.segment}</div>
                    <div class="text-green-400 text-sm">${o.count} customers</div>
                </div>
                <div class="text-xs text-slate-400 mt-2">
                    Potential: ${o.avgValue} ‚Ä¢ Tactic: ${o.tactic}
                </div>
            </div>
        `).join('');
    }

    // ============================================
    // GROWTH COPILOT
    // ============================================
    let COPILOT = {
        isOpen: false,
        currentContext: 'overview',
        contextLabels: {
            'overview': 'Growth Health',
            'funnel': 'Conversion Funnel',
            'channels': 'Channel Performance',
            'customers': 'Customer Value',
            'cohorts': 'Cohort Analysis',
            'insights': 'Decision Insights'
        }
    };

    function openCopilot(context) {
        COPILOT.isOpen = true;
        document.getElementById('copilotPanel').classList.add('open');
        document.getElementById('copilotOverlay').classList.add('open');

        // Update context based on current view
        const currentView = document.querySelector('.nav-tab.active')?.dataset?.view || 'overview';
        COPILOT.currentContext = context || currentView;
        document.getElementById('copilotContextLabel').textContent =
            COPILOT.contextLabels[COPILOT.currentContext] || 'Dashboard';
    }

    function closeCopilot() {
        COPILOT.isOpen = false;
        document.getElementById('copilotPanel').classList.remove('open');
        document.getElementById('copilotOverlay').classList.remove('open');
    }

    function explainSection(section) {
        openCopilot();

        // Set context label
        const sectionLabels = {
            'scorecard': 'Growth Health Scorecard',
            'drivers': 'Top Growth Drivers',
            'locations': 'Location Performance',
            'verdict': 'Executive Verdict',
            'risks': 'Growth Risks',
            'opportunities': 'Opportunities',
            'gaps': 'Performance Gaps',
            'wow': 'Week-over-Week Trends',
            'target': 'Performance vs Target',
            'portfolio': 'Location Portfolio Matrix'
        };
        document.getElementById('copilotContextLabel').textContent = sectionLabels[section] || section;

        // Generate contextual insight
        generateSectionInsight(section);
    }

    function askCopilot(actionType) {
        const responseArea = document.getElementById('copilotResponseArea');

        // Show typing indicator
        responseArea.innerHTML = `
            <div class="flex items-start gap-3 mb-4">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                </div>
                <div class="flex-1">
                    <div class="text-sm text-slate-400 mb-2">Analyzing your data...</div>
                    <div class="copilot-typing">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            </div>
        `;

        // Simulate brief delay then generate response
        setTimeout(() => {
            generateQuickActionResponse(actionType);
        }, 800);
    }

    function generateQuickActionResponse(actionType) {
        const leads = getFilteredLeads();
        const customers = getFilteredCustomers();
        const responseArea = document.getElementById('copilotResponseArea');

        let response = {};

        switch(actionType) {
            case 'summary':
                response = generateExecutiveSummary(leads, customers);
                break;
            case 'blockers':
                response = generateBlockersAnalysis(leads, customers);
                break;
            case 'opportunities':
                response = generateQuickWins(leads, customers);
                break;
            case 'comparison':
                response = generateLocationComparison(leads, customers);
                break;
            default:
                response = {
                    answer: "I couldn't understand that request. Please try one of the quick actions.",
                    evidence: [],
                    interpretation: ""
                };
        }

        renderCopilotResponse(response);
    }

    function generateExecutiveSummary(leads, customers) {
        const totalLeads = leads.length;
        const converted = leads.filter(l => l.converted_status === 'Converted').length;
        const paying = customers.filter(c => c.total_spend_12m > 0).length;
        const leadToCustomer = totalLeads > 0 ? (converted / totalLeads * 100).toFixed(1) : 0;
        const customerToPaid = converted > 0 ? (paying / converted * 100).toFixed(1) : 0;
        const active90d = customers.filter(c => c.days_since_last <= 90).length;
        const activeRate = customers.length > 0 ? (active90d / customers.length * 100).toFixed(0) : 0;

        // Determine overall health
        let healthStatus = 'stable';
        let healthColor = 'text-blue-400';
        if (leadToCustomer >= 35 && customerToPaid >= 75 && activeRate >= 60) {
            healthStatus = 'strong';
            healthColor = 'text-green-400';
        } else if (leadToCustomer < 20 || customerToPaid < 50 || activeRate < 40) {
            healthStatus = 'needs attention';
            healthColor = 'text-amber-400';
        }

        return {
            answer: `Your growth engine is <span class="${healthColor} font-semibold">${healthStatus}</span>. You have ${totalLeads.toLocaleString()} leads with a ${leadToCustomer}% conversion to customer, and ${customerToPaid}% of those customers have made purchases.`,
            evidence: [
                `${totalLeads.toLocaleString()} total leads in selected period`,
                `${converted.toLocaleString()} converted to customers (${leadToCustomer}%)`,
                `${paying.toLocaleString()} are paying customers (${customerToPaid}% of converted)`,
                `${activeRate}% customer active rate (90-day)`
            ],
            interpretation: leadToCustomer < 30
                ? "Your lead-to-customer conversion is below benchmark (30%). Focus on lead follow-up speed and qualification."
                : customerToPaid < 70
                    ? "Converted customers aren't completing purchases. Review onboarding friction and first-visit experience."
                    : "Maintain current acquisition momentum while optimizing retention programs.",
            action: healthStatus === 'needs attention'
                ? "Prioritize: Review your speed-to-lead metrics and implement 24-hour contact SLA."
                : null
        };
    }

    function generateBlockersAnalysis(leads, customers) {
        const blockers = [];

        // Check speed-to-lead
        const slowLeads = leads.filter(l => {
            const age = Math.floor((new Date() - new Date(l.lead_create_time)) / (1000 * 60 * 60 * 24));
            const hasContact = l.log_type_count && (l.log_type_count.includes('MESSAGE:') || l.log_type_count.includes('EMAIL:') || l.log_type_count.includes('CALL:'));
            return age > 3 && !hasContact;
        });
        if (slowLeads.length > 5) {
            blockers.push({
                issue: 'Slow Lead Response',
                impact: 'High',
                detail: `${slowLeads.length} leads not contacted within 3 days`,
                fix: 'Implement automated lead assignment and 24-hour SLA'
            });
        }

        // Check conversion gap
        const converted = leads.filter(l => l.converted_status === 'Converted').length;
        const paying = customers.filter(c => c.total_spend_12m > 0).length;
        if (converted > 10 && paying / converted < 0.6) {
            const gap = converted - paying;
            blockers.push({
                issue: 'Customer ‚Üí Paid Leakage',
                impact: 'High',
                detail: `${gap} converted customers have $0 spend`,
                fix: 'Review onboarding flow and first-appointment booking friction'
            });
        }

        // Check retention
        const churned = customers.filter(c => c.days_since_last > 90 && c.total_spend_12m > 100).length;
        if (churned > customers.length * 0.2) {
            blockers.push({
                issue: 'Retention Decay',
                impact: 'Medium',
                detail: `${churned} valuable customers inactive 90+ days`,
                fix: 'Launch win-back campaign with personalized offers'
            });
        }

        // Check channel quality
        const leadsBySource = {};
        leads.forEach(l => {
            const src = l.lead_source || 'Unknown';
            if (!leadsBySource[src]) leadsBySource[src] = { total: 0, converted: 0 };
            leadsBySource[src].total++;
            if (l.converted_status === 'Converted') leadsBySource[src].converted++;
        });

        Object.entries(leadsBySource).forEach(([src, data]) => {
            if (data.total >= 20 && data.converted / data.total < 0.1) {
                blockers.push({
                    issue: `Low-Quality Channel: ${src}`,
                    impact: 'Medium',
                    detail: `${data.total} leads, only ${(data.converted/data.total*100).toFixed(0)}% convert`,
                    fix: 'Reallocate budget to higher-converting channels'
                });
            }
        });

        if (blockers.length === 0) {
            return {
                answer: "No critical growth blockers detected. Your funnel appears healthy.",
                evidence: [
                    "Lead response time within acceptable range",
                    "Conversion rates meeting benchmarks",
                    "No significant channel quality issues"
                ],
                interpretation: "Focus on optimization and scaling rather than fixing fundamentals."
            };
        }

        const topBlocker = blockers.sort((a,b) => a.impact === 'High' ? -1 : 1)[0];

        return {
            answer: `Found <span class="text-amber-400 font-semibold">${blockers.length} growth blockers</span>. Top issue: ${topBlocker.issue} (${topBlocker.impact} impact).`,
            evidence: blockers.map(b => `<strong>${b.issue}:</strong> ${b.detail}`),
            interpretation: topBlocker.detail,
            action: topBlocker.fix
        };
    }

    function generateQuickWins(leads, customers) {
        const wins = [];

        // Quick win 1: Hot leads not yet contacted
        const hotLeads = leads.filter(l => {
            const age = Math.floor((new Date() - new Date(l.lead_create_time)) / (1000 * 60 * 60 * 24));
            return age <= 7 && l.converted_status !== 'Converted' && l.converted_status !== 'Lost';
        });
        if (hotLeads.length > 0) {
            wins.push({
                action: `Contact ${Math.min(hotLeads.length, 20)} fresh leads`,
                effort: 'Low',
                impact: `Potential ${Math.round(hotLeads.length * 0.3)} new customers`,
                timeframe: 'This week'
            });
        }

        // Quick win 2: Reactivation targets
        const reactivate = customers.filter(c =>
            c.days_since_last > 60 && c.days_since_last < 120 && c.total_spend_12m > 200
        );
        if (reactivate.length > 0) {
            wins.push({
                action: `Win-back ${reactivate.length} lapsed VIPs`,
                effort: 'Low',
                impact: `Protect $${Math.round(reactivate.reduce((s,c) => s + c.total_spend_12m, 0) * 0.4).toLocaleString()} revenue`,
                timeframe: 'Next 2 weeks'
            });
        }

        // Quick win 3: Cross-sell ready
        const crossSell = customers.filter(c => c.had_grooming && !c.had_boarding && c.days_since_last <= 60);
        if (crossSell.length >= 10) {
            wins.push({
                action: `Cross-sell boarding to ${crossSell.length} grooming clients`,
                effort: 'Medium',
                impact: 'Add $150+ per customer',
                timeframe: 'This month'
            });
        }

        if (wins.length === 0) {
            return {
                answer: "No obvious quick wins identified. Your operational efficiency appears optimized.",
                evidence: ["Lead pipeline is actively managed", "Customer base is well-serviced"],
                interpretation: "Consider strategic growth initiatives rather than tactical quick wins."
            };
        }

        return {
            answer: `Found <span class="text-green-400 font-semibold">${wins.length} quick wins</span> you can execute this week with minimal effort.`,
            evidence: wins.map(w => `<strong>${w.action}</strong> ‚Äî ${w.impact} (${w.effort} effort)`),
            interpretation: `Start with: ${wins[0].action}. This has ${wins[0].effort.toLowerCase()} effort and can be done ${wins[0].timeframe.toLowerCase()}.`,
            action: wins[0].action
        };
    }

    function generateLocationComparison(leads, customers) {
        // Build location stats
        const locationStats = {};

        leads.forEach(l => {
            const loc = l.business_location || 'Unknown';
            if (!locationStats[loc]) locationStats[loc] = { leads: 0, converted: 0, customers: 0, revenue: 0 };
            locationStats[loc].leads++;
            if (l.converted_status === 'Converted') locationStats[loc].converted++;
        });

        customers.forEach(c => {
            const loc = c.location || 'Unknown';
            if (!locationStats[loc]) locationStats[loc] = { leads: 0, converted: 0, customers: 0, revenue: 0 };
            locationStats[loc].customers++;
            locationStats[loc].revenue += c.total_spend_12m || 0;
        });

        const locations = Object.entries(locationStats)
            .filter(([_, data]) => data.leads >= 5)
            .map(([name, data]) => ({
                name,
                ...data,
                convRate: data.leads > 0 ? (data.converted / data.leads * 100).toFixed(1) : 0,
                avgValue: data.customers > 0 ? Math.round(data.revenue / data.customers) : 0
            }))
            .sort((a, b) => parseFloat(b.convRate) - parseFloat(a.convRate));

        if (locations.length < 2) {
            return {
                answer: "Not enough location data for comparison. Need at least 2 locations with sufficient lead volume.",
                evidence: [],
                interpretation: "Upload more location-specific data for comparative analysis."
            };
        }

        const best = locations[0];
        const worst = locations[locations.length - 1];
        const gap = (parseFloat(best.convRate) - parseFloat(worst.convRate)).toFixed(1);

        return {
            answer: `<span class="text-green-400 font-semibold">${best.name}</span> leads at ${best.convRate}% conversion. <span class="text-amber-400 font-semibold">${worst.name}</span> trails at ${worst.convRate}%. That's a ${gap}pp gap.`,
            evidence: [
                `<strong>Top:</strong> ${best.name} ‚Äî ${best.leads} leads, ${best.convRate}% conv, $${best.avgValue} avg value`,
                `<strong>Bottom:</strong> ${worst.name} ‚Äî ${worst.leads} leads, ${worst.convRate}% conv, $${worst.avgValue} avg value`,
                `${locations.length} total locations analyzed`
            ],
            interpretation: parseFloat(gap) > 15
                ? `Significant ${gap}pp variance suggests operational inconsistency. Study ${best.name}'s practices for replication.`
                : `${gap}pp variance is within acceptable range. Focus on scaling best practices uniformly.`,
            action: parseFloat(gap) > 15
                ? `Document ${best.name}'s playbook and train ${worst.name} team on key differences.`
                : null
        };
    }

    function generateSectionInsight(section) {
        const leads = getFilteredLeads();
        const customers = getFilteredCustomers();
        const responseArea = document.getElementById('copilotResponseArea');

        // Show typing
        responseArea.innerHTML = `
            <div class="flex items-start gap-3 mb-4">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                </div>
                <div class="flex-1">
                    <div class="text-sm text-slate-400 mb-2">Analyzing section...</div>
                    <div class="copilot-typing">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            </div>
        `;

        setTimeout(() => {
            let response = {};

            switch(section) {
                case 'scorecard':
                    response = generateExecutiveSummary(leads, customers);
                    break;
                case 'drivers':
                    response = generateDriversInsight(leads, customers);
                    break;
                case 'locations':
                    response = generateLocationComparison(leads, customers);
                    break;
                case 'verdict':
                    response = generateVerdictExplanation(leads, customers);
                    break;
                case 'gaps':
                    response = generateGapsExplanation(leads, customers);
                    break;
                case 'wow':
                    response = generateWoWExplanation(leads, customers);
                    break;
                case 'target':
                    response = generateTargetExplanation(leads, customers);
                    break;
                case 'portfolio':
                    response = generatePortfolioExplanation(leads, customers);
                    break;
                default:
                    response = generateExecutiveSummary(leads, customers);
            }

            renderCopilotResponse(response);
        }, 600);
    }

    function generateGapsExplanation(leads, customers) {
        const locationStats = computeLocationStats(leads, customers);
        const channelByLoc = {};
        leads.forEach(l => {
            const ch = normalizeChannel(l.channel);
            const loc = l.company_name || 'Unknown';
            const key = `${loc}|${ch}`;
            if (!channelByLoc[key]) channelByLoc[key] = { loc, ch, leads: 0, converted: 0 };
            channelByLoc[key].leads++;
            if (l.converted_status === 'Converted') channelByLoc[key].converted++;
        });

        const gaps = [];
        Object.values(channelByLoc).forEach(stat => {
            if (stat.leads < 15) return;
            const rate = stat.converted / stat.leads * 100;
            const sameChannelOther = Object.values(channelByLoc)
                .filter(s => s.ch === stat.ch && s.loc !== stat.loc && s.leads >= 10)
                .map(s => s.converted / s.leads * 100);
            if (sameChannelOther.length > 0) {
                const benchmark = Math.max(...sameChannelOther);
                if (benchmark - rate > 10) {
                    const shortLoc = stat.loc.replace('K9 Resorts Luxury Pet Hotel ', '').replace('K9 Resorts - ', '');
                    gaps.push(`<strong>${shortLoc} ${stat.ch}</strong>: ${rate.toFixed(0)}% vs ${benchmark.toFixed(0)}% benchmark (${(benchmark - rate).toFixed(0)}pp gap)`);
                }
            }
        });

        return {
            answer: gaps.length > 0
                ? `Found ${gaps.length} performance gap(s) where you're leaving money on the table.`
                : "No significant performance gaps detected. Operations are relatively consistent.",
            evidence: gaps.length > 0 ? gaps : ["All channels performing within expected range across locations"],
            interpretation: gaps.length > 0
                ? "Focus on the largest gaps first. Investigate process differences between high and low performers."
                : "Maintain current operations. Look for growth opportunities instead of gap-closing."
        };
    }

    function generateWoWExplanation(leads, customers) {
        const now = new Date();
        const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        const twoWeeksAgo = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);

        const thisWeek = leads.filter(l => new Date(l.lead_create_time) >= oneWeekAgo);
        const lastWeek = leads.filter(l => new Date(l.lead_create_time) >= twoWeeksAgo && new Date(l.lead_create_time) < oneWeekAgo);

        const thisWeekConv = thisWeek.filter(l => l.converted_status === 'Converted').length;
        const lastWeekConv = lastWeek.filter(l => l.converted_status === 'Converted').length;

        const evidence = [];
        if (thisWeek.length > lastWeek.length * 1.1) {
            evidence.push(`Lead volume <strong>up ${Math.round((thisWeek.length / lastWeek.length - 1) * 100)}%</strong> vs last week`);
        } else if (thisWeek.length < lastWeek.length * 0.9) {
            evidence.push(`Lead volume <strong>down ${Math.round((1 - thisWeek.length / lastWeek.length) * 100)}%</strong> vs last week`);
        } else {
            evidence.push("Lead volume <strong>stable</strong> week-over-week");
        }

        if (thisWeekConv > lastWeekConv) {
            evidence.push(`Conversions <strong>up</strong>: ${thisWeekConv} this week vs ${lastWeekConv} last week`);
        } else if (thisWeekConv < lastWeekConv) {
            evidence.push(`Conversions <strong>down</strong>: ${thisWeekConv} this week vs ${lastWeekConv} last week`);
        }

        return {
            answer: `Week-over-week comparison: ${thisWeek.length} leads this week vs ${lastWeek.length} last week.`,
            evidence: evidence,
            interpretation: thisWeek.length >= lastWeek.length
                ? "Momentum is positive or stable. Continue current initiatives."
                : "Slight decline detected. Monitor closely and check for seasonal factors."
        };
    }

    function generateTargetExplanation(leads, customers) {
        const convRate = leads.length > 0 ? leads.filter(l => l.converted_status === 'Converted').length / leads.length * 100 : 0;
        const target = 25;
        const gap = target - convRate;

        const evidence = [];
        evidence.push(`Current conversion rate: <strong>${convRate.toFixed(1)}%</strong>`);
        evidence.push(`Target: <strong>${target}%</strong>`);
        evidence.push(gap > 0 ? `Gap to target: <strong>${gap.toFixed(1)}pp</strong>` : `<strong>Exceeding target</strong> by ${Math.abs(gap).toFixed(1)}pp`);

        return {
            answer: gap > 0
                ? `You're ${gap.toFixed(0)}pp below target. Here's what that means.`
                : `You're meeting or exceeding your conversion target!`,
            evidence: evidence,
            interpretation: gap > 5
                ? "Focus on quick wins: faster response times and high-converting channels."
                : gap > 0
                    ? "Close to target. Fine-tune operations for the final push."
                    : "Excellent performance. Consider raising targets or expanding volume."
        };
    }

    function generatePortfolioExplanation(leads, customers) {
        const locationStats = computeLocationStats(leads, customers);
        const evidence = [];

        locationStats.sort((a, b) => b.convRate - a.convRate);

        if (locationStats.length >= 2) {
            const top = locationStats[0];
            const bottom = locationStats[locationStats.length - 1];
            evidence.push(`Top performer: <strong>${top.shortName}</strong> at ${top.convRate.toFixed(0)}% conversion`);
            evidence.push(`Needs attention: <strong>${bottom.shortName}</strong> at ${bottom.convRate.toFixed(0)}% conversion`);
            evidence.push(`Performance spread: ${(top.convRate - bottom.convRate).toFixed(0)}pp between best and worst`);
        }

        return {
            answer: `Portfolio view shows ${locationStats.length} locations with varying performance levels.`,
            evidence: evidence.length > 0 ? evidence : ["Load more data to see location insights"],
            interpretation: locationStats.length >= 2
                ? "Transfer best practices from top performers to underperforming locations."
                : "Add more location data for comparative analysis."
        };
    }

    function generateDriversInsight(leads, customers) {
        const drivers = [];

        // Analyze what's working
        const leadsBySource = {};
        leads.forEach(l => {
            const src = l.lead_source || 'Unknown';
            if (!leadsBySource[src]) leadsBySource[src] = { total: 0, converted: 0 };
            leadsBySource[src].total++;
            if (l.converted_status === 'Converted') leadsBySource[src].converted++;
        });

        const topChannel = Object.entries(leadsBySource)
            .filter(([_, d]) => d.total >= 10)
            .sort((a, b) => (b[1].converted/b[1].total) - (a[1].converted/a[1].total))[0];

        if (topChannel) {
            const rate = (topChannel[1].converted / topChannel[1].total * 100).toFixed(0);
            drivers.push(`<strong>${topChannel[0]}</strong> is your top-converting channel at ${rate}%`);
        }

        // Check recent momentum
        const recent30 = leads.filter(l => {
            const age = Math.floor((new Date() - new Date(l.lead_create_time)) / (1000 * 60 * 60 * 24));
            return age <= 30;
        });

        if (recent30.length > leads.length * 0.4) {
            drivers.push(`Lead volume is <strong>accelerating</strong> ‚Äî ${recent30.length} leads in last 30 days`);
        }

        return {
            answer: drivers.length > 0
                ? `Key growth drivers: ${drivers.length} positive signals detected.`
                : "Analyzing growth drivers... Need more data for definitive conclusions.",
            evidence: drivers.length > 0 ? drivers : ["Insufficient data for driver analysis"],
            interpretation: topChannel
                ? `Double down on ${topChannel[0]} while it's performing. Consider increasing budget allocation.`
                : "Continue building data volume for pattern detection."
        };
    }

    function generateVerdictExplanation(leads, customers) {
        const totalLeads = leads.length;
        const converted = leads.filter(l => l.converted_status === 'Converted').length;
        const paying = customers.filter(c => c.total_spend_12m > 0).length;
        const active = customers.filter(c => c.days_since_last <= 90).length;

        const leadToCustomer = totalLeads > 0 ? converted / totalLeads * 100 : 0;
        const customerToPaid = converted > 0 ? paying / converted * 100 : 0;
        const activeRate = customers.length > 0 ? active / customers.length * 100 : 0;

        // Build verdict logic explanation
        const factors = [];

        if (leadToCustomer >= 35) {
            factors.push({ positive: true, text: `Lead‚ÜíCustomer rate (${leadToCustomer.toFixed(0)}%) exceeds 35% benchmark` });
        } else if (leadToCustomer < 20) {
            factors.push({ positive: false, text: `Lead‚ÜíCustomer rate (${leadToCustomer.toFixed(0)}%) below 20% threshold` });
        } else {
            factors.push({ positive: null, text: `Lead‚ÜíCustomer rate (${leadToCustomer.toFixed(0)}%) in normal range` });
        }

        if (customerToPaid >= 75) {
            factors.push({ positive: true, text: `Customer‚ÜíPaid rate (${customerToPaid.toFixed(0)}%) shows strong monetization` });
        } else if (customerToPaid < 50) {
            factors.push({ positive: false, text: `Customer‚ÜíPaid rate (${customerToPaid.toFixed(0)}%) indicates monetization gap` });
        }

        if (activeRate >= 60) {
            factors.push({ positive: true, text: `90D active rate (${activeRate.toFixed(0)}%) shows healthy retention` });
        } else if (activeRate < 40) {
            factors.push({ positive: false, text: `90D active rate (${activeRate.toFixed(0)}%) indicates retention risk` });
        }

        const positives = factors.filter(f => f.positive === true).length;
        const negatives = factors.filter(f => f.positive === false).length;

        let verdictExplanation = "";
        if (positives >= 2 && negatives === 0) {
            verdictExplanation = "Multiple strong signals with no critical issues. Growth trajectory is healthy.";
        } else if (negatives >= 2) {
            verdictExplanation = "Multiple concerning signals. Prioritize fixing fundamentals before scaling.";
        } else {
            verdictExplanation = "Mixed signals. Focus on addressing the weakest metric first.";
        }

        return {
            answer: `The verdict is based on <strong>${factors.length} key factors</strong> from your three-layer funnel model.`,
            evidence: factors.map(f => {
                const icon = f.positive === true ? '‚úÖ' : f.positive === false ? '‚ö†Ô∏è' : '‚ûñ';
                return `${icon} ${f.text}`;
            }),
            interpretation: verdictExplanation
        };
    }

    function renderCopilotResponse(response) {
        const responseArea = document.getElementById('copilotResponseArea');

        let html = `
            <div class="copilot-response rounded-xl p-4 mb-4">
                <div class="text-sm text-white leading-relaxed mb-3">
                    ${response.answer}
                </div>
        `;

        if (response.evidence && response.evidence.length > 0) {
            html += `
                <div class="text-xs text-slate-400 uppercase tracking-wider mb-2 mt-4">Evidence</div>
                <ul class="space-y-1 text-sm text-slate-300">
                    ${response.evidence.map(e => `<li class="flex items-start gap-2"><span class="text-purple-400">‚Ä¢</span><span>${e}</span></li>`).join('')}
                </ul>
            `;
        }

        if (response.interpretation) {
            html += `
                <div class="text-xs text-slate-400 uppercase tracking-wider mb-2 mt-4">Interpretation</div>
                <div class="text-sm text-slate-300">${response.interpretation}</div>
            `;
        }

        if (response.action) {
            html += `
                <div class="mt-4 p-3 bg-purple-500/10 rounded-lg border border-purple-500/20">
                    <div class="text-xs text-purple-400 uppercase tracking-wider mb-1">Recommended Action</div>
                    <div class="text-sm text-white">${response.action}</div>
                </div>
            `;
        }

        html += `</div>`;

        responseArea.innerHTML = html;
    }

    function sendCopilotQuery() {
        const input = document.getElementById('copilotInput');
        const query = input.value.trim();

        if (!query) return;

        input.value = '';

        // For now, route custom queries to the most relevant quick action
        const queryLower = query.toLowerCase();

        if (queryLower.includes('summary') || queryLower.includes('overview') || queryLower.includes('how am i doing')) {
            askCopilot('summary');
        } else if (queryLower.includes('block') || queryLower.includes('problem') || queryLower.includes('issue') || queryLower.includes('wrong')) {
            askCopilot('blockers');
        } else if (queryLower.includes('opportunit') || queryLower.includes('quick') || queryLower.includes('win') || queryLower.includes('improve')) {
            askCopilot('opportunities');
        } else if (queryLower.includes('location') || queryLower.includes('compare') || queryLower.includes('best') || queryLower.includes('worst')) {
            askCopilot('comparison');
        } else {
            // Default to summary for unrecognized queries
            askCopilot('summary');
        }
    }

    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
        showView('overview');
    });
    </script>
</body>
</html>
